<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æ±Ÿå½±ä¸æ²‰æµ®</title>
  
  <subtitle>You can, just if you want!</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.zjee.ml/"/>
  <updated>2019-12-29T09:31:19.000Z</updated>
  <id>http://blog.zjee.ml/</id>
  
  <author>
    <name>jackcharles</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HashMapæºç å®Œå…¨è§£è¯»</title>
    <link href="http://blog.zjee.ml/2019/12/29/hashmap-source-learning/"/>
    <id>http://blog.zjee.ml/2019/12/29/hashmap-source-learning/</id>
    <published>2019-12-29T09:31:19.000Z</published>
    <updated>2019-12-29T09:31:19.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€HashMapåŸºç¡€"><a href="#ä¸€ã€HashMapåŸºç¡€" class="headerlink" title="ä¸€ã€HashMapåŸºç¡€"></a>ä¸€ã€HashMapåŸºç¡€</h1><h3 id="1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼"><a href="#1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼" class="headerlink" title="1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼"></a>1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼</h3><table><thead><tr><th style="text-align:center">åç§°</th><th style="text-align:center">ç±»å‹</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center">DEFAULT_INITIAL_CAPACITY</td><td style="text-align:center">int</td><td style="text-align:center">$2^{4}$</td><td style="text-align:center">é»˜è®¤åˆå§‹åŒ–å®¹é‡ (è¿™é‡Œçš„å®¹é‡æŒ‡tableçš„é•¿åº¦è€Œä¸æ˜¯sizeï¼Œä¸‹åŒ)</td></tr><tr><td style="text-align:center">MAXIMUM_CAPACITY</td><td style="text-align:center">int</td><td style="text-align:center">$2^{30}$</td><td style="text-align:center">æœ€å¤§å®¹é‡ï¼ˆtableæœ€å¤§é•¿åº¦ï¼‰</td></tr><tr><td style="text-align:center">DEFAULT_LOAD_FACTOR</td><td style="text-align:center">float</td><td style="text-align:center">0.75f</td><td style="text-align:center">é»˜è®¤åŠ è½½å› å­</td></tr><tr><td style="text-align:center">TREEIFY_THRESHOLD</td><td style="text-align:center">int</td><td style="text-align:center">8</td><td style="text-align:center">æ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦&gt;=è¯¥å€¼å°±è€ƒè™‘æ ‘å½¢åŒ–</td></tr><tr><td style="text-align:center">UNTREEIFY_THRESHOLD</td><td style="text-align:center">int</td><td style="text-align:center">6</td><td style="text-align:center">é“¾è¡¨åŒ–é˜ˆå€¼ï¼Œå¦‚æœæ ‘çš„èŠ‚ç‚¹æ•°&lt;=è¯¥å€¼å°±è€ƒè™‘è½¬æ¢ä¸ºé“¾è¡¨</td></tr><tr><td style="text-align:center">MIN_TREEIFY_CAPACITY</td><td style="text-align:center">int</td><td style="text-align:center">64</td><td style="text-align:center">æ ‘å½¢åŒ–éœ€è¦çš„æœ€å°å®¹é‡ï¼Œåªæœ‰tableçš„é•¿åº¦&gt;=è¯¥å€¼æ‰ä¼šæ ‘å½¢åŒ–</td></tr><tr><td style="text-align:center">table</td><td style="text-align:center">Node[]</td><td style="text-align:center">-</td><td style="text-align:center">hashæ¡¶ï¼Œæ˜ å°„ä¸åŒçš„hashåœ°å€</td></tr><tr><td style="text-align:center">entrySet</td><td style="text-align:center">Set&lt;Map.Entry&gt;</td><td style="text-align:center">-</td><td style="text-align:center">key-value setç¼“å­˜</td></tr><tr><td style="text-align:center">size</td><td style="text-align:center">int</td><td style="text-align:center">-</td><td style="text-align:center">mapåŒ…å«çš„k-vèŠ‚ç‚¹ä¸ªæ•°ï¼ˆä¸æ˜¯tableé•¿åº¦ï¼‰</td></tr><tr><td style="text-align:center">modCount</td><td style="text-align:center">int</td><td style="text-align:center">-</td><td style="text-align:center">Mapç»“æ„ä¿®æ”¹æ¬¡æ•°ï¼ˆç”¨äºå¿«é€Ÿå¤±è´¥ï¼‰</td></tr><tr><td style="text-align:center">threshold</td><td style="text-align:center">int</td><td style="text-align:center">-</td><td style="text-align:center">åˆå§‹åŒ–å®¹é‡æˆ–capacity*loadFactor</td></tr><tr><td style="text-align:center">loadFactor</td><td style="text-align:center">float</td><td style="text-align:center">-</td><td style="text-align:center">åŠ è½½å› å­,å†³å®šä»€ä¹ˆæ—¶å€™è¯¥æ‰©å®¹</td></tr><tr><td style="text-align:center">keySet (from AbstrctMap)</td><td style="text-align:center">Set</td><td style="text-align:center">-</td><td style="text-align:center">key set ç¼“å­˜</td></tr><tr><td style="text-align:center">values(from AbstrctMap)</td><td style="text-align:center">Collection</td><td style="text-align:center">-</td><td style="text-align:center">values ç¼“å­˜</td></tr></tbody></table><h3 id="2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†"><a href="#2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†" class="headerlink" title="2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†"></a>2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†</h3><ol><li>hashå€¼çš„è®¡ç®—ï¼šHashMapä¸­çš„hashä¸æ˜¯ç›´æ¥ä½¿ç”¨<code>Object.hashCode()</code>ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨è¿™åŸºç¡€ä¸Šå°†hashCodeçš„é«˜16ä½ä¸ä½16ä½è¿›è¡Œäº†ä¸€æ¬¡å¼‚æˆ–ã€‚è¿™ä¹ˆåšçš„åŸå› ä¸hashåœ°å€è®¡ç®—æ–¹å¼æœ‰å…³ï¼ŒHashMapçš„hashåœ°å€è®¡ç®—æ–¹å¼ä¸º<code>hash&amp;(table.length-1)</code>ï¼Œä»äºŒè¿›åˆ¶çš„è§’åº¦æ¥çœ‹ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰hashCodeçš„ä½å‡ ä½æœ‰æ•ˆå‚ä¸äº†åœ°å€è®¡ç®—ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœå¼€å‘äººå‘˜çš„hashCodeå®ç°ä¸å¤Ÿä¼˜è‰¯ï¼Œå°±ä¼šå­˜åœ¨æ•°æ®åˆ†å¸ƒä¸å‡çš„æƒ…å†µï¼Œè€Œé«˜16ä½ä¸ä½16ä½çš„å¼‚æˆ–å°†é«˜16ä½ç‰¹å¾å¸¦åˆ°ä½16ä½ï¼Œå¯ä»¥æœ€å¤§åŒ–ä¿è¯hashCodeåœ¨ä½ä½çš„å‡åŒ€åˆ†å¸ƒã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> h;</span><br><span class="line"><span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);<span class="comment">//nullçš„hashä¸º0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="2"><li><p>åˆ¤æ–­ä¼ å…¥çš„keyæ˜¯å¦å¯æ¯”è¾ƒå¤§å°ã€‚</p><p><strong>ğŸ”¶</strong> åœ¨çº¢é»‘æ ‘æ“ä½œä¸­ï¼Œå½“keyçš„hashå‘ç”Ÿç¢°æ’æ—¶ï¼Œå°±è°ƒç”¨è¿™äº›æ–¹æ³•å°è¯•æ¯”è¾ƒkeyçš„å¤§å°ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ˜¯ä¸æ˜¯å¯æ¯”è¾ƒï¼Œè¿”å›nullè¡¨ç¤ºä¸å¯æ¯”è¾ƒï¼Œå¦åˆ™è¿”å›x.getClass()</span></span><br><span class="line"><span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line">  <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">    Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line">    <span class="comment">// Stringå¯æ¯”è¾ƒï¼Œç›´æ¥è¿”å›ï¼ˆStringç”¨çš„æœ€å¤šï¼Œæ‰€ä»¥è¿™é‡Œå•ç‹¬å¤„ç†ï¼ŒåŠ å¿«ç¨‹åºé€Ÿåº¦ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((c = x.getClass()) == String.class) </span><br><span class="line">      <span class="keyword">return</span> c;</span><br><span class="line">    <span class="comment">//è·å–è¯¥ç±»çš„æ¥å£ï¼Œå¦‚æœæ¥å£ä¸­æœ‰Comparable.class,å°±è¡¨ç¤ºxæ˜¯å¯æ¯”è¾ƒçš„ï¼Œç›´æ¥è¿”å›è¯¥class</span></span><br><span class="line">    <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;</span><br><span class="line">            ((p = (ParameterizedType)t).getRawType() ==</span><br><span class="line">             Comparable.class) &amp;&amp;</span><br><span class="line">            (as = p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c) <span class="comment">// type arg is c</span></span><br><span class="line">          <span class="keyword">return</span> c;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//ä¸å¯æ¯”è¾ƒçš„å¯¹è±¡ç›´æ¥è¿”å›null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡k, x</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;) <span class="comment">// for cast to Comparable</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareComparables</span><span class="params">(Class&lt;?&gt; kc, Object k, Object x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (x == <span class="keyword">null</span> || x.getClass() != kc ? <span class="number">0</span> : <span class="comment">//æ³¨æ„å¯¹nullå’Œclassä¸åŒæ—¶çš„å¤„ç†</span></span><br><span class="line">          ((Comparable)k).compareTo(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p></li></ol><p></p><ol start="3"><li><p>æ ¹æ®ç»™å®šçš„å€¼é‡æ–°è®¡ç®—tableSizeï¼šè¿™ä¸€æ­¥æ˜¯æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„capacityåˆå§‹åŒ–ä¸ºç¦»capæœ€è¿‘çš„$2^{n}$çš„ä¸€ä¸ªå€¼ï¼Œä¿è¯capacityæ˜¯$2^{n}$çš„å½¢å¼ä¸»è¦ä¸ºäº†æ–¹ä¾¿hashåœ°å€è®¡ç®—å’Œæ‰©å®¹ã€‚</p><p><strong>ğŸ”¶</strong> è¯•æƒ³ä¸€ä¸‹å‡å¦‚åˆå§‹åŒ–å®¹é‡æ˜¯15ï¼Œæ ¹æ®hashåœ°å€çš„è®¡ç®—å…¬å¼<code>hash&amp;(n-1)</code>ï¼Œn-1ä¹Ÿå°±æ˜¯14ï¼Œå¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯1110ï¼Œåˆ™<code>hash&amp;1110</code>ç»“æœå¿…å®šæ˜¯<code>xxx0</code>å½¢å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç®—å‡ºçš„åœ°å€æœ€åä¸€ä½æ°¸è¿œæ˜¯0ï¼Œè½¬æ¢ä¸º10è¿›åˆ¶å°±å‘ç°å¥‡æ•°ä½çš„æ¡¶æ°¸è¿œåˆ†é…ä¸åˆ°èŠ‚ç‚¹ï¼Œè¿™ä¼šå¯¼è‡´HashMapä¸¥é‡åˆ†å¸ƒä¸å‡ã€‚</p><p><strong>ğŸ”¶</strong>  å¦ä¸€æ–¹é¢ï¼šæ‰©å®¹æ—¶ï¼Œæ–°å®¹é‡æ˜¯åŸå®¹é‡çš„2å€ï¼Œå¯¹äº<code>hash&amp;(n-1)</code>æ¥è¯´ï¼Œå°±ç›¸å½“äºn-1çš„äºŒè¿›åˆ¶å‘å·¦æ‰©å±•äº†1ä¸ª1ï¼Œæ¯”å¦‚(16-1)çš„äºŒè¿›åˆ¶æ˜¯<code>1111</code>ï¼Œæ‰©å®¹å(32-1)çš„äºŒè¿›åˆ¶<code>11111</code>ï¼Œä¸åŸhashåœ°å€ç›¸æ¯”è¾ƒåªæœ‰æœ€é«˜ä½çš„1å¸¦æ¥äº†å·®å¼‚ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œè€Œhashä¸­ä¸ä¹‹å¯¹åº”çš„ä½åªæœ‰1å’Œ0ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥åŸé“¾è¡¨/çº¢é»‘æ ‘æœ€å¤šæ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨/çº¢é»‘æ ‘å°±å¯ä»¥äº†ï¼Œä¸”æ‹†åˆ†åçš„ä¸¤ä¸ªç»“æ„ï¼Œä¸€ä¸ªç•™åœ¨åŸåœ°(hashå¯¹åº”ä½ä¸º0)ï¼Œä¸€ä¸ªå‡åˆ°é«˜ä½ç½®(hashå¯¹åº”ä½ä¸º1)ï¼Œä¸”è¿™ä¸ªé«˜ä½æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯<code>hash&amp;(2n-1)</code>æˆ–è€…<code>hash&amp;(n-1)+n</code>ã€‚</p><img src="/2019/12/29/hashmap-source-learning/hash-addr.png" title="HashMapæ‰©å®¹"><p><strong>ğŸ”¶</strong>  è€Œå½“å®¹é‡è®¾ç½®ä¸º15æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°14ä¸29çš„äºŒè¿›åˆ¶å·®å¼‚å¾ˆå¤§ï¼Œè¿™å°±ç»™rehashçš„è¿‡ç¨‹å¸¦æ¥å¾ˆå¤§éº»çƒ¦å’Œä¸å¿…è¦çš„å¼€é”€ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¼ å…¥çš„capå˜ä¸ºç›¸è¿‘çš„2çš„xæ¬¡æ–¹çš„å½¢å¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">1</span>; <span class="comment">//å°†æœ€é«˜2ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">2</span>; <span class="comment">//å°†æœ€é«˜4ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">4</span>; <span class="comment">//å°†æœ€é«˜8ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">8</span>; <span class="comment">//å°†æœ€é«˜16ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">16</span>; <span class="comment">//32ä½å…¨å˜ä¸º1(2^n-1)</span></span><br><span class="line">  <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;<span class="comment">//n+1å°±æ˜¯2^n</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p></li></ol><p></p><ol start="4"><li>HashMapæ„é€ æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ„é€ æ–¹æ³•ï¼šæŒ‡å®šåˆå§‹å®¹é‡å’ŒåŠ è½½å› å­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> + initialCapacity);</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">    initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">  <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> + loadFactor);</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">  <span class="comment">//æ³¨æ„ï¼šç”¨thresholdä¿å­˜åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">  <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•ï¼šæŒ‡å®šåˆå§‹å®¹é‡ï¼Œä½¿ç”¨é»˜è®¤åŠ è½½å› å­0.75</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•ï¼šæ— å‚æ„é€ æ–¹æ³•ï¼Œå…¨éƒ¨ä½¿ç”¨é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•ï¼šä»ä¸€ä¸ªMapæ„é€ å¦ä¸€ä¸ªMapï¼Œé‡‡ç”¨é»˜è®¤åŠ è½½å› å­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">  putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="5"><li>æ’å…¥å¦å¤–ä¸€ä¸ªMapçš„æ‰€æœ‰æ•°æ®ï¼ˆputMapEntriesï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰¹é‡putå…ƒç´ ï¼Œ å½“ä¸”ä»…å½“æ„é€ mapå¹¶æ‰¹é‡putæ—¶evictä¸ºfalse</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">putMapEntries</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m, <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s = m.size();<span class="comment">//ç°æœ‰Mapå…ƒç´ æ•°é‡</span></span><br><span class="line">  <span class="keyword">if</span> (s &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœtableè¿˜æœªåˆå§‹åŒ–</span></span><br><span class="line">      <span class="keyword">float</span> ft = ((<span class="keyword">float</span>)s / loadFactor) + <span class="number">1.0F</span>; <span class="comment">//è®¡ç®—éœ€è¦çš„å®¹é‡</span></span><br><span class="line">      <span class="keyword">int</span> t = ((ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">               (<span class="keyword">int</span>)ft : MAXIMUM_CAPACITY);</span><br><span class="line">      <span class="keyword">if</span> (t &gt; threshold) <span class="comment">//å¦‚æœéœ€è¦çš„å®¹é‡å¤§äºä¹‹å‰è®¾ç½®çš„åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">        threshold = tableSizeFor(t);<span class="comment">//å°±é‡æ–°ç¡®å®šä¸€ä¸ªæ¯”è¾ƒå¤§çš„åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœtableå·²ç»åˆå§‹åŒ–äº†ï¼Œä¸”è¦åŠ å…¥çš„å…ƒç´ æ•°é‡å¤§äºthresholdå°±ç›´æ¥æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s &gt; threshold) </span><br><span class="line">      resize();</span><br><span class="line">    <span class="comment">//æ”¾å…¥æ–°å…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;? extends K, ? extends V&gt; e : m.entrySet()) &#123;</span><br><span class="line">      K key = e.getKey();</span><br><span class="line">      V value = e.getValue();</span><br><span class="line">      putVal(hash(key), key, value, <span class="keyword">false</span>, evict);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="6"><li>å…¬å…±å¸¸ç”¨æ–¹æ³•ï¼š<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Mapæ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®keyè·å–å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; e;</span><br><span class="line">  <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªkeyï¼Œä¸getæ–¹æ³•å®ç°ä¸€è‡´</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getNode(hash(key), key) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°åŠ å…¥ä¸€ä¸ªkay-valueå¯¹ï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨å°±è¿”å›ä¹‹å‰çš„valueï¼Œå¦åˆ™è¿”å›null</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠ å…¥å¦å¤–ä¸€ä¸ªMapçš„æ‰€æœ‰å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    putMapEntries(m, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤keyå…³è”çš„å…ƒç´ ï¼Œè¿”å›åˆ é™¤çš„å…ƒç´ ï¼Œå¦‚æœkeyä¸å­˜åœ¨åˆ™è¿”å›null</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>)) == <span class="keyword">null</span> ?</span><br><span class="line">        <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹ï¼ˆæ³¨æ„ï¼štable.lengthæ²¡å˜ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//å…¨éƒ¨ä¸tableè§£æŒ‚å°±è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i)</span><br><span class="line">            tab[i] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç»™å®šçš„valueï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; V v;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//éå†table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨/æ ‘ï¼ˆè¿™é‡Œå¯ä»¥çœ‹å‡ºæ ‘ä¹Ÿæœ‰ä¸€æ¡ç±»ä¼¼é“¾è¡¨è®¿é—®çš„è·¯å¾„ï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((v = e.value) == value ||</span><br><span class="line">                    (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="7"><li>æ ¹æ®æŒ‡å®šçš„keyæŸ¥æ‰¾å¯¹åº”NodeèŠ‚ç‚¹ï¼Œæ‰¾ä¸åˆ°å¯¹åº”keyå°±è¿”å›<code>null</code>ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®ç»™å®šçš„keyè·å–èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">//å¦‚æœtableä¸ä¸ºç©ºä¸”å¯¹åº”hashåœ°å€çš„ç¬¬é¦–èŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹çš„hashå’Œkeyéƒ½ä¸æŸ¥è¯¢keyåŒ¹é…çš„è¯å°±ç›´æ¥è¿”å›é¦–èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">//å¦åˆ™æ£€æŸ¥é¦–èŠ‚ç‚¹ä¸‹é¢æ˜¯å¦è¿˜æœ‰èŠ‚ç‚¹ï¼Œæœ‰å…¶ä»–èŠ‚ç‚¹å°±ç»§ç»­æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹æ˜¯æ ‘çŠ¶èŠ‚ç‚¹ï¼Œå°±å»çº¢é»‘æ ‘ä¸­æŸ¥è¯¢</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">//å¦åˆ™å°±éå†é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ‰¾åˆ°æŸä¸ªkeyä¸ç»™å®škeyä¸€è‡´å°±è¿”å›è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="8"><li>æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œå¹¶è¿”å›æ—§èŠ‚ç‚¹çš„å€¼ï¼Œæ—§èŠ‚ç‚¹ä¸å­˜åœ¨è¿”å›<code>null</code>ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//onlyIfAbsentè¡¨ç¤ºæ˜¯å¦ä»…å½“keyä¸å­˜åœ¨æ—¶æ‰æ’å…¥ï¼Œevictä¸ºfalseè¡¨ç¤ºåœ¨åˆå§‹åŒ–(åˆ›å»º)æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">//tableä¸ºç©ºæˆ–é•¿åº¦ä¸º0æ—¶ï¼Œé‡æ–°æ‰©å®¹table</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//å¦‚æœæ’å…¥çš„keyå¯¹åº”çš„hashåœ°å€ä¸Šæ²¡æœ‰å€¼ï¼Œåˆ™ç›´æ¥åœ¨è¯¥ä½ç½®æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ’å…¥çš„keyå¯¹åº”çš„hashåœ°å€ä¸Šå·²ç»å­˜åœ¨å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹å°±æ˜¯keyå¯¹åº”èŠ‚ç‚¹ï¼Œå°±ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡eè®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼Œå¦‚æœé¦–èŠ‚ç‚¹æ˜¯æ ‘çŠ¶èŠ‚ç‚¹ï¼Œå°±å»çº¢é»‘æ ‘æ’å…¥ï¼ˆæ‰¾åˆ°ï¼‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶è®°å½•</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="comment">//å¦åˆ™éå†é“¾è¡¨</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//binCountè®°å½•é“¾è¡¨é•¿åº¦</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ•´ä¸ªé“¾è¡¨éƒ½æ²¡æ‰¾åˆ°keyï¼Œåˆ™åœ¨æœ«å°¾æ–°åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦è¾¾åˆ°æ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå°±å°†é“¾è¡¨è¿›è¡Œæ ‘å½¢åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœåœ¨é“¾è¡¨ä¸­æ‰¾åˆ°keyå°±è®°å½•ä¸‹æ¥</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ’å…¥çš„keyå·²ç»å­˜åœ¨å°±æŒ‰è¦æ±‚æ›¿æ¢å€¼ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ–°æ’å…¥èŠ‚ç‚¹eå°±æ˜¯nullï¼Œè·³è¿‡è¿™ä¸€æ­¥</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            <span class="comment">//æ›´æ–°èŠ‚ç‚¹å®Œæˆåä¸€äº›å…¶ä»–æ“ä½œï¼ŒHashMapè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="comment">//è¿”å›æ—§èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡Mapç»“æ„ä¿®æ”¹æ¬¡æ•°,ç”¨äºè¿­ä»£å™¨å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹åçš„ä¸€äº›é¢å¤–æ“ä½œï¼ŒHashMapè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="9"><li>ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ é™¤å…ƒç´ çš„å®ç°ï¼Œå¦‚æœmatchValueä¸ºtrueåˆ™è¿˜è¦åŒ¹é…value</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, index;</span><br><span class="line">    <span class="comment">//ä¸€é¡¿ç©ºå€¼æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt; node = <span class="keyword">null</span>, e; K k; V v;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è¦åˆ é™¤çš„ï¼Œç”¨ä¸´æ—¶å˜é‡nodeè®°å½•</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            node = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ä»æ ‘ä¸­æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´ node</span></span><br><span class="line">            <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//éå†é“¾è¡¨</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key ||</span><br><span class="line">                         (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        node = e;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p = e;<span class="comment">//pæ˜¯eçš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœnodeä¸ä¸ºç©ºä¸”valueæ£€æŸ¥ä¹Ÿç¬¦åˆæ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                             (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">            <span class="comment">//ä»æ ‘ä¸­åˆ é™¤node</span></span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">            <span class="comment">//nodeå°±æ˜¯é¦–èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                tab[index] = node.next;</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">//åˆ é™¤node</span></span><br><span class="line">                p.next = node.next;</span><br><span class="line">            ++modCount;<span class="comment">//è®°å½•æœ¬æ¬¡ä¿®æ”¹</span></span><br><span class="line">            --size;<span class="comment">//size-1</span></span><br><span class="line">            afterNodeRemoval(node);<span class="comment">//åˆ é™¤èŠ‚ç‚¹åçš„å…¶ä»–å·¥ä½œï¼ŒHashMapä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">            <span class="keyword">return</span> node;<span class="comment">//è¿”å›åˆ é™¤çš„èŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><h3 id="3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–"><a href="#3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–" class="headerlink" title="3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–"></a>3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–</h3><ol><li><p>HashMapæ‰©å®¹æ–¹æ³•</p><p>ğŸ”¶ HashMapæ‰©å®¹çš„æ¡ä»¶ï¼š1ã€åˆå§‹åŒ–ã€‚2ã€HashMapä¸­èŠ‚ç‚¹æ€»æ•°å¤§äºcapacity*loadfactorã€‚3ã€capacityå°äº<code>MIN_TREEIFY_CAPACITY</code>(64)ï¼Œä¸”å•é“¾è¡¨é•¿åº¦å¤§äºç­‰äº<code>TREEIFY_THRESHOLD</code>(8)ã€‚</p><p>ğŸ”¶ è¾¾åˆ°æ‰©å®¹æ¡ä»¶åå¹¶ä¸æ˜¯ä¸€å®šæ‰©å®¹æˆåŠŸï¼Œå¦‚æœå½“å‰å®¹é‡å¤§äºç­‰äº<code>MAXIMUM_CAPACITY</code>($2^{30}$)å°±ä¸å†æ‰©å®¹ï¼Œthresholdè®¾ç½®ä¸º<code>Integer.MAX_VALUE</code>ã€‚è¿™é‡Œä¸€å®šä¸ä¼šå‡ºç°æ‰©å®¹åçš„å®¹é‡å¤§äº<code>MAXIMUM_CAPACITY</code>çš„æƒ…å†µï¼Œå› ä¸ºcapacityéƒ½æ˜¯2çš„æ•´æ•°æ¬¡æ–¹å½¢å¼ï¼Œä¸€æ¬¡æ‰©å®¹åªæ‰©å¤§ä¸€å€ï¼Œå› æ­¤æ— é™æ‰©å®¹æ—¶ä¸€å®šä¼šå‘½ä¸­<code>MAXIMUM_CAPACITY</code>ï¼Œæ­¤åä¸å†æ‰©å®¹ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HashMapæ‰©å®¹æ“ä½œï¼Œå…ˆæ‰©å®¹å†é‡æ–°åˆ†å¸ƒï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæ—§tableé•¿åº¦å¤§äº0ï¼ˆéåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœæ—§tableé•¿åº¦è¾¾æœ€å¤§å€¼ï¼Œå°±ç›´æ¥è°ƒæ•´é˜ˆå€¼åˆ°æœ€å¤§å€¼</span></span><br><span class="line">        <span class="comment">//æ­¤åé˜ˆå€¼å¤±æ•ˆï¼Œä¸å†æ‰©å®¹ï¼Œå¹¶ç›´æ¥è¿”å›æ—§table</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ–°tableé•¿åº¦å°äºMAXIMUM_CAPACITYï¼Œé˜ˆå€¼x2</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">//oldCap*2åå¯èƒ½&gt;=MAXIMUM_CAPACITYï¼Œæ­¤æ—¶newThrèµ‹å€¼æ“ä½œè·³è¿‡ï¼Œå°±è¿˜æ˜¯0</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœåˆå§‹åŒ–å®¹é‡å¤§äº0ï¼Œæ–°å®¹é‡å°±æ˜¯è¿™ä¸ªå€¼ï¼ˆæ³¨æ„è¿™é‡Œæ²¡æœ‰è®¾ç½®newThr,newThrè¿˜æ˜¯0ï¼‰</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">//æ ¹æ®é»˜è®¤æƒ…å†µåˆå§‹åŒ–table</span></span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœéé»˜è®¤åˆå§‹åŒ–æ—¶ï¼Œæ–°å®¹é‡ç­‰äºMAXIMUM_CAPACITYæ—¶ï¼ŒnewThrä¸º0ï¼Œéœ€è¦é‡æ–°è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//rehashè¿‡ç¨‹ï¼Œé‡æ–°åˆ†å¸ƒå…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//éå†æ—§table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">//å¦‚æœjä½ç½®æœ‰å…ƒç´ å°±ç”¨ä¸´æ—¶å˜é‡eæ ‡è®°</span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//é‡Šæ”¾æ—§table[j]</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//å¦‚æœeåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆä¸æ„æˆé“¾è¡¨ã€æ ‘ï¼‰ï¼Œå°±ç›´æ¥é‡æ–°è®¡ç®—åœ°å€ï¼Œç„¶åæ”¾è¿‡å»</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">//å¦‚æœeæ˜¯çº¢é»‘æ ‘ï¼Œå°±æŒ‰çº¢é»‘æ ‘çš„æ–¹å¼rehash</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">//å¦‚æœeæ˜¯é“¾è¡¨ï¼Œå°±æ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªåœ¨åŸä½ç½®ä¸€ä¸ªåœ¨æ–°ä½ç½®</span></span><br><span class="line">                <span class="comment">//åªéœ€è¦æ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨çš„åŸå› ä¸å…¶åœ°å€è®¡ç®—æ–¹å¼æœ‰å…³:hash&amp;(n-1)</span></span><br><span class="line">                <span class="comment">//æ‰©å®¹2å€ï¼Œå¯¹äºn-1çš„äºŒè¿›åˆ¶æ¥è¯´å°±æ˜¯å·¦è¾¹å¤šäº†ä¸€ä¸ª1ï¼Œè¿™å¯¹äºåŸæ¥åœ¨è¯¥é“¾è¡¨çš„key</span></span><br><span class="line">                <span class="comment">//æ¥è¯´ï¼Œä¹Ÿåªéœ€è¦å…³æ³¨hashå¯¹åº”ä½ç½®æ˜¯0è¿˜æ˜¯1ï¼Œ0åˆ™ç•™åœ¨åŸåœ°ï¼Œ1åˆ™æ¬åˆ°æ–°ä½æ‰€</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve orderï¼ˆä¿ç•™ç›¸å¯¹é¡ºåºï¼‰</span></span><br><span class="line">                    <span class="comment">//ç•™åœ¨åŸåœ°çš„é“¾è¡¨å¤´&amp;å°¾ï¼ˆæ–°tableåœ°å€ä½ä½ï¼Œè¿™é‡Œçš„é«˜ä½å°±æ˜¯æ•°å­—å¤§å°ï¼‰</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//ä¹”è¿æ–°å±…çš„é“¾è¡¨å¤´&amp;å°¾ï¼ˆæ–°tableåœ°å€é«˜ä½ï¼‰</span></span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="comment">//éå†æ—§é“¾è¡¨</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">//æ˜¯å¦ç•™åœ¨åŸåœ°ï¼Œ(e.hash &amp; oldCap)==0è¡¨ç¤ºæ–°å¢çš„é‚£ä¸€ä½ä¸º0ï¼Œ</span></span><br><span class="line">                        <span class="comment">//ä¸å½±å“æ–°åœ°å€è®¡ç®—ï¼Œå¦åˆ™å°±è¦æ¬å®¶</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)<span class="comment">//é“¾è¡¨åˆå§‹åŒ–</span></span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span> <span class="comment">//è¿½åŠ åˆ°å°¾éƒ¨</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ä¹”è¿æ–°å±…</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//å¦‚æœæ‹†åˆ†å‡ºæ¥çš„é“¾è¡¨ä¸ä¸ºç©ºå°±æŠŠå®ƒæ”¾åˆ°å¯¹åº”ä½ç½®ä¸Š</span></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">//æ–°åœ°å€çš„è®¡ç®—æ–¹å¼ï¼š$oldAddr + oldCap</span></span><br><span class="line">                        <span class="comment">//hash&amp;(oldCap-1)+oldCap = hash&amp;(oldCap*2-1)</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p></li></ol><p></p><ol start="2"><li>æ ‘å½¢åŒ–æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ‘å½¢åŒ–ï¼Œå¦‚æœtableé•¿åº¦(ï¼ï¼ï¼ä¸æ˜¯sizeï¼ï¼ï¼)å°äºMIN_TREEIFY_CAPACITY(64)åˆ™è¿›è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">//å¦‚æœtableä¸ºç©ºæˆ–tableé•¿åº¦å°äºMIN_TREEIFY_CAPACITYåˆ™è¿›è¡Œæ‰©å®¹ï¼Œwhy???</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="comment">//å¦‚æœç»™å®šçš„hashå¯¹åº”ä½ç½®ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//å…ˆæŠŠèŠ‚ç‚¹ç±»å‹å…¨éƒ¨æ¢æˆTreeNode</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                p.prev = tl;</span><br><span class="line">                tl.next = p;</span><br><span class="line">            &#125;</span><br><span class="line">            tl = p;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//æ ‘å½¢åŒ–ï¼Œindexå°±æ˜¯åœ°å€: index = (n - 1) &amp; hash</span></span><br><span class="line">        <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</span><br><span class="line">            hd.treeify(tab);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><h3 id="4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ"><a href="#4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ" class="headerlink" title="4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ"></a>4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ</h3><ol><li>Nodeå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Nodeæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;<span class="comment">//keyçš„hash</span></span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">        V oldValue = value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="2"><li>Nodeã€TreeNodeæ„é€ åŠè½¬æ¢æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a regular (non-tree) node</span></span><br><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For conversion from TreeNodes to plain nodes</span></span><br><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">replacementNode</span><span class="params">(Node&lt;K,V&gt; p, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a tree bin node</span></span><br><span class="line"><span class="function">TreeNode&lt;K,V&gt; <span class="title">newTreeNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TreeNode&lt;&gt;(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For treeifyBin</span></span><br><span class="line"><span class="function">TreeNode&lt;K,V&gt; <span class="title">replacementTreeNode</span><span class="params">(Node&lt;K,V&gt; p, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TreeNode&lt;&gt;(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><h3 id="5ã€-Setè§†å›¾ã€è¿­ä»£å™¨-Iterator-ä¸åˆ†å‰²å™¨-Spliterator"><a href="#5ã€-Setè§†å›¾ã€è¿­ä»£å™¨-Iterator-ä¸åˆ†å‰²å™¨-Spliterator" class="headerlink" title="5ã€ Setè§†å›¾ã€è¿­ä»£å™¨(Iterator)ä¸åˆ†å‰²å™¨(Spliterator)"></a>5ã€ Setè§†å›¾ã€è¿­ä»£å™¨(Iterator)ä¸åˆ†å‰²å™¨(Spliterator)</h3><ol><li><p>keySet</p><ul><li>KeySetå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HashMapå¾¡ç”¨KeySet</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;K&gt; <span class="title">iterator</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> KeyIterator(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> containsKey(o); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;K&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> KeySpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab;</span><br><span class="line">      <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> mc = modCount;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">              <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                  action.accept(e.key);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//è¿­ä»£å‰åä¿®æ”¹æ¬¡æ•°ä¸ä¸€è‡´åˆ™å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">          <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>keySetæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›keyçš„é›†åˆã€è§†å›¾ã€‘,å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„Setï¼Œå®ƒä»…ä»…æä¾›äº†SetåŒ–çš„æ“ä½œæ¥å£ã€‚</span></span><br><span class="line"><span class="comment">//Setä¸Mapçš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šç›¸äº’ä½“ç°å‡ºæ¥ã€‚</span></span><br><span class="line"><span class="comment">//åœ¨Setè¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹äº†Mapåˆ™è¿­ä»£ç»“æœæœªå®šä¹‰ã€‚</span></span><br><span class="line"><span class="comment">//å¯ä»¥é€šè¿‡Setè‡ªå¸¦çš„æ–¹æ³•ä¿®æ”¹Mapï¼Œä½†ä¸èƒ½æ·»åŠ keyã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;K&gt; ks = keySet;</span><br><span class="line">    <span class="keyword">if</span> (ks == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ks = <span class="keyword">new</span> KeySet();</span><br><span class="line">        keySet = ks;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul></li></ol><p></p><ol start="2"><li><p>values</p><ul><li>Valueså®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Values</span> <span class="keyword">extends</span> <span class="title">AbstractCollection</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;V&gt; <span class="title">iterator</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> ValueIterator(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> containsValue(o); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;V&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ValueSpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> mc = modCount;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                    action.accept(e.value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åŒæ ·å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>valuesæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//valuesï¼šç±»ä¼¼KeySet</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Collection&lt;V&gt; vs = values;</span><br><span class="line">    <span class="keyword">if</span> (vs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        vs = <span class="keyword">new</span> Values();</span><br><span class="line">        values = vs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul></li></ol><p></p><ol start="3"><li><p>entrySet</p><ul><li>EntrySetå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntryIterator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map.Entry))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</span><br><span class="line">        Object key = e.getKey();</span><br><span class="line">        Node&lt;K,V&gt; candidate = getNode(hash(key), key);</span><br><span class="line">        <span class="keyword">return</span> candidate != <span class="keyword">null</span> &amp;&amp; candidate.equals(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</span><br><span class="line">            Object key = e.getKey();</span><br><span class="line">            Object value = e.getValue();</span><br><span class="line">            <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;Map.Entry&lt;K,V&gt;&gt; spliterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntrySpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> mc = modCount;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                    action.accept(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>entrySetæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//EntrySet: same as keySet and values</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</span><br><span class="line">    <span class="keyword">return</span> (es = entrySet) == <span class="keyword">null</span> ? (entrySet = <span class="keyword">new</span> EntrySet()) : es;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul></li></ol><p></p><ol start="4"><li><p>è¿­ä»£å™¨(Itetator)</p><ul><li>HashIteratoræ ¸å¿ƒåŠŸèƒ½ï¼ˆæŠ½è±¡ç±»ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿­ä»£å™¨ï¼Œæ³¨æ„æ˜¯abstract</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; next;        <span class="comment">// next entry to return</span></span><br><span class="line">    Node&lt;K,V&gt; current;     <span class="comment">// current entry</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount;  <span class="comment">// for fast-fail</span></span><br><span class="line">    <span class="keyword">int</span> index;             <span class="comment">// current slot</span></span><br><span class="line"></span><br><span class="line">    HashIterator() &#123;</span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">        Node&lt;K,V&gt;[] t = table;</span><br><span class="line">        current = next = <span class="keyword">null</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸ä¸ºnullçš„nodeï¼Œç”¨nextæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">nextNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        Node&lt;K,V&gt; e = next;</span><br><span class="line">        <span class="comment">//è¿­ä»£ä¸­é€”å‘ç”Ÿç»“æ„ä¿®æ”¹ï¼Œç›´æ¥å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰é“¾è¡¨/æ ‘éå†å®Œäº†ï¼Œå°±åœ¨tableä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸ä¸ºnullçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((next = (current = e).next) == <span class="keyword">null</span> &amp;&amp; (t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; p = current;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)<span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹è¢«åˆ é™¤äº†</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        current = <span class="keyword">null</span>;</span><br><span class="line">        K key = p.key;ã€</span><br><span class="line">            <span class="comment">//åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">            removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//æ›´æ–°ã€æœŸæœ›ä¿®æ”¹æ¬¡æ•°ã€‘ï¼Œå¾ˆé‡è¦ï¼ï¼ï¼</span></span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>éå†keySetä½¿ç”¨çš„KeyIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸‰ç§è¿­ä»£å™¨ï¼Œéƒ½ä»¥abstract HashIteratorä¸ºåŸºç¡€</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode().key; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>éå†valuesä½¿ç”¨çš„ValueIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode().value; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>éå†entrySetä½¿ç”¨çš„EntryIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntryIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul></li></ol><p></p><ol start="5"><li><p>åˆ†å‰²å™¨(Spliterator)ï¼ŒJava8æ–°å¼•å…¥çš„åŠŸèƒ½</p><ul><li>HashMapSpliteratoræ ¸å¿ƒåŠŸèƒ½ï¼ˆæŠ½è±¡ç±»ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ†å‰²å™¨ï¼Œ</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;K,V&gt; map;</span><br><span class="line">    Node&lt;K,V&gt; current;          <span class="comment">// current node</span></span><br><span class="line">    <span class="keyword">int</span> index;                  <span class="comment">// current index, modified on advance/split</span></span><br><span class="line">    <span class="keyword">int</span> fence;                  <span class="comment">// one past last index</span></span><br><span class="line">    <span class="keyword">int</span> est;                    <span class="comment">// size estimate</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount;       <span class="comment">// for comodification checks</span></span><br><span class="line"></span><br><span class="line">    HashMapSpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin,</span><br><span class="line">                       <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                       <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">this</span>.map = m;</span><br><span class="line">        <span class="keyword">this</span>.index = origin;</span><br><span class="line">        <span class="keyword">this</span>.fence = fence;</span><br><span class="line">        <span class="keyword">this</span>.est = est;</span><br><span class="line">        <span class="keyword">this</span>.expectedModCount = expectedModCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getFence</span><span class="params">()</span> </span>&#123; <span class="comment">// initialize fence and size on first use</span></span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            HashMap&lt;K,V&gt; m = map;</span><br><span class="line">            est = m.size;</span><br><span class="line">            expectedModCount = m.modCount;</span><br><span class="line">            Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">estimateSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getFence(); <span class="comment">// force init</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">long</span>) est;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>KeySpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    KeySpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                   <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeySpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> KeySpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                             expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p.key);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = current.key;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(k);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>) |</span><br><span class="line">            Spliterator.DISTINCT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>ValueSpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    ValueSpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                     <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueSpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> ValueSpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                               expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p.value);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    V v = current.value;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(v);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul><p></p><ul><li>EntrySpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    EntrySpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                     <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntrySpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> EntrySpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                               expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    Node&lt;K,V&gt; e = current;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(e);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>) |</span><br><span class="line">            Spliterator.DISTINCT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ul></li></ol><p></p><h1 id="äºŒã€-Java8æ–°ç‰¹æ€§"><a href="#äºŒã€-Java8æ–°ç‰¹æ€§" class="headerlink" title="äºŒã€ Java8æ–°ç‰¹æ€§"></a>äºŒã€ Java8æ–°ç‰¹æ€§</h1><ol><li>å¸¦é»˜è®¤å€¼çš„getæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? defaultValue : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="2"><li>ç¼ºå¤±keyæˆ–keyä¸ºnullæ‰æ’å…¥èŠ‚ç‚¹ï¼Œè¿”å›æ—§èŠ‚ç‚¹çš„å€¼ï¼Œå¦‚æœå­˜åœ¨çš„è¯<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="3"><li>åŸºäºkeyå’Œvalueä¸¤é‡éªŒè¯çš„åˆ é™¤æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="4"><li>åŸºäºkeyå’Œvalueä¸¤é‡éªŒè¯çš„æ›¿æ¢æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e; V v;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        ((v = e.value) == oldValue || (v != <span class="keyword">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class="line">        e.value = newValue;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="5"><li>valueæ›¿æ¢æ“ä½œï¼Œä»…å½“keyå­˜åœ¨æ‰æ›¿æ¢ï¼Œæ³¨æ„ä¸putçš„åŒºåˆ«<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = e.value;</span><br><span class="line">        e.value = value;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="6"><li>å¦‚æœç»™å®šçš„keyåœ¨mapä¸­ä¸å­˜åœ¨ï¼Œå°±ä»ç»™å®šçš„functionè®¡ç®—å‡ºä¸€ä¸ªvalueæ”¾è¿›mapï¼Œå¹¶è¿”å›è¿™ä¸ªvalue<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">computeIfAbsent</span><span class="params">(K key, Function&lt;? <span class="keyword">super</span> K,? extends V&gt; mappingFunction)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//æ˜¯å¦éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–ä¸ªèŠ‚ç‚¹æ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œå°±åœ¨æ ‘ä¸­æŸ¥æ‰¾keyï¼Œè¿”å›èŠ‚ç‚¹ç”¨oldæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨æŸ¥è¯¢keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ç»Ÿè®¡é“¾è¡¨é•¿åº¦</span></span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        V oldValue;</span><br><span class="line">        <span class="comment">//å¦‚æœç»™å®škeyå­˜åœ¨ï¼Œå¹¶ä¸”valueä¸ä¸ºnullï¼Œå°±ç›´æ¥è¿”å›å¯¹åº”çš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; (oldValue = old.value) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            afterNodeAccess(old);<span class="comment">//Do nothing</span></span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦åˆ™å°±ä»ç»™å®šçš„å‡½æ•°key -&gt; &#123;...&#125;ï¼Œè®¡ç®—å‡ºä¸€ä¸ªvalueå¹¶æ’å…¥</span></span><br><span class="line">    V v = mappingFunction.apply(key);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="keyword">null</span>) &#123; <span class="comment">//å¦‚æœè®¡ç®—å‡ºçš„valueæ˜¯nullåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123; <span class="comment">//keyå­˜åœ¨ä½†valueä¸ºnullå°±ç›´æ¥æ›¿æ¢valueå¹¶è¿”å›æ—§value</span></span><br><span class="line">        old.value = v;</span><br><span class="line">        afterNodeAccess(old);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (t != <span class="keyword">null</span>) <span class="comment">//å¦‚æœkeyä¸å­˜åœ¨ï¼Œä¸”å½“å‰ä½ç½®ä¸ºä¸€æ£µæ ‘ï¼Œåˆ™å‘æ ‘ä¸­å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//å¦‚æœkeyä¸å­˜åœ¨ï¼Œä¸”å½“å‰ä½ç½®ä¸ºé“¾è¡¨ï¼Œåˆ™å‘è¡¨å¤´å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        tab[i] = newNode(hash, key, v, first);</span><br><span class="line">        <span class="comment">//å¢åŠ å®Œæˆååˆ¤æ–­æ˜¯å¦éœ€è¦æ ‘å½¢åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">            treeifyBin(tab, hash);</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    ++size;<span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹size+1</span></span><br><span class="line">    afterNodeInsertion(<span class="keyword">true</span>);<span class="comment">//Do nothing</span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="7"><li>å¦‚æœç»™å®šçš„keyå­˜åœ¨ï¼Œå°±ç”¨<code>(k,oldV) -&gt; {}</code>è®¡ç®—å‡ºçš„å€¼æ›¿æ¢æ—§å€¼ï¼Œå¹¶è¿”å›è®¡ç®—å‡ºçš„æ–°å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">computeIfPresent</span><span class="params">(K key, </span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    Node&lt;K,V&gt; e; V oldValue;</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="comment">//keyå­˜åœ¨ä¸”æ—§å€¼ä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash, key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (oldValue = e.value) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è®¡ç®—æ–°å€¼</span></span><br><span class="line">        V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">        <span class="comment">//å¦‚æœæ–°å€¼ä¸ä¸ºnullåˆ™æ›¿æ¢æˆæ–°å€¼ï¼Œå¹¶è¿”å›æ–°å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            e.value = v;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//å¦åˆ™åˆ é™¤æ—§èŠ‚ç‚¹(æ–°å€¼ä¸ºnullä»£è¡¨è¯¥èŠ‚ç‚¹æ— æ•ˆ)</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‰¾ä¸åˆ°keyç›´æ¥è¿”å›null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="8"><li>ç”¨<code>(key, Oldv) -&gt; {}</code>è®¡ç®—å‡ºçš„æ–°å€¼æ›¿æ¢keyå¯¹åº”çš„æ—§å€¼ï¼Œè¿”å›æ–°å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyå­˜åœ¨ï¼Œæ–°å€¼ä¸ºnullï¼Œåˆ é™¤keyèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//keyå­˜åœ¨ï¼Œæ–°å€¼ä¸ä¸ºnullï¼Œä¿®æ”¹keyèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//keyä¸å­˜åœ¨ï¼Œæ–°å€¼ä¸ºnullï¼Œç›´æ¥è¿”å›null</span></span><br><span class="line"><span class="comment">//keyä¸å­˜åœ¨ï¼Œæ–°å€¼ä¸ä¸ºnullï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">compute</span><span class="params">(K key,</span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//tableæœªåˆå§‹åŒ–æˆ–éœ€è¦æ‰©å®¹å°±æ‰§è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹ä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯çº¢é»‘æ ‘å°±åœ¨æ ‘ä¸­æŸ¥æ‰¾keyï¼Œå¯¹åº”nodeç”¨oldæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨ï¼Œç”¨oldæ ‡è®°æ‰¾åˆ°çš„node</span></span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;<span class="comment">//ç»Ÿè®¡é“¾è¡¨é•¿åº¦ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ ‘å½¢åŒ–</span></span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    V oldValue = (old == <span class="keyword">null</span>) ? <span class="keyword">null</span> : old.value;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ–°value</span></span><br><span class="line">    V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;<span class="comment">//å¯¹åº”çš„keyå­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ–°valueä¸ä¸ºnullåˆ™æ›¿æ¢æˆæ–°value</span></span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);<span class="comment">//Do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//å¦åˆ™åˆ é™¤keyå¯¹åº”çš„æ—§èŠ‚ç‚¹</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123; <span class="comment">//å¦‚æœæ–°valueä¸ä¸ºnullï¼Œä¸”keyä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)<span class="comment">//å¦‚æœæ˜¯æ ‘å‹ç»“æ„å°±åœ¨æ ‘ä¸­æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">        <span class="keyword">else</span> &#123;<span class="comment">//å¦åˆ™å°±åœ¨é“¾è¡¨å¤´éƒ¨æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">            tab[i] = newNode(hash, key, v, first);</span><br><span class="line">            <span class="comment">//å¦‚æœéœ€è¦æ ‘å½¢åŒ–å°±å¼€å§‹æ ‘å½¢åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;<span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹size+1</span></span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);<span class="comment">//Do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="9"><li>åˆå¹¶ä¸¤ä¸ªkeyä¸€æ ·çš„valueï¼Œæ–°å€¼ç”Ÿæˆå‡½æ•°<code>(oldV, newV) -&gt; {}</code>ï¼Œç”¨ç”Ÿæˆçš„æ–°å€¼å»æ›¿æ¢æ—§å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šåªæœ‰old valueä¸ä¸ºnullæ‰å»è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¦åˆ™ç›´æ¥æ’å…¥æ–°value</span></span><br><span class="line"><span class="comment">//Streamä¸­toMapä¼šç”¨åˆ°ï¼Œä¸€èˆ¬è§£å†³keyå†²çª</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">merge</span><span class="params">(K key, V value,</span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V v;</span><br><span class="line">        <span class="keyword">if</span> (old.value != <span class="keyword">null</span>)</span><br><span class="line">            v = remappingFunction.apply(old.value, value);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            v = value;</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)</span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[i] = newNode(hash, key, value, first);</span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;</span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="10"><li>ç”¨ç»™å®šçš„consumerå¾ªç¯å¤„ç†æ¯ä¸ªkey-value pair<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(BiConsumer&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mc = modCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                action.accept(e.key, e.value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸­é—´å‘ç”Ÿè¿‡ä¿®æ”¹åˆ™å¿«é€Ÿå¤±è´¥ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="11"><li>ç”¨ç»™å®šçš„å‡½æ•°<code>(k,v)-&gt;{}</code>ç”Ÿæˆä¸€ä¸ªæ–°å€¼ï¼Œå¹¶ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼ï¼Œè¿™ä¸ªæ“ä½œä½œç”¨äºæ‰€æœ‰å…ƒç´ <br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; function)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (function == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mc = modCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                e.value = function.apply(e.key, e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (modCount != mc)<span class="comment">//çº¿ç¨‹å®‰å…¨æ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><h1 id="ä¸‰ã€-çº¢é»‘æ ‘ç›¸å…³æ“ä½œ"><a href="#ä¸‰ã€-çº¢é»‘æ ‘ç›¸å…³æ“ä½œ" class="headerlink" title="ä¸‰ã€ çº¢é»‘æ ‘ç›¸å…³æ“ä½œ"></a>ä¸‰ã€ çº¢é»‘æ ‘ç›¸å…³æ“ä½œ</h1><ol><li>çº¢é»‘æ ‘èŠ‚ç‚¹å®šä¹‰ï¼ˆä»…å«æ„é€ æ–¹æ³•ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TreeNodeå®šä¹‰ï¼Œä»Nodeä¸Šç»§æ‰¿äº†key, valueå’Œnextç›¸å…³æˆå‘˜</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="2"><li>æ‰¾åˆ°å½“å‰æ ‘çš„rootèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä»å½“å‰èŠ‚ç‚¹å‘å‰ï¼Œä¸€ç›´åˆ°parentä¸ºnullçš„èŠ‚ç‚¹å°±æ˜¯rootèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        r = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="3"><li>å°†rootèŠ‚ç‚¹æ”¾åˆ°è¯¥hashåœ°å€çš„é¦–ä¸ªèŠ‚ç‚¹ä½ç½®ä¸Š<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">moveRootToFront</span><span class="params">(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; tab != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; root.hash;<span class="comment">//é¦–ä¸ªèŠ‚ç‚¹åœ°å€</span></span><br><span class="line">        TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–ä¸ªèŠ‚ç‚¹ä¸æ˜¯rootèŠ‚ç‚¹ï¼Œå°±æŠŠrootèŠ‚ç‚¹æåˆ°é¦–ä½</span></span><br><span class="line">        <span class="keyword">if</span> (root != first) &#123;</span><br><span class="line">            Node&lt;K,V&gt; rn;</span><br><span class="line">            tab[index] = root;<span class="comment">//åœ°å€èŠ‚ç‚¹ç›´æ¥æŒ‡å‘root</span></span><br><span class="line">            TreeNode&lt;K,V&gt; rp = root.prev; <span class="comment">//rp:rootä¹‹å‰çš„éƒ¨åˆ†</span></span><br><span class="line">            <span class="keyword">if</span> ((rn = root.next) != <span class="keyword">null</span>) <span class="comment">//rn:rootä¹‹åçš„éƒ¨åˆ†</span></span><br><span class="line">                <span class="comment">//rootä¹‹åçš„éƒ¨åˆ†preç›´æ¥ä¸rootä¹‹å‰çš„éƒ¨åˆ†ç›¸è¿</span></span><br><span class="line">                ((TreeNode&lt;K,V&gt;)rn).prev = rp;</span><br><span class="line">            <span class="keyword">if</span> (rp != <span class="keyword">null</span>)</span><br><span class="line">                rp.next = rn; <span class="comment">//rootä¹‹å‰çš„éƒ¨åˆ†nextç›´æ¥ä¸rootä¹‹åçš„éƒ¨åˆ†ç›¸è¿</span></span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                first.prev = root; <span class="comment">//firstä¸rootç›¸è¿</span></span><br><span class="line">            root.next = first;</span><br><span class="line">            root.prev = <span class="keyword">null</span>;<span class="comment">//rootå‰é©±èŠ‚ç‚¹ä¸ºnull</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;<span class="comment">//æ£€æŸ¥çº¢é»‘æ ‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="4"><li>ä»å½“å‰èŠ‚ç‚¹æŸ¥æ‰¾keyå¯¹åº”çš„Node<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//ä»å½“å‰èŠ‚ç‚¹æŸ¥æ‰¾keyï¼Œkcç¼“å­˜äº†keyçš„classï¼Œå¦‚æœkey.classæ˜¯Comparableçš„ï¼Œå¦åˆ™ä¸ºnull</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ph, dir; K pk;</span><br><span class="line">        TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</span><br><span class="line">        <span class="comment">//å¦‚æœæŸ¥æ‰¾çš„hash keyå°äºå½“å‰hash keyï¼Œå°±è½¬å‘å·¦å­æ ‘æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//å¦‚æœæŸ¥æ‰¾çš„hash keyå¤§äºå½“å‰hash keyï¼Œå°±è½¬å‘å³å­æ ‘æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸€è‡´å°±è¡¨ç¤ºæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å·¦å­æ ‘ä¸ºç©ºï¼Œç›´æ¥è½¬å‘å³å­æ ‘ï¼ˆåªå¯èƒ½åœ¨å³å­æ ‘ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘ä¸ºç©ºï¼Œç›´æ¥è½¬å‘å·¦å­æ ‘ï¼ˆåªå¯èƒ½åœ¨å·¦å­æ ‘ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œä½†keyæ˜¯å¯æ¯”è¾ƒçš„ï¼Œå¹¶ä¸”èƒ½æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                  (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                 (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">            p = (dir &lt; <span class="number">0</span>) ? pl : pr;<span class="comment">//æ ¹æ®keyçš„æ¯”è¾ƒç»“æœå†³å®šå»é‚£ä¸ªå­æ ‘æœç´¢</span></span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œä¸”keyä¸å¯æ¯”è¾ƒæˆ–æ— æ³•æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">        <span class="comment">//å…ˆæœç´¢å³å­æ ‘ï¼Œå¦‚æœåœ¨å³å­æ ‘ä¸­æ‰¾åˆ°keyï¼Œå°±è¿”å›å¯¹åº”node</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> q;</span><br><span class="line">        <span class="comment">//å³å­æ ‘æ²¡æ‰¾åˆ°ï¼Œæ¥ç€éå†å·¦å­æ ‘ï¼ˆä¸ºä»€ä¹ˆä¸ç”¨tieBreakOrderç¡®å®šæŸ¥å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘ï¼Ÿï¼‰</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = pl;</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="5"><li>ä»rootèŠ‚ç‚¹å¼€å§‹æŸ¥è¯¢æŸä¸ªkeyï¼Œå°±æ˜¯æ­£å¸¸çš„æŸ¥è¯¢<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="6"><li><p>æ·±å±‚æ¬¡æ¯”è¾ƒä¸¤ä¸ªkeyçš„å¤§å°ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±è¡¨ç¤ºå‘ç”Ÿäº†<strong>hashç¢°æ’</strong></p><p>æ³¨æ„ï¼š<strong>hashç¢°æ’</strong>ä¸<strong>hashåœ°å€ç¢°æ’</strong>ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œhashç¢°æ’æ˜¯æŒ‡ä¸¤ä¸ªkeyç®—å‡ºæ¥çš„hashä¸€æ ·ï¼Œhashç¢°æ’å¿…å®šä¼šå‘ç”Ÿhashåœ°å€ç¢°æ’ï¼Œä½†hashåœ°å€(hash&amp;(n-1))ç¢°æ’åªæ˜¯ä½xä½ç¢°æ’ï¼Œä¸ä»£è¡¨æ•´ä¸ªhashå€¼ä¸€æ ·<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“keyçš„hashå€¼ä¸€è‡´(hashç¢°æ’)ï¼Œä¸”keyä¸å¯æ¯”è¾ƒæ—¶ï¼ŒidentityHashCodeè¿›è¡Œæ¯”è¾ƒï¼Œnullçš„hashä¸º0</span></span><br><span class="line"><span class="comment">//identityHashCodeæ€»æ˜¯è°ƒç”¨Objectå®ç°çš„hashCodeï¼Œxx.hashCodeæ˜¯è°ƒç”¨é‡å†™åçš„hashCode</span></span><br><span class="line"><span class="comment">//æ³¨æ„ï¼šidentityHashCodeä¹Ÿå¯èƒ½ä¼šé‡å¤ï¼Œä½†æ¦‚ç‡ç›¸å½“å°ã€‚</span></span><br><span class="line"><span class="comment">//è¿™é‡Œçš„æ¯”è¾ƒç»“æœåˆ†ä¸º-1å’Œ1ï¼Œ0å½’åˆ°-1é‡Œé¢ï¼Œæ‰€ä»¥å…ƒç´ çš„ç›¸å¯¹é¡ºåºå°±æ— æ³•ä¿è¯äº†ï¼Œä½†æ²¡æœ‰å…³ç³»</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> d;</span><br><span class="line"><span class="comment">//aæˆ–bå…¶ä¸­ä¸€ä¸ªæ˜¯nullï¼Œæˆ–aã€bçš„ç±»å‹æ˜¯ä¸€æ ·çš„æ—¶å€™æ‰å¯æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">(d = a.getClass().getName().</span><br><span class="line">compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">-<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p></li></ol><p></p><ol start="7"><li>æ ‘å½¢åŒ–æ“ä½œï¼ˆä»¥å½“å‰èŠ‚ç‚¹ä¸ºrootèŠ‚ç‚¹ï¼‰,ä¸€èˆ¬åœ¨é“¾è¡¨é¦–èŠ‚ç‚¹è°ƒç”¨è¯¥æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æ ‘å½¢åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeify</span><span class="params">(Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„thiså®é™…å°±æ˜¯é“¾è¡¨çš„é¦–èŠ‚ç‚¹ï¼Œéå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = <span class="keyword">this</span>, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–rootèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.parent = <span class="keyword">null</span>;</span><br><span class="line">            x.red = <span class="keyword">false</span>;<span class="comment">//rootèŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">            root = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            K k = x.key;</span><br><span class="line">            <span class="keyword">int</span> h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//ä¸€ç›´éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯æ’å…¥çš„ä½ç½®ï¼ˆå¯æ’å…¥å¶å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph;</span><br><span class="line">                K pk = p.key;</span><br><span class="line">                <span class="comment">//h &lt; ph èµ°å·¦è¾¹</span></span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="comment">//h &gt; ph èµ°å³è¾¹</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//h == phï¼Œä¸”(keyä¸å¯æ¯”è¾ƒï¼Œæˆ–keyæ¯”è¾ƒç»“æœæ— æ³•åŒºåˆ†å¤§å°)</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                          (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                         (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//é‡‡ç”¨identify hashcodeå†æ¬¡æ¯”è¾ƒ(0å’Œ-1åˆå¹¶ä¸º-1)</span></span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line"></span><br><span class="line">                TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="comment">//å¦‚æœxå·²ç»åˆ°è¾¾å¯ä»¥æ’å…¥çš„ä½ç½®ï¼Œå°±æ’å…¥xèŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="comment">//é‡æ–°å¹³è¡¡çº¢é»‘æ ‘</span></span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦åˆ™ç»§ç»­æŸ¥æ‰¾èƒ½æ’å…¥çš„ä½ç½®</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡æ–°å¹³è¡¡æ ‘årootèŠ‚ç‚¹å¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°å°†å¶å­èŠ‚ç‚¹æ”¾åˆ°é¦–ä¸ªèŠ‚ç‚¹çš„ä½ç½®</span></span><br><span class="line">    moveRootToFront(tab, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="8"><li>è§£æ ‘å½¢åŒ–ï¼ˆçº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">untreeify</span><span class="params">(HashMap&lt;K,V&gt; map)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt; q = <span class="keyword">this</span>; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">        Node&lt;K,V&gt; p = map.replacementNode(q, <span class="keyword">null</span>);<span class="comment">//èŠ‚ç‚¹ç±»å‹æ›¿æ¢ä¸€ä¸‹å°±å¯ä»¥äº†</span></span><br><span class="line">        <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">            hd = p;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tl.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="9"><li>åœ¨æ ‘ä¸­æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[]tab,<span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">     Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">     TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line">     <span class="comment">//ä»rootå¼€å§‹éå†ï¼Œå¦‚æœkeyå·²å­˜åœ¨å°±è¿”å›ç›¸å…³èŠ‚ç‚¹ï¼Œå¦åˆ™æ‰¾åˆ°ä¸€ä¸ªåˆé€‚ä½ç½®æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">     <span class="comment">//ä½¿å¾—æ–°å¢èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹</span></span><br><span class="line">     <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">         <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">         <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">             dir = -<span class="number">1</span>;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">             dir = <span class="number">1</span>;</span><br><span class="line">         <span class="comment">//keyå·²ç»å­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸Šå±‚æ–¹æ³•ç»Ÿä¸€æ›¿æ¢value</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">             <span class="keyword">return</span> p;</span><br><span class="line">         <span class="comment">//ph==h å¹¶ä¸”keyä¸å¯æ¯”è¾ƒæˆ–æ— æ³•æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                  (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">//æœç´¢å·¦å­æ ‘&amp;å³å­æ ‘</span></span><br><span class="line">             <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                 TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                 <span class="comment">//å·¦å³å­æ ‘åªéœ€è¦æœç´¢ä¸€æ¬¡ï¼Œåç»­éå†å…¶ä»–èŠ‚ç‚¹æ— éœ€å†æœç´¢å®ƒä»¬çš„å­æ ‘</span></span><br><span class="line">                 searched = <span class="keyword">true</span>;</span><br><span class="line">                 <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                      (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                     ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                      (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                     <span class="keyword">return</span> q;<span class="comment">//åªè¦æ‰¾åˆ°äº†keyå°±ç›´æ¥è¿”å›</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å·¦å³å­æ ‘æ²¡æ‰¾åˆ°ï¼Œå‡†å¤‡æ–°è¿½åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç°åœ¨åˆ¤æ–­è¿½åŠ åˆ°å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘</span></span><br><span class="line">             dir = tieBreakOrder(k, pk);</span><br><span class="line">         &#125;<span class="comment">//if</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">//è¿½åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">         TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">         <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">             Node&lt;K,V&gt; xpn = xp.next;<span class="comment">//æ³¨æ„è¿™é‡Œåœ¨è¿›è¡Œæ ‘çš„è¿½åŠ æ“ä½œæ—¶ä»ç„¶ä¿ç•™äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§</span></span><br><span class="line">             TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line">             <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                 xp.left = x;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">                 xp.right = x;</span><br><span class="line">             xp.next = x;</span><br><span class="line">             x.parent = x.prev = xp;</span><br><span class="line">             <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line">                 ((TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line">             <span class="comment">//é‡æ–°å¹³è¡¡æ ‘å¹¶è°ƒæ•´nodeåˆ°é¦–ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">             moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="10"><li>ç§»é™¤å½“å‰èŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šHashMapçº¢é»‘æ ‘å…·æœ‰åŒå‘é“¾è¡¨å’Œæ ‘çš„ä¸¤ç§ç‰¹æ€§ï¼Œéƒ½è¦è¿›è¡Œè°ƒæ•´</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeTreeNode</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">    TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index], root = first, rl;</span><br><span class="line">    <span class="comment">//succä¸ºå½“å‰èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œ perdä¸ºå‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; succ = (TreeNode&lt;K,V&gt;)next, pred = prev;</span><br><span class="line">    <span class="comment">//å¦‚æœå‰é©±èŠ‚ç‚¹ä¸å­˜åœ¨(åˆ é™¤çš„æ˜¯rootèŠ‚ç‚¹)</span></span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        tab[index] = first = succ; <span class="comment">//firstç›´æ¥æŒ‡å‘rootåç½®èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = succ; <span class="comment">//å¦åˆ™å‰é©±èŠ‚ç‚¹ä¸åç½®èŠ‚ç‚¹ç›¸è¿å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> (succ != <span class="keyword">null</span>) <span class="comment">//å…³è”prevæŒ‡é’ˆ</span></span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    <span class="keyword">if</span> (first == <span class="keyword">null</span>)<span class="comment">//åˆ é™¤çš„èŠ‚ç‚¹ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (root.parent != <span class="keyword">null</span>) </span><br><span class="line">        root = root.root();<span class="comment">//é‡æ–°æ‰¾rootèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">//å¦‚æœrootä¸ºnullæˆ–è€…(å…è®¸ç§»åŠ¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”å·¦å­æ ‘æˆ–å³å­æ ‘ä¸ºnull)ï¼Œå°±è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || (movable &amp;&amp; (root.right == <span class="keyword">null</span></span><br><span class="line">                                     || (rl = root.left) == <span class="keyword">null</span></span><br><span class="line">                                     || rl.left == <span class="keyword">null</span>))) &#123;</span><br><span class="line">        tab[index] = first.untreeify(map);  <span class="comment">// too small</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆªè‡³åˆ°è¿™é‡Œï¼Œåªæ˜¯è°ƒæ•´äº†ä½œä¸ºåŒå‘é“¾è¡¨çš„é‚£ä¸€éƒ¨åˆ†æŒ‡é’ˆï¼Œä½œä¸ºæ ‘çš„ç›¸å…³å†…å®¹è¿˜æœªè¿›è¡Œè°ƒæ•´</span></span><br><span class="line">    <span class="comment">//è¿›è¡Œçº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œï¼Œçº¢é»‘æ ‘åˆ é™¤æ“ä½œåˆ†3ä¸­æƒ…å†µ</span></span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>, pl = left, pr = right, replacement;</span><br><span class="line">    <span class="comment">//æƒ…å†µ1ï¼šåˆ é™¤èŠ‚ç‚¹å·¦å³å­æ ‘ä¸ä¸ºnullï¼Œç”¨åç»§ç»“ç‚¹ï¼ˆå¤§äºåˆ é™¤ç»“ç‚¹çš„æœ€å°ç»“ç‚¹ï¼‰æ›¿æ¢åˆ é™¤ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (pl != <span class="keyword">null</span> &amp;&amp; pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; s = pr, sl; <span class="comment">//sæ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//æ‰¾åˆ°åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹(å³å­æ ‘çš„æœ€å·¦è¾¹å¶å­èŠ‚ç‚¹)</span></span><br><span class="line">        <span class="keyword">while</span> ((sl = s.left) != <span class="keyword">null</span>) <span class="comment">// find successor</span></span><br><span class="line">            s = sl;<span class="comment">//så°±æ˜¯åç»§èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//äº¤æ¢så’Œpçš„é¢œè‰²</span></span><br><span class="line">        <span class="keyword">boolean</span> c = s.red; s.red = p.red; p.red = c; <span class="comment">// swap colors</span></span><br><span class="line">        TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">        TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        <span class="comment">//sæ˜¯å¾…åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹æŒ‚åˆ°sçš„å³å­èŠ‚ç‚¹ï¼ˆäº’æ¢ä½ç½®ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (s == pr) &#123; <span class="comment">// p was s's direct parentï¼ˆpçš„å³å­èŠ‚ç‚¹æ— å·¦å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            p.parent = s;</span><br><span class="line">            s.right = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">            <span class="comment">//è¿˜æ˜¯äº’æ¢så’Œpçš„ä½ç½®ï¼Œè®¾ç½®éƒ¨åˆ†å…¶ä»–å±æ€§</span></span><br><span class="line">            <span class="comment">//å¦‚æœsæ˜¯å·¦å­èŠ‚ç‚¹å°±æŠŠpæ”¾åˆ°spçš„å·¦å­èŠ‚ç‚¹ä¸Šï¼Œåä¹‹äº¦ç„¶</span></span><br><span class="line">            <span class="keyword">if</span> ((p.parent = sp) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s == sp.left)</span><br><span class="line">                    sp.left = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    sp.right = p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//sçš„å³å­èŠ‚ç‚¹æŒ‡å‘pçš„å³å­èŠ‚ç‚¹ï¼Œpå³å­èŠ‚ç‚¹çˆ¶æŒ‡é’ˆæŒ‡å‘s</span></span><br><span class="line">            <span class="keyword">if</span> ((s.right = pr) != <span class="keyword">null</span>)</span><br><span class="line">                pr.parent = s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®è¡¥så’Œpäº¤æ¢åæ–­å¼€çš„èŠ‚ç‚¹(pl, pp, sr, root)</span></span><br><span class="line">        p.left = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//p.right = sr;</span></span><br><span class="line">        <span class="keyword">if</span> ((p.right = sr) != <span class="keyword">null</span>)</span><br><span class="line">            sr.parent = p;</span><br><span class="line">        <span class="comment">//s.left = pl; </span></span><br><span class="line">        <span class="keyword">if</span> ((s.left = pl) != <span class="keyword">null</span>)</span><br><span class="line">            pl.parent = s;</span><br><span class="line">        <span class="keyword">if</span> ((s.parent = pp) == <span class="keyword">null</span>)</span><br><span class="line">            root = s; <span class="comment">//sæ˜¯root</span></span><br><span class="line">        <span class="comment">// s.parent = pp;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = s;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = s;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç°åœ¨srå·²ç»æ”¾åˆ°p.right,p.leftå·²ç»æ˜¯nulläº†ï¼Œè¦åˆ é™¤pï¼Œè¿˜è¦å¤„ç†p.right</span></span><br><span class="line">        <span class="comment">//è¿™é‡Œç”¨replacementæ¥å¡«å……è¢«åˆ é™¤èŠ‚ç‚¹çš„ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">            replacement = sr;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            replacement = p;<span class="comment">//ä¸´æ—¶çš„ï¼Œpæ˜¯è¦åˆ é™¤çš„</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æƒ…å†µ2ï¼šåˆ é™¤èŠ‚ç‚¹åªæœ‰å·¦å­èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨å·¦å­èŠ‚ç‚¹æ›¿æ¢å¾…åˆ é™¤èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pl;</span><br><span class="line">    <span class="comment">//æƒ…å†µ3ï¼šåˆ é™¤èŠ‚ç‚¹åªæœ‰å·¦å­èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨å·¦å­èŠ‚ç‚¹æ›¿æ¢å¾…åˆ é™¤èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pr;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        replacement = p;<span class="comment">//ä¸´æ—¶çš„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœç”¨äºæ›¿æ¢pä½ç½®çš„å†…å®¹æ˜¯æœ‰æ•ˆçš„(ä¸æ˜¯p)ï¼Œå°±ç”¨replacementä»£æ›¿pçš„ä½ç½®ï¼ˆçœŸæ­£çš„åˆ é™¤æ“ä½œï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (replacement != p) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (pp == <span class="keyword">null</span>)</span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = replacement;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = replacement;</span><br><span class="line">        p.left = p.right = p.parent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è€ƒè™‘æ›¿æ¢èŠ‚ç‚¹sçš„é¢œè‰²(å‰é¢å’Œpäº¤æ¢è¿‡äº†ï¼Œè¿™é‡Œç”¨påˆ¤æ–­)</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯çº¢è‰²ï¼Œåˆ™ä¸å½±å“æ ‘çš„å¹³è¡¡ï¼Œç›´æ¥ç»“æŸ</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯é»‘è‰²ï¼Œåˆ™éœ€è¦é‡æ–°å¹³è¡¡çº¢é»‘æ ‘ï¼ˆè¿™é‡Œæ˜¯æ•´ä¸ªçº¢é»‘æ ‘åˆ é™¤æœ€å¤æ‚çš„åœ°æ–¹ï¼‰</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œè¿”å›çš„rå°±æ˜¯æ–°é€‰å‡ºæ¥çš„rootèŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; r = p.red ? root : balanceDeletion(root, replacement);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœpæ— å­èŠ‚ç‚¹ï¼Œç›´æ¥ä¸ppè§£æŒ‚å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> (replacement == p) &#123;  <span class="comment">// detach</span></span><br><span class="line">        TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        p.parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                pp.left = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.right)</span><br><span class="line">                pp.right = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†rootæ”¾åˆ°é¦–èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (movable)</span><br><span class="line">        moveRootToFront(tab, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="11"><li>çº¢é»‘æ ‘çš„åˆ†è£‚ï¼Œä»…ä»…ä¼šå‘ç”Ÿåœ¨tableæ‰©å®¹æ—¶ï¼Œçº¢é»‘æ ‘è¿›è¡Œrehashçš„è¿‡ç¨‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">split</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; b = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„loå°±æ˜¯ä½åœ°å€æœªï¼Œä¹Ÿå°±æ˜¯åŸä½ç½®ï¼Œhiè¡¨ç¤ºé«˜ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æ–°åœ°å€</span></span><br><span class="line">    <span class="comment">// ç”±äºåœ°å€çš„ç®—æ³•ç‰¹æ€§ï¼Œä¸€ä¸ªæ—§åœ°å€ä¸Šçš„èŠ‚ç‚¹åªå¯èƒ½å¯¹åº”ä¸€ä¸ªæ–°åœ°å€</span></span><br><span class="line">    TreeNode&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//éå†æ•´ä¸ªé“¾è¡¨ï¼ˆåˆ«å¿˜äº†çº¢é»‘æ ‘ä»ä¿ç•™äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§ï¼‰ï¼Œå°†ä¸€ä¸ªé“¾è¡¨æ‹†æˆä¸¤ä¸ªé“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; e = b, next; e != <span class="keyword">null</span>; e = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)e.next;</span><br><span class="line">        e.next = <span class="keyword">null</span>;<span class="comment">//ä¸ä¸‹æ¸¸è§£æŒ‚</span></span><br><span class="line">        <span class="comment">//éœ€è¦ç•™åœ¨åŸåœ°çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((e.hash &amp; bit) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                loHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                loTail.next = e;</span><br><span class="line">            loTail = e;</span><br><span class="line">            ++lc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//éœ€è¦è¿ç§»åˆ°æ–°åœ°å€çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                hiHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hiTail.next = e;</span><br><span class="line">            hiTail = e;</span><br><span class="line">            ++hc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœç•™åœ¨åŸåœ°çš„é“¾è¡¨ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (loHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœèŠ‚ç‚¹æ•°å°äºæ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå°±è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index] = loHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index] = loHead;</span><br><span class="line">            <span class="comment">//å¦‚æœæœ‰æ‹†åˆ†å‡ºå»çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç•™ä¸‹æ¥çš„å°±éœ€è¦é‡æ–°æ ‘å½¢åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) <span class="comment">//hiä¸ä¸ºnullå°±è¡¨ç¤ºæœ‰æ‹†åˆ†å‡ºå»çš„èŠ‚ç‚¹</span></span><br><span class="line">                loHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ–°æ‹†åˆ†å‡ºæ¥çš„é“¾è¡¨ä¸ä¸ºç©ºï¼Œå¤„ç†æ–¹å¼ä¸loä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index + bit] = hiHead.untreeify(map);<span class="comment">//æ³¨æ„hiåœ°å€çš„è®¡ç®—æ–¹å¼</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index + bit] = hiHead;</span><br><span class="line">            <span class="keyword">if</span> (loHead != <span class="keyword">null</span>)</span><br><span class="line">                hiHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="12"><li>çº¢é»‘æ ‘å·¦æ—‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateLeft</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">    <span class="comment">//pä¸ä¸ºç©ºï¼Œpçš„å³å­èŠ‚ç‚¹(r)ä¸ä¸ºç©ºï¼Œå·¦æ—‹æ‰æœ‰æ„ä¹‰</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (r = p.right) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//pçš„å³å­èŠ‚ç‚¹è¿æ¥rçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((rl = p.right = r.left) != <span class="keyword">null</span>)</span><br><span class="line">            rl.parent = p;</span><br><span class="line">        <span class="comment">//å¦‚æœpæ˜¯rootï¼Œåˆ™æ—‹è½¬åræ˜¯rootï¼Œé¢œè‰²ä¸ºé»‘è‰²</span></span><br><span class="line">        <span class="keyword">if</span> ((pp = r.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = r).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼ŒræŒ‚åˆ°pçš„parent(pp)ä¸‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.left == p)</span><br><span class="line">            pp.left = r;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = r;</span><br><span class="line">        <span class="comment">//pæˆä¸ºrçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="13"><li>çº¢é»‘æ ‘å³æ—‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateRight</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">    <span class="comment">//lä¸ºpçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (l = p.left) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//lçš„å³å­èŠ‚ç‚¹æŒ‚è½½åˆ°pçš„å·¦å­èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> ((lr = p.left = l.right) != <span class="keyword">null</span>)</span><br><span class="line">            lr.parent = p;</span><br><span class="line">        <span class="comment">//å¦‚æœpæ˜¯rootèŠ‚ç‚¹ï¼Œæ—‹è½¬ålæ˜¯rootèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((pp = l.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = l).red = <span class="keyword">false</span>;<span class="comment">//rootä¸ºé»‘è‰²</span></span><br><span class="line">        <span class="comment">//å¦åˆ™å°†læŒ‚è½½åˆ°ppä¸‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.right == p)</span><br><span class="line">            pp.right = l;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.left = l;</span><br><span class="line">        <span class="comment">//pæˆä¸ºlçš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="14"><li>å¹³è¡¡æ’å…¥æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x)</span></span>&#123;</span><br><span class="line">     x.red = <span class="keyword">true</span>;<span class="comment">//æ–°æ’å…¥çš„èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">     <span class="comment">//ä¸€ç›´é‡å¤æ“ä½œï¼Œç›´åˆ°çº¢é»‘æ ‘å¹³è¡¡</span></span><br><span class="line">     <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">         <span class="comment">//å¦‚æœæ’å…¥çš„èŠ‚ç‚¹å°±æ˜¯root</span></span><br><span class="line">         <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">             x.red = <span class="keyword">false</span>;<span class="comment">//rootä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">return</span> x;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//å¦‚æœæ’å…¥çš„èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘èŠ‚ç‚¹ï¼Œæˆ–çˆ¶èŠ‚ç‚¹æ˜¯rootåˆ™æ— éœ€è°ƒæ•´ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">             <span class="keyword">return</span> root;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//å¦‚æœçˆ¶èŠ‚ç‚¹(xp)æ˜¯çº¢èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹(xpp)çš„å·¦å­èŠ‚ç‚¹(xppl)</span></span><br><span class="line">         <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">             <span class="comment">//å¦‚æœå”å”èŠ‚ç‚¹(çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹xppr)å­˜åœ¨ä¸”ä¸ºçº¢è‰²</span></span><br><span class="line">             <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                 xppr.red = <span class="keyword">false</span> <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                     xp.red = <span class="keyword">false</span>;  <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xpp.red = <span class="keyword">true</span>;  <span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                 x = xpp; <span class="comment">//å°†ç¥–çˆ¶èŠ‚ç‚¹è®¾ä¸ºæ’å…¥èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œæ’å…¥å¹³è¡¡æ“ä½œ</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">                 <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                     <span class="comment">//å¯¹æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                     root = rotateLeft(root, x = xp);</span><br><span class="line">                     xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹å°±æ— éœ€æ—‹è½¬</span></span><br><span class="line">                 <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     xp.red = <span class="keyword">false</span>;<span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                     <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         xpp.red = <span class="keyword">true</span>;<span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                         <span class="comment">//å¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹</span></span><br><span class="line">                         root = rotateRight(root, xpp);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//å¦‚æœçˆ¶èŠ‚ç‚¹(xp)æ˜¯çº¢èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹(xpp)çš„å³å­èŠ‚ç‚¹(xppr)</span></span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹å­˜åœ¨ä¸”ä¸ºçº¢è‰²</span></span><br><span class="line">             <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                 xppl.red = <span class="keyword">false</span>; <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xp.red = <span class="keyword">false</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xpp.red = <span class="keyword">true</span>;   <span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                 x = xpp; <span class="comment">//å°†ç¥–çˆ¶èŠ‚ç‚¹è®¾ä¸ºæ’å…¥èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œæ’å…¥å¹³è¡¡æ“ä½œ</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                 <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                     <span class="comment">//å°†çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹,ç„¶åè¿›è¡Œä¸‹é¢æ“ä½œ</span></span><br><span class="line">                     root = rotateRight(root, x = xp);</span><br><span class="line">                     xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                     xp.red = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         xpp.red = <span class="keyword">true</span>;<span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                         <span class="comment">//å¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                         root = rotateLeft(root, xpp);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="15"><li>å¹³è¡¡åˆ é™¤æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceDeletion</span><span class="params">(TreeNode&lt;K,V&gt; root,TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä¸€ç›´å¹³è¡¡ï¼Œç›´åˆ°å¹³è¡¡ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpl, xpr;;) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ›¿æ¢èŠ‚ç‚¹å°±æ˜¯rootæˆ–è€…nullï¼Œç›´æ¥è¿”å›root</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span> || x == root)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæ—¥æ¢èŠ‚ç‚¹æ˜¯rootèŠ‚ç‚¹ï¼Œé¢œè‰²è®¾ç½®ä¸ºé»‘è‰²ï¼Œè¿”å›æ›¿æ¢èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ›¿æ¢èŠ‚ç‚¹æ˜¯çº¢è‰²</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>; <span class="comment">//é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ›¿æ¢èŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹ï¼Œä¸”æ›¿æ¢èŠ‚ç‚¹ä½¿å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xpl = xp.left) == x) &#123;</span><br><span class="line">            <span class="comment">//æ›¿æ¢èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹(xpr)æ˜¯çº¢èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((xpr = xp.right) != <span class="keyword">null</span> &amp;&amp; xpr.red) &#123;</span><br><span class="line">                xpr.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼Ÿè®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">true</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                root = rotateLeft(root, xp); <span class="comment">//å°†PèŠ‚ç‚¹å·¦æ—‹</span></span><br><span class="line">                xpr = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœå…„å¼ŸèŠ‚ç‚¹ä¸ºnullï¼Œå°†çˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (xpr == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å­˜åœ¨ï¼Œä¸”ä¸ºé»‘è‰²</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½ä¸ºé»‘èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((sr == <span class="keyword">null</span> || !sr.red) &amp;&amp;</span><br><span class="line">                    (sl == <span class="keyword">null</span> || !sl.red)) &#123;</span><br><span class="line">                    xpr.red = <span class="keyword">true</span>; <span class="comment">// å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                    x = xp; <span class="comment">//å°†çˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼ˆå·¦å­èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (sr == <span class="keyword">null</span> || !sr.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sl != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        xpr.red = <span class="keyword">true</span>;     <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                        root = rotateRight(root, xpr); <span class="comment">//å¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œå³æ—‹</span></span><br><span class="line">                        xpr = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                            <span class="keyword">null</span> : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå·¦å­èŠ‚ç‚¹ä»»æ„</span></span><br><span class="line">                    <span class="keyword">if</span> (xpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„é¢œè‰²è®¾ä¸ºçˆ¶äº²èŠ‚ç‚¹çš„é¢œè‰²</span></span><br><span class="line">                        xpr.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = xpr.right) != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;<span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>; <span class="comment">//çˆ¶äº²èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        root = rotateLeft(root, xp);<span class="comment">//å¯¹çˆ¶äº²èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;<span class="comment">//ç»“æŸå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ›¿æ¢èŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹ï¼Œä¸”æ›¿æ¢èŠ‚ç‚¹ä½¿å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆæ“ä½œä¸ä¸Šä¸€ä¸ªIFæ˜¯å¯¹ç§°çš„ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å­˜åœ¨ä¸”æ˜¯çº¢è‰²</span></span><br><span class="line">            <span class="keyword">if</span> (xpl != <span class="keyword">null</span> &amp;&amp; xpl.red) &#123;</span><br><span class="line">                xpl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">true</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                root = rotateRight(root, xp); <span class="comment">//æŒ‰çˆ¶èŠ‚ç‚¹å³æ—‹</span></span><br><span class="line">                xpl = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹ä¸ºç©ºï¼Œå°±æŠŠçˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°å¹³è¡¡</span></span><br><span class="line">            <span class="keyword">if</span> (xpl == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…¨æ˜¯é»‘è‰²</span></span><br><span class="line">                <span class="keyword">if</span> ((sl == <span class="keyword">null</span> || !sl.red) &amp;&amp;</span><br><span class="line">                    (sr == <span class="keyword">null</span> || !sr.red)) &#123;</span><br><span class="line">                    xpl.red = <span class="keyword">true</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                    x = xp; <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å·¦å­èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼ˆå³å­èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (sl == <span class="keyword">null</span> || !sl.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å³å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        xpl.red = <span class="keyword">true</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                        root = rotateLeft(root, xpl);<span class="comment">//å¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                        xpl = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                            <span class="keyword">null</span> : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå³å­èŠ‚ç‚¹ä»»æ„</span></span><br><span class="line">                    <span class="keyword">if</span> (xpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å°†å…„å¼ŸèŠ‚ç‚¹é¢œè‰²è®¾ä¸ºçˆ¶èŠ‚ç‚¹é¢œè‰²</span></span><br><span class="line">                        xpl.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sl = xpl.left) != <span class="keyword">null</span>)z</span><br><span class="line">                            sl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å·¦å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>; <span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        root = rotateRight(root, xp); <span class="comment">//å¯¹çˆ¶èŠ‚ç‚¹å³æ—‹</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root; <span class="comment">//ç»“æŸå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="16"><li>çº¢é»‘æ ‘è‡ªæ£€<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">checkInvariants</span><span class="params">(TreeNode&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right,</span><br><span class="line">    tb = t.prev, tn = (TreeNode&lt;K,V&gt;)t.next;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å‰é©±èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ä¸æ˜¯tï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tb != <span class="keyword">null</span> &amp;&amp; tb.next != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„åç½®èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯tï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tn != <span class="keyword">null</span> &amp;&amp; tn.prev != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtä¸æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¹Ÿä¸æ˜¯å³å­èŠ‚ç‚¹ï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tp != <span class="keyword">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å·¦å­èŠ‚ç‚¹çš„çˆ¶äº²ä¸æ˜¯tï¼Œæˆ–å·¦å­èŠ‚ç‚¹hashå¤§äºtçš„hashï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å³å­èŠ‚ç‚¹çš„çˆ¶äº²ä¸æ˜¯tï¼Œæˆ–å³å­èŠ‚ç‚¹hashå°äºtçš„hashï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtæ˜¯çº¢è‰²ä½†å­èŠ‚ç‚¹è¿˜æ˜¯çº¢è‰²ï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="keyword">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="keyword">null</span> &amp;&amp; tr.red)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//é€’å½’æ£€æŸ¥å·¦å­æ ‘</span></span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tl))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//é€’å½’æ£€æŸ¥å³å­æ ‘</span></span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tr))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><h1 id="å››ã€å…¶ä»–æ–¹æ³•"><a href="#å››ã€å…¶ä»–æ–¹æ³•" class="headerlink" title="å››ã€å…¶ä»–æ–¹æ³•"></a>å››ã€å…¶ä»–æ–¹æ³•</h1><ol><li>Cloneæ–¹æ³•é‡å†™<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æµ…æ‹·è´</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HashMap&lt;K,V&gt; result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = (HashMap&lt;K,V&gt;)<span class="keyword">super</span>.clone();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="comment">// this shouldn't happen, since we are Cloneable</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e);</span><br><span class="line">    &#125;</span><br><span class="line">    result.reinitialize();</span><br><span class="line">    result.putMapEntries(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="2"><li>åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç›¸å…³æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These methods are also used when serializing HashSets</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">float</span> <span class="title">loadFactor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> loadFactor; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (table != <span class="keyword">null</span>) ? table.length :</span><br><span class="line">    (threshold &gt; <span class="number">0</span>) ? threshold :</span><br><span class="line">    DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buckets = capacity();</span><br><span class="line">    <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line">    s.writeInt(buckets);</span><br><span class="line">    s.writeInt(size);</span><br><span class="line">    internalWriteEntries(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal mappings count: "</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it's the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we're actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called only from writeObject, to ensure compatible ordering.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">internalWriteEntries</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                s.writeObject(e.key);</span><br><span class="line">                s.writeObject(e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reset to initial default state.  Called by clone and readObject.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reinitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    table = <span class="keyword">null</span>;</span><br><span class="line">    entrySet = <span class="keyword">null</span>;</span><br><span class="line">    keySet = <span class="keyword">null</span>;</span><br><span class="line">    values = <span class="keyword">null</span>;</span><br><span class="line">    modCount = <span class="number">0</span>;</span><br><span class="line">    threshold = <span class="number">0</span>;</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><ol start="3"><li>å›è°ƒæ–¹æ³•ï¼Œåœ¨HashMapä¸­æ— ä½œç”¨ï¼Œä¸ºLinkedHashMapåšé“ºå«<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Callbacks to allow LinkedHashMap post-actions</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></details></li></ol><p></p><p>æºç é˜…è¯».md<br>/2019/12/29/hashmap-source-learning/HashMap.txt</p>]]></content>
    
    <summary type="html">
    
      HashMapæºç å…¨è§£æã€‚æœ¬æ¬¡ä»¥Oracle JDK1.8ä½œä¸ºç¤ºä¾‹ï¼Œæ·±å…¥è§£è¯»HashMapå®ç°åŸç†ï¼Œç²¾ç»†é˜…è¯»æ¯ä¸€è¡Œæºç ï¼Œå¹¶ç»“åˆå„äº’è”ç½‘å‚å•†çš„å¸¸è§é¢è¯•é—®é¢˜ï¼Œå¯¹HashMapçš„å®ç°æ–¹æ¡ˆã€æ€æƒ³ä»¥åŠä½¿ç”¨æ³¨æ„äº‹é¡¹åšæ·±å…¥æ¢è®¨ã€‚
    
    </summary>
    
      <category term="Java" scheme="http://blog.zjee.ml/categories/Java/"/>
    
    
      <category term="Javaæºç " scheme="http://blog.zjee.ml/tags/Java%E6%BA%90%E7%A0%81/"/>
    
      <category term="HashMap" scheme="http://blog.zjee.ml/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>JavaåŸºæœ¬ç±»å‹ä¸åŒ…è£…ç±»å‹</title>
    <link href="http://blog.zjee.ml/2019/11/19/java-primitive-and-wrapper-type/"/>
    <id>http://blog.zjee.ml/2019/11/19/java-primitive-and-wrapper-type/</id>
    <published>2019-11-19T09:06:49.000Z</published>
    <updated>2019-11-19T09:06:49.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€Javaä¸­çš„æ•°æ®ç±»å‹"><a href="#ä¸€ã€Javaä¸­çš„æ•°æ®ç±»å‹" class="headerlink" title="ä¸€ã€Javaä¸­çš„æ•°æ®ç±»å‹"></a>ä¸€ã€Javaä¸­çš„æ•°æ®ç±»å‹</h3><p>ç†Ÿæ‚‰Javaçš„æœ‹å‹éƒ½çŸ¥é“Javaä¸­çš„æ•°æ®ç±»å‹åˆ†ä¸º<strong>åŸºæœ¬ç±»å‹</strong>å’Œ<strong>å¼•ç”¨ç±»å‹</strong>ï¼ŒåŸºæœ¬ç±»å‹å°±æ˜¯æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„<code>int</code>ï¼Œ<code>long</code>ç­‰ï¼Œå¼•ç”¨ç±»å‹å°±æ˜¯ç”¨classå®šä¹‰å‡ºæ¥çš„ç±»å‹ï¼Œå¦‚<code>String</code>ã€<code>HashMap</code>ç­‰ã€‚Javaä¸­æœ‰8ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå®ƒä»¬åŒæ—¶éƒ½å¯¹åº”ä¸€ä¸ªå¼•ç”¨æ•°æ®ç±»å‹ï¼ˆåˆç§°<strong>åŒ…è£…ç±»å‹</strong>ï¼‰ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">åŸºæœ¬ç±»å‹</th><th style="text-align:center">å ç”¨ç©ºé—´</th><th style="text-align:center">å–å€¼èŒƒå›´</th><th style="text-align:center">åŒ…è£…ç±»å‹</th></tr></thead><tbody><tr><td style="text-align:center">byte</td><td style="text-align:center">1B</td><td style="text-align:center">$-2^{7}$ ~ $2^{7}-1$</td><td style="text-align:center">java.lang.Byte</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">2B (unicode)</td><td style="text-align:center">$0$ ~ $2^{16}-1$</td><td style="text-align:center">java.lang.Character</td></tr><tr><td style="text-align:center">short</td><td style="text-align:center">2B</td><td style="text-align:center">$-2^{15}$ ~ $2^{15}-1$</td><td style="text-align:center">java.lang.Short</td></tr><tr><td style="text-align:center">int</td><td style="text-align:center">4B</td><td style="text-align:center">$-2^{31}$ ~ ${2^{31}-1}$</td><td style="text-align:center">java.lang.Integer</td></tr><tr><td style="text-align:center">long</td><td style="text-align:center">8B</td><td style="text-align:center">$-2^{63}$ ~ $2^{63}-1$</td><td style="text-align:center">java.lang.Long</td></tr><tr><td style="text-align:center">float</td><td style="text-align:center">4B</td><td style="text-align:center">å‚è§<a href="https://zh.wikipedia.org/wiki/IEEE_754" target="_blank" rel="noopener">IEEE754</a></td><td style="text-align:center">java.lang.Float</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">8B</td><td style="text-align:center">å‚è§<a href="https://zh.wikipedia.org/wiki/IEEE_754" target="_blank" rel="noopener">IEEE754</a></td><td style="text-align:center">java.lang.Double</td></tr><tr><td style="text-align:center">boolean</td><td style="text-align:center">1B</td><td style="text-align:center">${True, False}$</td><td style="text-align:center">java.lang.Boolean</td></tr></tbody></table><h3 id="äºŒã€è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"><a href="#äºŒã€è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±" class="headerlink" title="äºŒã€è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"></a>äºŒã€è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±</h3><p>Javaæ˜¯ä¸€ä¸ªçº¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œä¸ºäº†è®©åŸºæœ¬æ•°æ®ç±»å‹ä¹Ÿæ‹¥æœ‰å¼•ç”¨ç±»å‹çš„ç‰¹å¾ï¼ˆæ¯”å¦‚å–nullå€¼ï¼‰ï¼ŒJavaå·¥ç¨‹å¸ˆç‰¹æ„ä¸ºä»–ä»¬è®¾è®¡äº†åŒ…è£…ç±»å‹ã€‚åŒ…è£…ç±»å‹ç®€å•æ¥è¯´å°±æ˜¯ç”¨ä¸€ä¸ªclasså£°æ˜çš„ç±»å°†åŸºæœ¬ç±»å‹åŒ…è£…äº†ä¸€ä¸‹ï¼Œå¹¶é™„å¸¦äº†å¾ˆå¤šå¸¸ç”¨å·¥å…·ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½æŒ‰é¢å‘å¯¹è±¡çš„æ–¹å¼å»ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹äº†ã€‚ä¸‹é¢æ˜¯Integerç±»çš„éƒ¨åˆ†æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Integer</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_VALUE = -<span class="number">2147483648</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_VALUE = <span class="number">2147483647</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ ¸å¿ƒå†…å®¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•    </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Integer</span><span class="params">(<span class="keyword">int</span> var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = var1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è£…ç®±æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> var0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var0 &gt;= -<span class="number">128</span> &amp;&amp; var0 &lt;= Integer.IntegerCache.high ?                      Integer.IntegerCache.cache[var0 + <span class="number">128</span>] : <span class="keyword">new</span> Integer(var0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹†ç®±æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">intValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Integerç¼“å­˜</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerCache</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> low = -<span class="number">128</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> high;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Integer cache[];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="comment">// high value may be configured by property</span></span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">127</span>;</span><br><span class="line">            String integerCacheHighPropValue =</span><br><span class="line">                sun.misc.VM.getSavedProperty(<span class="string">"java.lang.Integer.IntegerCache.high"</span>);</span><br><span class="line">            <span class="keyword">if</span> (integerCacheHighPropValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = parseInt(integerCacheHighPropValue);</span><br><span class="line">                    i = Math.max(i, <span class="number">127</span>);</span><br><span class="line">                    <span class="comment">// Maximum array size is Integer.MAX_VALUE</span></span><br><span class="line">                    h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span>( NumberFormatException nfe) &#123;</span><br><span class="line">                    <span class="comment">// If the property cannot be parsed into an int, ignore it.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            high = h;</span><br><span class="line">            cache = <span class="keyword">new</span> Integer[(high - low) + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> j = low;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; cache.length; k++)</span><br><span class="line">                cache[k] = <span class="keyword">new</span> Integer(j++);</span><br><span class="line">            <span class="comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span></span><br><span class="line">            <span class="keyword">assert</span> IntegerCache.high &gt;= <span class="number">127</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">IntegerCache</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»æºç ä¸­å¯ä»¥çœ‹åˆ°åŒ…è£…ç±»å‹ä¸­ä¿å­˜æ•°æ®çš„æ ¸å¿ƒæˆå‘˜å˜é‡å°±æ˜¯<code>value</code>ï¼Œæ‰€æœ‰å¯¹åŒ…è£…ç±»å‹çš„æ“ä½œæœ€ç»ˆéƒ½åæ˜ åˆ°valueå­—æ®µä¸Šã€‚åŒ…è£…ç±»å‹ä¸­çš„<code>valueOf</code>æ–¹æ³•ï¼ˆæœ‰å¤šç§é‡è½½ï¼‰å°±æ˜¯å¸¸è¯´çš„è£…ç®±æ–¹æ³•ï¼Œä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥å°†ä¸€ä¸ªåŸºæœ¬ç±»å‹å˜é‡è½¬å˜ä¸ºåŒ…è£…ç±»å‹ï¼Œå¦‚<code>Integer a = Integer.valueOf(2);</code>ã€‚åŒæ ·ï¼Œ<code>intValue</code>æ–¹æ³•ï¼ˆæœ‰å¤šç§å˜å½¢ï¼Œå¦‚<code>longValue</code>ã€<code>charValue</code>ç­‰ï¼‰å°±æ˜¯æ‹†ç®±æ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†åŒ…è£…ç±»å‹è½¬å˜ä¸ºåŸºæœ¬ç±»å‹ï¼Œå¦‚<code>int b = a.intValue();</code> ã€‚æ—©æœŸçš„Javaä¸­åŸºæœ¬ç±»å‹ä¸åŒ…è£…ç±»å‹çš„è½¬æ¢æ˜¯éœ€è¦å¼€å‘äººå‘˜æ‰‹å·¥å»è°ƒç”¨æ–¹æ³•å®ç°çš„ï¼Œè‡ªJDK 5.0å¼€å‘ï¼ŒJavaå¼•å…¥äº†è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±æœºåˆ¶ï¼Œæå¤§çš„æ–¹ä¾¿äº†å¼€å‘äººå‘˜ï¼Œè‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±ç®€å•è¯´å°±æ˜¯JVMè‡ªåŠ¨å»è°ƒç”¨<code>valueOf</code>å’Œ<code>intValue</code>æ–¹æ³•ï¼Œäºæ˜¯æˆ‘ä»¬çš„ä»£ç å°±å¯ä»¥è¿™æ ·å†™äº†<code>int a = new Integer(1); Integer b = 4;</code>ã€‚</p><h4 id="é—®é¢˜æ‹“å±•"><a href="#é—®é¢˜æ‹“å±•" class="headerlink" title="é—®é¢˜æ‹“å±•"></a>é—®é¢˜æ‹“å±•</h4><p>æˆ‘ä»¬çŸ¥é“åœ¨C/C++ä¸­å†™ä¸€ä¸ªå¯ä»¥äº¤æ¢ä¸¤ä¸ªintå˜é‡å€¼çš„å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œé‚£åœ¨Javaä¸­æ€ä¹ˆå®ç°è¿™æ ·ä¸€ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//C(é€šè¿‡æŒ‡é’ˆäº¤æ¢)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>* a, <span class="keyword">int</span>* b)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> c = *a;</span><br><span class="line">*a = *b;</span><br><span class="line">*b = c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//C++(é€šè¿‡å¼•ç”¨äº¤æ¢)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">int</span>&amp; b)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> c = a;</span><br><span class="line">a = b;</span><br><span class="line">b = c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaä¸­æ²¡æœ‰æŒ‡é’ˆï¼Œä½†æœ‰å¯¹è±¡å¼•ç”¨ï¼ˆä¸C/C++ä¸­çš„æŒ‡é’ˆæ¦‚å¿µç±»ä¼¼ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ­¤æ¦‚å¿µå®ç°åŒæ ·çš„åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Integer a = <span class="keyword">new</span> Integer(<span class="number">1</span>); <span class="comment">//ä¸èƒ½ç”¨è‡ªåŠ¨è£…ç®±</span></span><br><span class="line">        Integer b = <span class="keyword">new</span> Integer(<span class="number">2</span>); <span class="comment">//ä¸èƒ½ç”¨è‡ªåŠ¨è£…ç®±</span></span><br><span class="line">        swap(a, b);</span><br><span class="line">        System.out.println(<span class="string">"a="</span>+a+<span class="string">", b="</span>+b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swapa</span><span class="params">(Integer a, Integer b)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = a;<span class="comment">//æš‚å­˜açš„å€¼(ä½¿ç”¨è‡ªåŠ¨æ‹†ç®±)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//é€šè¿‡åå°„çš„æ–¹å¼å¼ºè¡Œæ›´æ”¹value</span></span><br><span class="line">        Field field = a.getClass().getDeclaredField(<span class="string">"value"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(a, b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€šè¿‡åå°„çš„æ–¹å¼å¼ºè¡Œæ›´æ”¹value</span></span><br><span class="line">        field = b.getClass().getDeclaredField(<span class="string">"value"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(b, c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¾“å‡ºï¼ša=2, b=1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å¯ä»¥å®ç°å€¼çš„äº¤æ¢ï¼Œä½†å­˜åœ¨ä¸€äº›é™åˆ¶ï¼š</p><ol><li>å®å‚å’Œå½¢å‚éƒ½å¿…é¡»æ˜¯åŒ…è£…ç±»å‹ï¼Œå› ä¸ºåªæœ‰åŒ…è£…ç±»å‹ä¼ å‚æ—¶æ˜¯ä¼ å¼•ç”¨ï¼ˆç›¸å½“ä¸C/C++ä¸­çš„æŒ‡é’ˆï¼‰ã€‚</li><li><span style="color:red;">å®å‚ä¸èƒ½ä½¿ç”¨è‡ªåŠ¨è£…ç®±ç”Ÿæˆï¼Œå¦‚<code>Integer a = 100;</code>ã€‚</span></li><li>æ•ˆç‡ä¸é«˜ã€‚</li></ol><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨è‡ªåŠ¨è£…ç®±ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹è‡ªåŠ¨è£…ç®±çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> var0)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> var0 &gt;= -<span class="number">128</span> &amp;&amp; var0 &lt;= Integer.IntegerCache.high ?                      Integer.IntegerCache.cache[var0 + <span class="number">128</span>] : <span class="keyword">new</span> Integer(var0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°å¦‚æœè‡ªåŠ¨è£…ç®±çš„å€¼åœ¨<code>[-128, high]</code>ï¼ˆ<code>highâˆˆ[127, Integer.MAX_VALUE-129]</code>ï¼‰,å°±ä¼šè¿”å›<code>Integer.IntegerCache.cache[var0 + 128]</code>è¿™æ ·ä¸€ä¸ªå€¼ï¼Œå…¶ä¸­çš„<code>Integer.IntegerCache.cache</code>å°±æ˜¯æˆ‘ä»¬æåˆ°çš„<strong>ç¼“å­˜</strong>ï¼Œåœ¨Integerä¸­ç¼“å­˜é»˜è®¤èŒƒå›´æ˜¯[-128ï¼Œ 127]ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªèŒƒå›´ç±»çš„æ•°å­—å¯¹åº”çš„åŒ…è£…å¯¹è±¡åœ¨åŠ è½½Integerç±»çš„æ—¶å€™éƒ½å·²ç»ç”Ÿæˆå¥½äº†ï¼Œä»¥åè°è¦é‡‡ç”¨è‡ªåŠ¨è£…ç®±è·å–Integerå¯¹è±¡ï¼Œåªè¦å€¼åœ¨ç¼“å­˜èŒƒå›´å†…ï¼Œå°±ç›´æ¥è¿”å›ç¼“å­˜å¯¹è±¡å³å¯ã€‚</p><p>åœ¨ä¸Šé¢çš„swapç¤ºä¾‹ä¸­ï¼Œå¦‚æœä¼ å…¥çš„å®å‚æ˜¯é‡‡ç”¨è‡ªåŠ¨è£…ç®±ç”Ÿæˆçš„ï¼Œä¸”æ•°å€¼èŒƒå›´åœ¨ç¼“å­˜èŒƒå›´å†…ï¼Œå°±ä¼šå°†<strong>ç¼“å­˜çš„å¼•ç”¨</strong>ä¼ å…¥swapæ–¹æ³•ä¸­ï¼Œç„¶åç”¨<strong>åå°„ä¿®æ”¹çš„å°±æ˜¯è¿™äº›ç¼“å­˜çš„å€¼</strong>ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬æœ€åˆçš„é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ¥ç€ä¼šå¸¦æ¥æ›´å¤§çš„éº»çƒ¦ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Integer a = <span class="number">1</span>;</span><br><span class="line">        Integer b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        swap(a, b);</span><br><span class="line">        System.out.println(<span class="string">"a="</span>+a+<span class="string">", b="</span>+b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//!!! Big trouble !!!</span></span><br><span class="line">        System.out.println(<span class="string">"Integer.valueOf(1) = "</span> + Integer.valueOf(<span class="number">1</span>)); <span class="comment">//ç¼“å­˜è¢«ä¿®æ”¹äº†</span></span><br><span class="line">        System.out.println(<span class="string">"(Integer)2 = "</span> + (Integer)<span class="number">2</span>);<span class="comment">//ç¼“å­˜è¢«ä¿®æ”¹äº†</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Integer a, Integer b)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Integer c = <span class="keyword">new</span> Integer(a); <span class="comment">//åŸå§‹å€¼è¿›è¡Œæ·±åº¦æ‹·è´</span></span><br><span class="line"></span><br><span class="line">        Field field = a.getClass().getDeclaredField(<span class="string">"value"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(a, b);</span><br><span class="line"></span><br><span class="line">        field = b.getClass().getDeclaredField(<span class="string">"value"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(b, c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment">* a=2, b=1</span></span><br><span class="line"><span class="comment">* Integer.valueOf(1) = 2</span></span><br><span class="line"><span class="comment">* (Integer)2 = 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>â˜  æˆ‘ä»¬çœ‹åˆ°ç”±äºç›´æ¥ä¿®æ”¹äº†<code>1</code>å’Œ<code>2</code>ç¼“å­˜ï¼Œåç»­æ‰€æœ‰ç”¨åˆ°è¿™ä¸¤ä¸ªç¼“å­˜çš„å€¼å°†å…¨éƒ¨å‡ºé”™ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå±é™©çš„è¡Œä¸ºã€‚</p><p><strong><em>å¿ å‘Š</em></strong>ï¼šåœ¨javaä¸­ä¸Šè¯‰ä¸¤ç§äº¤æ¢å€¼çš„æ–¹å¼è¯·éƒ½<strong>ä¸è¦ä½¿ç”¨</strong>ï¼Œå¦‚æœæœ‰æ­¤ç±»éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹æ–¹æ¡ˆï¼š</p><ul><li>ä¸ä½¿ç”¨æ–¹æ³•ï¼Œç›´æ¥å°±åœ°è§£å†³ã€‚</li><li>ä½¿ç”¨æ–¹æ³•ï¼ŒæŠŠåŸå§‹ä¸¤ä¸ªå‚æ•°åˆå¹¶æˆlistæˆ–æ•°ç»„ä¼ å…¥swapæ–¹æ³•</li><li>ä½¿ç”¨æ–¹æ³•ï¼ŒæŠŠåŸå§‹æ•°æ®åŒ…è£…è¿›ä¸€ä¸ªå¯¹è±¡ä¸­ä¼ å…¥swapæ–¹æ³•</li></ul><h3 id="ä¸‰ã€JavaåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜"><a href="#ä¸‰ã€JavaåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜" class="headerlink" title="ä¸‰ã€JavaåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜"></a>ä¸‰ã€JavaåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜</h3><p>åœ¨Java5ä¸­ï¼Œä¸ºèŠ‚çœå†…å­˜æé«˜æ€§èƒ½ï¼Œé™¤Floatå’ŒDoubleä¹‹å¤–ï¼Œæ‰€æœ‰åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»å‹éƒ½å¼•å…¥äº†ç¼“å­˜ï¼Œä¸€èˆ¬ç¼“å­˜[-128, 127]ï¼ˆCharactoræ˜¯[0, 127]ï¼‰ä¹‹é—´çš„æ‰€æœ‰åŒ…è£…ç±»å¯¹è±¡ã€‚è¿™äº›ç¼“å­˜åœ¨å¯¹åº”ç±»åŠ è½½çš„æ—¶å€™éƒ½å®Œæˆäº†åˆå§‹åŒ–ï¼Œåç»­ä½¿ç”¨æ—¶å¦‚æœç”¨åˆ°è‡ªåŠ¨è£…ç®±ä¸”æ•°å€¼åœ¨ç¼“å­˜èŒƒå›´å†…ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜å¯¹è±¡ã€‚</p><p>Integerçš„ç¼“å­˜èŒƒå›´ä¸Šç•Œæ˜¯å¯è°ƒæ•´çš„ï¼ˆä¹Ÿæ˜¯å”¯ä¸€å¯è°ƒèŒƒå›´çš„ç±»å‹ï¼‰ï¼Œåœ¨JVMå¯åŠ¨å‚æ•°ä¸­åŠ å…¥<code>-XX:AutoBoxCacheMax=&lt;size&gt;</code>è°ƒæ•´Integerç¼“å­˜èŒƒå›´ã€‚å…¶ä¸­<code>size</code>çš„å¯å–èŒƒå›´æ˜¯[127, 2147483518]ï¼Œå¦‚æœä¸åœ¨æ­¤èŒƒå›´å°±å–è¯¥èŒƒå›´çš„è¾¹ç•Œå€¼ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Integer a = <span class="number">100</span>; <span class="comment">//use cache</span></span><br><span class="line">Integer b = Integer.valueOf(-<span class="number">128</span>); <span class="comment">//use cache</span></span><br><span class="line">Integer c = Integer.valueOf(<span class="string">"23"</span>); <span class="comment">//use cache</span></span><br><span class="line">Integer d = <span class="keyword">new</span> Integer(<span class="number">23</span>);<span class="comment">// not use cache</span></span><br><span class="line">Integer e = <span class="number">7367</span>; <span class="comment">//not use cache by default</span></span><br></pre></td></tr></table></figure><h3 id="å››ã€å»¶ç”³æ€è€ƒ"><a href="#å››ã€å»¶ç”³æ€è€ƒ" class="headerlink" title="å››ã€å»¶ç”³æ€è€ƒ"></a>å››ã€å»¶ç”³æ€è€ƒ</h3><h4 id="4-1-æ–¹æ³•é‡è½½ä¼˜å…ˆçº§"><a href="#4-1-æ–¹æ³•é‡è½½ä¼˜å…ˆçº§" class="headerlink" title="4.1 æ–¹æ³•é‡è½½ä¼˜å…ˆçº§"></a>4.1 æ–¹æ³•é‡è½½ä¼˜å…ˆçº§</h4><p>é—®é¢˜å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;&#125; <span class="comment">//m1</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Integer a, <span class="keyword">int</span> b)</span></span>&#123;&#125; <span class="comment">//m2</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> a, Integer b)</span></span>&#123;&#125; <span class="comment">//m3</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Integer a, Integer b)</span></span>&#123;&#125; <span class="comment">//m4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨</span></span><br><span class="line">swap(<span class="number">2</span>, <span class="number">3</span>); <span class="comment">//è°ƒç”¨m1</span></span><br><span class="line">swap((Integer)<span class="number">2</span>, <span class="number">3</span>); <span class="comment">//è°ƒç”¨m2</span></span><br><span class="line">swap((Integer)<span class="number">2</span>, (Integer)<span class="number">3</span>); <span class="comment">//è°ƒç”¨m4</span></span><br></pre></td></tr></table></figure><p>javaåœ¨é‡è½½çš„æ—¶å€™ä¼˜å…ˆæŒ‰ç›¸åŒç±»å‹ç²¾ç¡®åŒ¹é…ï¼Œå½“åŒ¹é…ä¸ä¸Šæ—¶å†å°è¯•åŒ…è£…ç±»å‹ï¼Œä½†æ˜¯å°†åŒ…è£…ç±»å‹å’ŒåŸºæœ¬ç±»å‹æ··ç”¨æ—¶æ—§éœ€è¦æ˜ç¡®æŒ‡å®šç±»å‹ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> a, Integer b)</span></span>&#123;&#125; <span class="comment">//m3</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Integer a, Integer b)</span></span>&#123;&#125; <span class="comment">//m4</span></span><br><span class="line"></span><br><span class="line">swap(<span class="number">2</span>, <span class="number">3</span>); <span class="comment">// compile error</span></span><br><span class="line">swap((Integer)<span class="number">2</span>, <span class="number">3</span>); <span class="comment">// compile error</span></span><br><span class="line">swap((Integer)<span class="number">2</span>, (Integer)<span class="number">3</span>); <span class="comment">//m4 ok</span></span><br><span class="line">swap(<span class="number">3</span>, (Integer)<span class="number">4</span>);<span class="comment">//m3 ok</span></span><br></pre></td></tr></table></figure><h4 id="4-2æ³›å‹"><a href="#4-2æ³›å‹" class="headerlink" title="4.2æ³›å‹"></a>4.2æ³›å‹</h4><p>javaä¸­æ³›å‹ä¸æ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹ï¼Œå³<code>int</code>,<code>float</code>è¿™æ ·çš„ï¼Œä½†æ•°ç»„æ˜¯ä¸ªä¾‹å¤–ï¼Œæ•°æ®åœ¨javaä¸­æ˜¯ä¸ªå¯¹è±¡ï¼Œä¸è¿‡è¿™ä¸ªå¯¹è±¡æ²¡æœ‰æ˜ç¡®çš„classï¼Œæˆ‘ä»¬å¯åƒæ“ä½œå¯¹è±¡ä¸€æ ·æ“ä½œæ•°ç»„ï¼Œæ‰€ä»¥æ³›å‹æ˜¯å¯ä»¥æ¥æ”¶æ•°ç»„çš„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list1 = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// ok</span></span><br><span class="line">List&lt;<span class="keyword">int</span>[]&gt; list2 = <span class="keyword">new</span> ArrayList&lt;&gt;();   <span class="comment">// also ok</span></span><br><span class="line">List&lt;<span class="keyword">int</span>&gt; list3 = <span class="keyword">new</span> ArrayList&lt;&gt;();     <span class="comment">// compile error</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æœ‰ä¸€ä¸ªæ•°ç»„è½¬Listçš„å·¥å…·ç”¨çš„ç‰¹åˆ«å¤šï¼Œå®ƒå°±æ˜¯<code>Arrays.asList(T... a)</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶å¯å˜å‚æ•°ï¼Œæˆ‘ä»¬çŸ¥é“å¯å˜å‚æ•°å¯ä»¥ä¼ å¤šä¸ªå‚æ•°æˆ–ä¸€ä¸ªæ•°ç»„ï¼Œå½“ä¼ æ•°ç»„çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œæ³›å‹ä¼šå°†int[]è§†ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œä¼ <code>new Integer[]{1,2,3}</code>ä¸<code>new int[]{1,2,3}</code>æ˜¯ä¸ä¸€æ ·çš„ã€‚å¯¹äºå‰è€…æ¥è¯´ï¼Œç›¸å½“äºä¼ å…¥3ä¸ª<code>Integer</code>å‚æ•°ï¼Œæœ€åæ¥æ”¶æ–¹æ”¶åˆ°çš„å‚æ•°é•¿åº¦ä¸º3ã€‚è€Œåè€…ç›¸å½“äºä¼ å…¥ä¸€ä¸ªç±»å‹ä¸º<code>int[]</code>çš„å‚æ•°ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°çš„å‚æ•°é•¿åº¦ä¸º1ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨<code>Arrays.asList</code>çš„æ—¶å€™è¦ç‰¹åˆ«æ³¨æ„ç”¨åŒ…è£…ç±»å‹è€Œä¸æ˜¯åŸºæœ¬ç±»å‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      ç”¨äº†å¾ˆä¹…çš„Javaï¼Œå¶ç„¶é—²è°ˆä¸­æ‰å‘ç°è‡ªå·±ç«Ÿç„¶è¯´ä¸æ˜ç™½Javaçš„åŸºæœ¬ç±»å‹ä¸åŒ…è£…ç±»å‹çš„å…³ç³»ï¼Œæ·±æ„Ÿæ„§ç–šï¼Œä¾¿å†™ä¸‹æ­¤ç¯‡æ–‡ç« ï¼Œç»™è‡ªå·±é•¿ä¸ªè®°æ€§ã€‚æœ¬æ–‡æ¶‰åŠçš„å†…å®¹ï¼šJavaåŸºæœ¬ç±»å‹ä¸åŒ…è£…ç±»å‹çš„åŒºåˆ«åŠè”ç³»ã€è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±ã€åŒ…è£…ç±»å‹ç¼“å­˜åŠå…¶å®ƒé—®é¢˜çš„æ€è€ƒã€‚
    
    </summary>
    
      <category term="Java" scheme="http://blog.zjee.ml/categories/Java/"/>
    
    
      <category term="Java" scheme="http://blog.zjee.ml/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Javaä¸­çš„åŒæ­¥ã€äº’æ–¥æœºåˆ¶</title>
    <link href="http://blog.zjee.ml/2019/08/24/java-lock-util/"/>
    <id>http://blog.zjee.ml/2019/08/24/java-lock-util/</id>
    <published>2019-08-23T16:00:00.000Z</published>
    <updated>2019-08-23T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Javaå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼ŒåŒæ­¥å’Œäº’æ–¥æ˜¯ä¸€ä¸ªä¸å¯é¿å…çš„è¯é¢˜ã€‚Javaä¸ºå¼€å‘äººå‘˜æä¾›äº†ä»¥ä¸‹å‡ ç§é”æœºåˆ¶ï¼š</p><ol><li><code>synchronized</code>å…³é”®å­—</li><li><code>Lock</code>æ¥å£</li><li><code>ReadWriteLock</code>æ¥å£</li></ol><p>è¿™å‡ ç§é”æœºåˆ¶åœ¨æ—¥å¸¸ç¼–ç¨‹ä¸­ç”¨çš„å¾ˆå¤šï¼Œä½†å®ƒä»¬æœ‰ä»€ä¹ˆè”ç³»å’ŒåŒºåˆ«å‘¢ï¼Ÿ</p><h3 id="ä¸€ã€Synchronized"><a href="#ä¸€ã€Synchronized" class="headerlink" title="ä¸€ã€Synchronized"></a>ä¸€ã€Synchronized</h3><ol><li><p><code>synchronized</code>å…³é”®å­—æ˜¯Javaå†…ç½®çš„å…³é”®å­—ï¼Œå¯ä»¥è½»æ¾å®ç°ä¸´ç•ŒåŒºèµ„æºçš„åŒæ­¥äº’æ–¥è®¿é—®ã€‚synchronizedå…³é”®å­—ä½¿ç”¨å¾ˆç®€å•ï¼Œå¯ä»¥åŠ åœ¨æ–¹æ³•ä¸Šæˆ–ä»£ç å—ä¸Šï¼Œç”¨åœ¨æ–¹æ³•å£°æ˜ä¸­è¡¨ç¤ºæ•´ä¸ªæ–¹æ³•è°ƒç”¨æ˜¯äº’æ–¥çš„ï¼Œç”¨åœ¨ä»£ç å—ä¸Šè¡¨ç¤ºè¢«åŒ…å›´çš„ä»£ç æ‰§è¡Œæ˜¯äº’æ–¥çš„ï¼Œç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//synchronize ç”¨åœ¨ä»£ç å—ä¸Šï¼Œè¡¨ç¤ºè¯¥ä»£ç å—äº’æ–¥</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; </span><br><span class="line">        resource -- ;</span><br><span class="line">        System.out.println(<span class="string">" resource: "</span> + resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">//synchronizeç”¨åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºæ•´ä¸ªæ–¹æ³•è°ƒç”¨äº’æ–¥</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">consumer2</span><span class="params">()</span></span>&#123; </span><br><span class="line">    resource -- ;</span><br><span class="line">    System.out.println(<span class="string">"resource: "</span> + resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//synchronizeç”¨åœ¨é™æ€æ–¹æ³•ä¸Šï¼Œä½¿ç”¨Classå¯¹è±¡ä½œä¸ºå¯¹è±¡é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">consumer3</span><span class="params">()</span></span>&#123; </span><br><span class="line">    resource -- ;</span><br><span class="line">    System.out.println(<span class="string">"resource: "</span> + resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>synchronized</code>å…³é”®å­—éœ€è¦ä¸€ä¸ª<strong>é”å¯¹è±¡</strong>,å½“ä»£ç æ‰§è¡Œåˆ°synchronizedä¿®é¥°çš„æ–¹æ³•æˆ–åŒ…å›´çš„ä»£ç å—æ—¶å°±ä¼šè·å–è¯¥é”å¯¹è±¡çš„é”ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è·å–é”å¯¹è±¡çš„ç›‘è§†å™¨(monitorï¼Œå¯ä»¥ç†è§£ä¸ºé”æ ‡è®°)ï¼Œå¦‚æœè·å–åˆ°é”å°±ç»§ç»­æ‰§è¡Œä¸´ç•ŒåŒºä»£ç ï¼Œå¦åˆ™å°±ä¸€ç›´ç­‰å¾…ã€‚å¦‚æœ<code>synchronized</code>ä¿®é¥°çš„æ˜¯ä¸€ä¸ª<strong>éé™æ€</strong>æ–¹æ³•ï¼Œé‚£ä¹ˆé”å¯¹è±¡å°±æ˜¯è¿™ä¸ª<strong>å¯¹è±¡æœ¬èº«</strong>ï¼›å¦‚æœ<code>synchronized</code>ä¿®é¥°çš„æ˜¯ä¸€ä¸ª<strong>é™æ€</strong>æ–¹æ³•ï¼Œé‚£ä¹ˆé”å¯¹è±¡å°±æ˜¯è¿™ä¸ª<strong>ç±»å¯¹è±¡</strong>ã€‚åŒç†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨synchronizedä»£ç å—æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªé”å¯¹è±¡ï¼Œä¸€èˆ¬å¯ç”¨<code>this</code>è¡¨ç¤ºä½¿ç”¨å¯¹è±¡æœ¬èº«ä½œä¸ºé”å¯¹è±¡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–è‡ªå®šä¹‰å¯¹è±¡ï¼Œæ¯”å¦‚ <code>new Object()</code>ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¸è¦ä½¿ç”¨<code>String</code>æˆ–å¸¸ç”¨çš„æ•°å­—å¯¹è±¡å»ä½œä¸ºé”å¯¹è±¡ï¼Œå› ä¸ºä»–ä»¬åœ¨JVMç¼“å­˜åœ¨ä¸€ä¸ªå¸¸é‡æ± ä¸­ï¼Œæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå¦‚æœå¤šå¤„ä½¿ç”¨è¿™äº›å¯¹è±¡ä½œä¸ºé”å¯¹è±¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸å¯é¢„æœŸçš„æ­»é”ã€‚</p></li><li><p><strong>å¯é‡å…¥</strong>æ˜¯é”çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–è·å–å®ƒ<strong><em>å·²ç»æ‹¥æœ‰çš„é”</em></strong>ï¼Œå¦‚æœå¯ä»¥è·å–åˆ°åˆ™è¡¨ç¤ºè¯¥é”æ˜¯<strong>å¯é‡å…¥</strong>çš„ï¼Œå¦åˆ™å°±æ˜¯<strong>ä¸å¯é‡å…¥</strong>çš„ã€‚<code>synchronized</code>æ˜¯<strong>å¯é‡å…¥</strong>çš„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> resource = <span class="number">100</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        test.consumer1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consumer1</span><span class="params">()</span> </span>&#123; <span class="comment">//ç¬¬ä¸€æ¬¡è·å–é”</span></span><br><span class="line">        resource--;</span><br><span class="line">        System.out.println(<span class="string">"consumer1: "</span> + resource);</span><br><span class="line">        <span class="keyword">this</span>.consumer2(); <span class="comment">//è°ƒç”¨å¦å¤–ä¸€ä¸ªsynchronizedä¿®é¥°çš„æ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consumer2</span><span class="params">()</span> </span>&#123; <span class="comment">//ç¬¬äºŒæ¬¡è·å–é”</span></span><br><span class="line">        resource--;</span><br><span class="line">        System.out.println(<span class="string">"consumer2: "</span> + resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"> * consumer1: 99</span></span><br><span class="line"><span class="comment"> * consumer2: 98</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></li><li><p><code>synchronized</code>æ˜¯<strong>ä¸å¯ä¸­æ–­</strong>çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å› è·å–ä¸åˆ°é”è€Œè¿›å…¥é˜»å¡çŠ¶æ€æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å°±ä¸€ç›´ä¼šé˜»å¡ä¸‹å»ï¼Œä¸ä¼šå“åº”å¤–ç•Œçš„ä¸­æ–­ä¿¡å·ï¼Œè¿™ä¹Ÿæ˜¯synchronizeçš„æœ€å¤§ç¼ºé™·ã€‚</p></li><li><p>æ€»ç»“ï¼š</p><ul><li>synchronizedä¼˜ç‚¹ï¼šä½¿ç”¨ç®€å•ï¼Œé€Ÿåº¦å¿«(JVMåº•å±‚æ”¯æŒï¼Œç¼–è¯‘åä¼šå½¢æˆ<code>monitorenter</code>ã€<code>monitorenter</code>ä¸¤æ¡æŒ‡ä»¤)ï¼Œè‡ªåŠ¨é‡Šæ”¾é”ï¼Œä¿è¯äº†äº’æ–¥æ€§å’Œå˜é‡ä¿®æ”¹çš„å¯è§æ€§ï¼ˆä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ï¼‰ã€‚</li><li>synchronizedç¼ºç‚¹ï¼šsynchronizedè·å–é”çš„è¿‡ç¨‹æ— æ³•è¢«ä¸­æ–­ï¼Œä¹Ÿä¸èƒ½å°è¯•éé˜»å¡ã€è¶…æ—¶è¿”å›ç­‰ç­–ç•¥è·å–é”ï¼Œè¿™åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹å°†ä¼šå¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½æŸå¤±ã€‚</li></ul></li></ol><h3 id="äºŒã€Lock"><a href="#äºŒã€Lock" class="headerlink" title="äºŒã€Lock"></a>äºŒã€Lock</h3><ol><li><p>Lockæ˜¯Java5å¼€å§‹æä¾›çš„ä¸€ä¸ªJDKå±‚é¢çš„ç”¨äºæ§åˆ¶åŒæ­¥äº’æ–¥çš„æ¥å£ï¼Œå®ƒä½äº<code>java.util.concurrent.locks</code>åŒ…ä¸‹ã€‚æ­¤å¤–ï¼Œè¯¥åŒ…ä¸‹è¿˜æœ‰Conditionå’ŒReadWriteLockä¸¤å…„å¼Ÿï¼Œå®ƒä»¬éƒ½æ˜¯ä¸ºå¤šçº¿ç¨‹åŒæ­¥ã€äº’æ–¥æœåŠ¡çš„ï¼Œå…¶ç±»å›¾å¦‚ä¸‹ï¼š</p><img src="/2019/08/24/java-lock-util/001.png" title="Lockå®¶æ—ç±»å›¾"><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Lockæ¥å£ä¸‹ä¸€èˆ¬ä¾›å¼€å‘äººå‘˜ç›´æ¥ä½¿ç”¨çš„å®ç°æ˜¯<code>ReentrantLock</code>ï¼Œè¿™ä¸ªç±»åŸºæœ¬è§£å†³äº†<code>synchronized</code>å­˜åœ¨çš„ä¸è¶³ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Lockæ¥å£æä¾›çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¼€å§‹è·å–é”(è¿›å…¥ä¸´ç•ŒåŒº,é˜»å¡æ–¹æ³•)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>; </span><br><span class="line">    <span class="comment">//å¼€å§‹è·å–é”ï¼ŒåŒæ—¶å¯ä»¥å“åº”ä¸­æ–­äº‹ä»¶ï¼Œå¯åœ¨æ•è·InterruptedExceptionå¼‚å¸¸ååšåç»­å¤„ç†(é˜»å¡æ–¹æ³•)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>; </span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ç«‹å³è¿”å›(éé˜»å¡)</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸç«‹å³è¿”å›ï¼Œå¦åˆ™ç­‰å¾…ç»™å®šæ—¶é—´åè¿”å›ï¼Œå¹¶ä¸”ç­‰å¾…ä¸­è¿˜å¯ä»¥å“åº”ä¸­æ–­äº‹ä»¶</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> var1, TimeUnit var3)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//æ¡ä»¶å˜é‡ï¼Œç”¨äºçº¿ç¨‹é—´é€šä¿¡åŠåŒæ­¥åä½œ(ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…æ¨¡å‹ä¼šç”¨åˆ°)</span></span><br><span class="line">    <span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡Lockæ¥å£æä¾›çš„æ–¹æ³•æˆ‘ä»¬çœ‹åˆ°Locké”æ›´åŠ ç»†ç²’åº¦åŒ–ï¼Œå®ƒå¯ä»¥è®©å¼€å‘äººå‘˜æ ¹æ®å®é™…éœ€æ±‚çµæ´»å¤„ç†è·å–é”æœŸé—´çš„ç­‰å¾…è¡Œä¸ºã€‚ä½¿ç”¨Lockä¸€å®šè¦<strong>æ‰‹åŠ¨é‡Šæ”¾é”</strong>ï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå¦‚æœå¤„ç†ä¸æ…å°†ä¼šå¯¼è‡´ä¸å¯é¢„æœŸçš„æ­»é”ï¼Œä¸€èˆ¬ä¸ºäº†å¯é é‡Šæ”¾é”ï¼Œä¼šå°†unlockè°ƒç”¨æ”¾åœ¨<code>finally</code>å—ä¸­ã€‚</p></li><li><p>è¯´å®ŒLockæ¥å£æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°<code>ReentrantLock</code>ï¼Œä»å­—é¢ä¸Šå°±çŸ¥é“è¿™ä¸ªé”æ˜¯ä¸€ä¸ª<strong>å¯é‡å…¥çš„</strong>ï¼Œä¸‹é¢æ˜¯è¯¥ç±»æä¾›çš„æ–¹æ³•ï¼ˆä»…åˆ—ä¸¾éƒ¨åˆ†æ–¹æ³•ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•ï¼Œé»˜è®¤éå…¬å¹³é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªbooleanå€¼æŒ‡å®šæ˜¯å¦éœ€è¦å…¬å¹³é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> var1)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//è·å–å½“å‰çº¿ç¨‹å¯¹è¯¥é”çš„æŒæœ‰æ•°é‡(å¯é‡å…¥ç‰¹æ€§)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHoldCount</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æŒæœ‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHeldByCurrentThread</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//æ˜¯å¦æˆåŠŸè·å–é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//æ˜¯å¦å…¬å¹³é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isFair</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//è¿”å›å½“å‰æŒæœ‰æ­¤é”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Thread <span class="title">getOwner</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//æ˜¯å¦æœ‰å¯èƒ½æ­£åœ¨ç­‰å¾…è·å–æ­¤é”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedThreads</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//æŸ¥è¯¢æŒ‡å®šçº¿ç¨‹æ˜¯å¦æ­£åœ¨ç­‰å¾…è·å–æ­¤é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedThread</span><span class="params">(Thread var1)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//è¿”å›å¯èƒ½è·å–æ­¤é”çš„ç­‰å¾…çº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getQueueLength</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//è¿”å›å¯èƒ½æ­£åœ¨ç­‰å¾…æ­¤é”çš„çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ„é€ æ–¹æ³•å¯çŸ¥ï¼Œ<code>ReentrantLock</code>é»˜è®¤æ˜¯<strong>éå…¬å¹³é”</strong>ï¼Œä½†å¯æ ¹æ®éœ€è¦é…ç½®æˆ<strong>å…¬å¹³é”</strong>ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ç³»åˆ—æŸ¥è¯¢æ–¹æ³•ï¼Œç”¨äºæŸ¥è¯¢å½“å‰é”çš„è·å–çŠ¶æ€ï¼Œè¿™é‡Œä¸ä¸€ä¸€æè¿°äº†ã€‚</p></li><li><p>åŸºç¡€ç”¨æ³•ï¼š</p><ol><li><p><strong>lock</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Lock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">lock.lock(); <span class="comment">//lock</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"><span class="comment">//handle exception</span></span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock(); <span class="comment">//unlock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>lockInterruptibly</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">    Lock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">    lock.lockInterruptibly(); <span class="comment">//å‘ä¸ŠæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥è‡ªå·±try cacheå¤„ç†</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//Do something</span></span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"><span class="comment">//handle exception</span></span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(); <span class="comment">//unlock</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>tryLock</strong>ï¼šï¼ˆä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éé˜»å¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Lock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span>(lock.tryLock()) &#123; <span class="comment">//å°è¯•è·å–é”ï¼Œè¿™ä¸ªè°ƒç”¨ä¸ä¼šé˜»å¡</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//do something</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//handle exception</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">//unlock</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–é”å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é˜»å¡ï¼Œå¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¯ä¸­æ–­</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAnything</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Lock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span>(lock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS)) &#123; <span class="comment">//è¶…æ—¶è®¾ä¸º5s</span></span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="comment">//do something</span></span><br><span class="line">             &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                 <span class="comment">//handle exception</span></span><br><span class="line">             &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                 lock.unlock(); <span class="comment">//unlock</span></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//è·å–é”å¤±è´¥</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         <span class="comment">//å¤„ç†ä¸­æ–­äº‹ä»¶</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç æ¼”ç¤ºä¸­ï¼Œä¸éš¾å‘ç°unlockæ“ä½œéƒ½æ˜¯æ”¾åœ¨finallyè¯­å¥ä¸­ï¼Œè€Œè·å–é”å´ä¸å†å¯¹åº”try-catchä¸­ï¼Œè¿™æ˜¯å› ä¸ºå¯¹äºéé˜»å¡æˆ–å¯ä¸­æ–­çš„è·å–é”æ–¹å‘æ¥è¯´ï¼Œå¦‚æœè·å–é”å¤±è´¥ï¼Œåé¢å†å»è°ƒç”¨unlockå°±ä¼šæŠ›å‡º<code>IllegalMonitorStateException</code>å¼‚å¸¸ï¼Œè¿™ä¼šå¸¦æ¥ä¸å¿…è¦çš„éº»çƒ¦ï¼Œæ‰€ä»¥ä¸€èˆ¬è·å–é”ä¸æˆåŠŸå°±ä¸ä¼šæ‰§è¡Œunlockã€‚å¯¹äºå¯ä¸­æ–­çš„é”ä¸€èˆ¬é‡‡ç”¨å‘ä¸ŠæŠ›å‡ºï¼Œè¿™æ˜¯å› ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹è·å–é”å¤±è´¥çš„åè¯¥æ˜¯å„çº¿ç¨‹è‡ªè¡Œé‡‡å–ç›¸åº”å¤„ç†ç­–ç•¥ï¼Œè€Œä¸æ˜¯ç”±è¢«è°ƒç”¨è€…å¤„ç†ã€‚</p></li></ol></li></ol><h3 id="ä¸‰ã€ReadWriteLock"><a href="#ä¸‰ã€ReadWriteLock" class="headerlink" title="ä¸‰ã€ReadWriteLock"></a>ä¸‰ã€ReadWriteLock</h3><ol><li><p>JDKä¸­é™¤æä¾›äº†åŸºæœ¬çš„æ»¡è¶³åŒæ­¥ã€äº’æ–¥çš„Lockæœºåˆ¶å¤–ï¼Œè¿˜æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„è¯»å†™é”æ¨¡å‹ï¼Œè¯¥æ¨¡å‹ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†äº’æ–¥è¦æ±‚ï¼Œå¸¦æ¥æ›´å¥½çš„æ€§èƒ½ä½“éªŒã€‚è¯»å†™é”å…·ä½“æ¥è¯´åˆ†ä¸ºä¸¤æ–¹é¢ï¼š</p><ul><li>ReadLockï¼šè¯»é”ä¸åŒçº¿ç¨‹å¯ä»¥é‡å¤è·å–ï¼ˆä¸å¯é‡å…¥æ¦‚å¿µä¸ä¸€æ ·ï¼‰ï¼Œå³ä¸€ä¸ªèµ„æºæ˜¯å¯ä»¥å¹¶å‘è¯»çš„ï¼Œèµ„æºåŠ äº†è¯»é”ååªèƒ½å†åŠ è¯»é”ã€‚</li><li>WriteLockï¼šå†™é”æ˜¯å®Œå…¨äº’æ–¥çš„ï¼Œå³ä¸€ä¸ªèµ„æºåŠ å†™é”åä¸èƒ½å†æ–½åŠ å…¶ä»–é”ï¼Œå½“ç„¶åŠ äº†è¯»é”çš„èµ„æºä¹Ÿä¸èƒ½åŠ å†™é”ã€‚</li></ul></li><li><p>è¯»å†™é”åœ¨æ•°æ®åº“ä¸­è¿ç”¨éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚ä¸€è¡Œæ•°æ®å¯ä»¥å¤šä¸ªå®¢æˆ·ç«¯è¯»å–ï¼Œä½†ä¸èƒ½åŒæ—¶å†™ï¼Œä¹Ÿä¸èƒ½è¾¹è¯»è¾¹å†™ã€‚ä¸‹é¢æ¼”ç¤ºè¯»å†™é”çš„å…·ä½“ç”¨æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ReadWriteLock readWriteLock;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; resource; <span class="comment">//æ¨¡æ‹Ÿå…¬å…±èµ„æº</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LockTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">        resource = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        resource.add(Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸»æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        LockTest lockTest = <span class="keyword">new</span> LockTest();</span><br><span class="line">        Thread r1 = <span class="keyword">new</span> Thread(() -&gt; &#123; <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;++i) &#123; lockTest.read();&#125; &#125;, <span class="string">"reader1"</span>);</span><br><span class="line">        Thread r2 = <span class="keyword">new</span> Thread(() -&gt; &#123; <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;++i) &#123; lockTest.read();&#125; &#125;, <span class="string">"reader2"</span>);</span><br><span class="line">        Thread w1 = <span class="keyword">new</span> Thread(()-&gt;&#123; <span class="keyword">try</span>&#123; lockTest.write(); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"writer1è¢«ä¸­æ–­"</span>); &#125;&#125;, <span class="string">"writer1"</span>);</span><br><span class="line">        Thread w2 = <span class="keyword">new</span> Thread(()-&gt;&#123; <span class="keyword">try</span>&#123; lockTest.write(); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"writer2è¢«ä¸­æ–­"</span>); &#125;&#125;, <span class="string">"writer2"</span>);</span><br><span class="line"></span><br><span class="line">        r1.start();</span><br><span class="line">        r2.start();</span><br><span class="line">        w2.start();</span><br><span class="line">        w1.start();</span><br><span class="line">        Thread.sleep(<span class="number">3</span>);<span class="comment">//ç­‰å¾…3ms</span></span><br><span class="line">        w1.interrupt(); <span class="comment">//å°è¯•ä¸­æ–­writer1çš„é˜»å¡</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–èµ„æº</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readWriteLock.readLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">": "</span> +resource);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readWriteLock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å†™å…¥èµ„æº</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        readWriteLock.writeLock().lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resource.add(Thread.currentThread().getName());</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">": add resource"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readWriteLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"> * reader2: [main]</span></span><br><span class="line"><span class="comment"> * reader1: [main]</span></span><br><span class="line"><span class="comment"> * writer2: add resource</span></span><br><span class="line"><span class="comment"> * writer1è¢«ä¸­æ–­</span></span><br><span class="line"><span class="comment"> * reader2: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader1: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader1: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader2: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader1: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader2: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader1: [main, writer2]</span></span><br><span class="line"><span class="comment"> * reader2: [main, writer2]</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ¼”ç¤ºäº†å¹¶å‘ç¯å¢ƒä¸‹ReadWriteLockçš„ä½¿ç”¨ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æœ€ç»ˆçš„è¾“å‡ºä¸æ˜¯ä¸€ä¸ªå›ºå®šç»“æœï¼Œå¦‚æœwriter1åœ¨3mså†…è·å–åˆ°é”å°±ä¸ä¼šè¾“å‡º<code>writer1è¢«ä¸­æ–­</code>ï¼ˆ<code>w1.interrupt();</code>å°†ä¼šä¸­æ–­writer1é‡Œé¢çš„sleepï¼‰ï¼Œè¿™ä¸ªç»“æœå®Œå…¨æ˜¯éšæœºçš„ã€‚è™½ç„¶ReentrantReadWriteLockæ²¡å®ç°Lockæ¥å£ï¼Œä½†å…¶å†…éƒ¨ç±»<code>ReentrantReadWriteLock.WriteLock</code>å’Œ<code>ReentrantReadWriteLock.ReadLock</code>å®ç°äº†Lockæ¥å£ï¼Œå› æ­¤è¯»å†™é”ä¹Ÿå…·æœ‰Lockçš„å…¨éƒ¨ç‰¹æ€§ã€‚</p></li></ol><h3 id="å››ã€ç›¸å…³æ¦‚å¿µ"><a href="#å››ã€ç›¸å…³æ¦‚å¿µ" class="headerlink" title="å››ã€ç›¸å…³æ¦‚å¿µ"></a>å››ã€ç›¸å…³æ¦‚å¿µ</h3><ol><li><p><strong>ä¹è§‚é”/æ‚²è§‚é”</strong></p><p>ä¹è§‚é”å’Œæ‚²è§‚é”ä¸æ˜¯ä¸€ç§å…·ä½“çš„é”ï¼Œè€Œæ˜¯å¯¹å¾…å¹¶å‘çš„ä¸€ç§æ€åº¦ã€‚<strong>æ‚²è§‚é”</strong>è®¤ä¸ºå¯¹äºåŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ä¸€å®šä¼šå‘ç”Ÿä¿®æ”¹æ“ä½œï¼Œä¸åŠ é”çš„å¹¶å‘è®¿é—®ä¸€å®šä¼šå‡ºé—®é¢˜ï¼Œå› æ­¤ä¸€å®šè¦åŠ é”ã€‚<strong>ä¹è§‚é”</strong>åˆ™è®¤ä¸ºå¹¶å‘è®¿é—®å¾ˆå°‘å‘ç”Ÿèµ„æºä¿®æ”¹æ“ä½œï¼Œå³ä½¿å‘ç”Ÿä¹Ÿä¼šé‡‡ç”¨ä¸æ–­å°è¯•çš„æ–¹å¼æ›´æ–°èµ„æºï¼Œä¸åŠ é”çš„å¹¶å‘è®¿é—®æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ã€‚æ‚²è§‚é”é€‚åˆå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¹è§‚é”é€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ã€‚Javaä¸­å„ç§åŠ é”ç¼–ç¨‹å°±å±äºæ‚²è§‚é”èŒƒå›´ï¼Œè€Œä½¿ç”¨concurrentåŒ…ä¸‹çš„AtomicXXXå®ç°åŸå­æ“ä½œå°±å±äºä¹è§‚é”èŒƒå›´ï¼Œå› ä¸ºAtomicç±»å‹æ˜¯ä½¿ç”¨<a href="https://segmentfault.com/a/1190000017943658" target="_blank" rel="noopener">CASç®—æ³•</a>å®ç°åŸå­æ“ä½œçš„ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨é”ï¼Œå±äºæ— é”ç¼–ç¨‹ï¼Œä¸€èˆ¬æ¥è¯´ä¹è§‚é”çš„æ€§èƒ½å¥½äºæ‚²è§‚é”ã€‚</p></li></ol><hr><ol start="2"><li><p><strong>å¯é‡å…¥é”</strong></p><p>å¯é‡å…¥æ˜¯åªå¯é‡å¤é€’å½’è°ƒç”¨çš„é”ï¼Œåœ¨åŠ é”çš„æ–¹æ³•ç±»å¯é€’å½’è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚<code>ReentrantLock</code>å’Œ<code>synchronized</code>éƒ½æ˜¯å¯é‡å…¥é”ã€‚</p></li></ol><hr><ol start="3"><li><p><strong>ç‹¬å é”ï¼ˆæ’å®ƒé”ï¼‰</strong> / <strong>å…±äº«é”</strong></p><p>ç‹¬å é”å³ä¸€ä¸ªé”åªèƒ½ä¸€ä¸ªçº¿ç¨‹å æœ‰ï¼Œå¦‚<code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock.WriteLock</code>å°±æ˜¯ç‹¬å é”ã€‚å…±äº«é”å¯è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œå¦‚<code>ReentrantReadWriteLock.ReadLock</code></p></li></ol><hr><ol start="4"><li><p><strong>å…¬å¹³é”</strong> / <strong>éå…¬å¹³é”</strong></p><p>å…¬å¹³é”æ˜¯æŒ‡è·å–é”çš„é¡ºåºè·Ÿç”³è¯·é”çš„é¡ºåºä¸€è‡´ï¼Œåä¹‹äº¦ç„¶ã€‚</p></li></ol><hr><ol start="5"><li><p><strong>åˆ†æ®µé”</strong></p><p>åˆ†æ®µé”æ˜¯ä¸€ç§é”çš„è®¾è®¡ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å‡å°åŠ é”ç²’åº¦ã€‚æ¯”å¦‚åœ¨<code>ConcurrentHashMap</code>ä¸­å°±é‡‡ç”¨åˆ†æ®µé”çš„æ€æƒ³ï¼ŒConcurrentHashMapä¸­æœ‰16ä¸ªé”ï¼Œæ¯ä¸ªæ•£åˆ—æ¡¶ç”±ç¬¬N%16ä¸ªé”æ¥ä¿æŠ¤ï¼Œæ‰€ä»¥ä¸€æ¬¡åŠ é”ç†è®ºä¸Šï¼ˆä¸æ•°æ®åˆ†å¸ƒå‡åŒ€ç¨‹åº¦æœ‰å…³ï¼‰åªé”å®šæ•´ä¸ªMapçš„1/16çš„æ•°æ®ï¼Œå…¶ä»–éƒ¨åˆ†çš„æ•°æ®è®¿é—®ä¸å—é™åˆ¶ï¼ŒConcurrentHashMapæœ€å¤šå¯æ”¯æŒ16ä¸ªçº¿ç¨‹çš„å¹¶å‘å†™å…¥ã€‚åŒæ ·åœ¨MySQLä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„è®¾è®¡å‡ºç°ï¼Œæ¯”å¦‚è¡Œé”å°±æ˜¯ä¸€ç§åˆ†æ®µé”ï¼Œæ›´æ–°æ•°æ®æ—¶åªéœ€è¦é”å®šç‰¹å®šè¡Œï¼Œå…¶ä»–è¡Œå¯ä¾›æ­£å¸¸è®¿é—®ã€‚</p></li></ol><hr><ol start="6"><li><p><strong><em>åå‘é”</em></strong> / <strong><em>è½»é‡çº§é”</em></strong> / <strong><em>é‡é‡çº§é”</em></strong></p><p>è¿™3ç§åˆ†ç±»éJavaè¯­è¨€æä¾›çš„ç‰¹æ€§ï¼Œå› æ­¤ä¸åšæ·±å…¥ç ”ç©¶ï¼Œå¯å‚è€ƒï¼š<a href="https://www.cnblogs.com/wzj4858/p/8215369.html" target="_blank" rel="noopener">åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”</a></p></li></ol><hr><ol start="7"><li><p><strong>è‡ªæ—‹é”</strong></p><p>è‡ªæ—‹é”å…³æ³¨çš„æ˜¯åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­çº¿ç¨‹å¤„æ‰€å¤„çŠ¶æ€ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™ï¼Œå¦‚æœé”å·²ç»è¢«å…¶å®ƒçº¿ç¨‹è·å–ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†<strong>å¾ªç¯ç­‰å¾…</strong>ï¼ˆä¸è¿›å…¥é˜»å¡çŠ¶æ€ï¼‰ï¼Œç„¶åä¸æ–­çš„åˆ¤æ–­é”æ˜¯å¦èƒ½å¤Ÿè¢«æˆåŠŸè·å–ï¼Œç›´åˆ°è·å–åˆ°é”æ‰ä¼šé€€å‡ºå¾ªç¯ã€‚æ³¨æ„ï¼Œè‡ªæ—‹é”çš„è®¾è®¡æ˜¯ä¸ºäº†å‡å°‘çº¿ç¨‹çŠ¶æ€åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼ˆç”¨æˆ·æ€-&gt;å†…æ ¸æ€ï¼Œactive-&gt;blockedï¼‰,å½“åŠ é”åŒºåŸŸçš„ä»£ç æ‰§è¡Œçš„éå¸¸å¿«æ—¶ï¼Œè¯¥è®¾è®¡èƒ½å¤§å¤§æé«˜æ€§èƒ½ã€‚è€ŒåŠ é”åŒºåŸŸæ‰§è¡Œç¼“æ…¢æ—¶åˆ™ç›¸åï¼Œè‡ªæ—‹é”ä¸ä¼šé‡Šæ”¾CPUèµ„æºï¼Œå¦‚æœé•¿æ—¶é—´å¤„äºè‡ªæ—‹çŠ¶æ€å°†ä¸¥é‡æ‹–ç´¯ç³»ç»Ÿæ€§èƒ½ï¼Œæ‰€ä»¥æ˜¯å¦é‡‡ç”¨è‡ªæ—‹é”éœ€è¦æ ¹æ®éœ€æ±‚è€Œå®šã€‚</p></li></ol><h3 id="äº”ã€å‚è€ƒèµ„æ–™"><a href="#äº”ã€å‚è€ƒèµ„æ–™" class="headerlink" title="äº”ã€å‚è€ƒèµ„æ–™"></a>äº”ã€å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://blog.csdn.net/justloveyou_/article/details/54972105" target="_blank" rel="noopener">Java å¹¶å‘ï¼šLock æ¡†æ¶è¯¦è§£</a></li><li><a href="http://blog.itpub.net/31545684/viewspace-2375117/" target="_blank" rel="noopener">Java ç§15ç§é”çš„ä»‹ç»ï¼šå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç‹¬äº«é”ï¼Œäº’æ–¥é”ç­‰ç­‰â€¦</a></li><li><a href="https://www.cnblogs.com/wzj4858/p/8215369.html" target="_blank" rel="noopener">javasçš„å››ç§çŠ¶æ€ æ— é”çŠ¶æ€ åå‘é”çŠ¶æ€ è½»é‡çº§é”çŠ¶æ€ é‡é‡çº§é”çŠ¶æ€</a></li><li><a href="https://zhuanlan.zhihu.com/p/40729293" target="_blank" rel="noopener">é¢è¯•å¿…å¤‡ä¹‹æ·±å…¥ç†è§£è‡ªæ—‹é”</a></li><li><a href="http://tool.oschina.net/apidocs/apidoc?api=jdk-zh" target="_blank" rel="noopener">JDKæ–‡æ¡£</a></li></ol>]]></content>
    
    <summary type="html">
    
      å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¸€ä¸ªæ°¸è¿œç»•ä¸è¿‡çš„è¯é¢˜ï¼Œæ·±å…¥è®¤è¯†Javaä¸­çš„åŒæ­¥ã€äº’æ–¥æœºåˆ¶æ˜¯Javaå¹¶å‘ç¼–ç¨‹çš„å¿…ç»ä¹‹è·¯ã€‚æœ¬ç¯‡æ–‡ç« å°±JavaåŸç”Ÿé”æœºåˆ¶åšä¸€ä¸ªç®€å•çš„æè¿°ï¼Œè®©è‡ªå·±èƒ½å…¨é¢å®è§‚è®¤è¯†æ•´ä¸ªæ¡†æ¶ï¼Œåœ¨å·¥ä½œå­¦ä¹ ä¸­èƒ½æ­£ç¡®ã€é«˜æ•ˆä½¿ç”¨JavaåŒæ­¥ã€äº’æ–¥ç›¸å…³å·¥å…·ã€‚
    
    </summary>
    
      <category term="Java" scheme="http://blog.zjee.ml/categories/Java/"/>
    
    
      <category term="å¤šçº¿ç¨‹" scheme="http://blog.zjee.ml/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="Javaé”æœºåˆ¶" scheme="http://blog.zjee.ml/tags/Java%E9%94%81%E6%9C%BA%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>Hive on Spark å®è·µ</title>
    <link href="http://blog.zjee.ml/2018/12/02/hive-on-spark/"/>
    <id>http://blog.zjee.ml/2018/12/02/hive-on-spark/</id>
    <published>2018-12-02T13:02:57.000Z</published>
    <updated>2018-12-02T13:02:57.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€å‡†å¤‡"><a href="#ä¸€ã€å‡†å¤‡" class="headerlink" title="ä¸€ã€å‡†å¤‡"></a>ä¸€ã€å‡†å¤‡</h3><ol><li>jdkã€hadoopã€Hiveã€mysqlå’Œsparkã€‚ä¸ºé¿å…å…¼å®¹é—®é¢˜ï¼Œæœ¬äººå…¨éƒ¨é‡‡ç”¨cdhç‰ˆæœ¬ï¼Œå¯¹åº”cdh5.15.0ï¼Œä¸è¿‡è²Œä¼¼sparkç‰ˆæœ¬æœ‰ç‚¹ä½ï¼Œä¸è¿‡æ— æ‰€è°“ï¼Œæ¯•ç«Ÿåªæ˜¯å®éªŒã€‚</li><li>ç”±äºæœ¬äººä¹‹å‰æ­å»ºè¿‡kylinç¯å¢ƒï¼Œå› æ­¤hadoopå’Œhiveç¯å¢ƒå·²ç»é…ç½®å¦¥å½“ï¼Œéƒ½æ˜¯yarnç®¡ç†ä¸‹çš„ä¼ªåˆ†å¸ƒå¼é›†ç¾¤ã€‚</li><li>å®‰è£…scalaï¼Œmacä¸‹é€šè¿‡brewå®‰è£…ï¼š<code>brew install scala</code>ï¼Œç½‘é€Ÿæ…¢å¯ä»¥ä½¿ç”¨ä»£ç†æˆ–<a href="https://www.cnblogs.com/jay54520/p/6347729.html" target="_blank" rel="noopener">å›½å†…æº</a>ã€‚</li><li><a href="https://www.cnblogs.com/binarylei/p/8903601.html" target="_blank" rel="noopener">hadoop</a>ã€<a href="https://www.cnblogs.com/wujiadong2014/p/6058552.html" target="_blank" rel="noopener">hive</a>ã€<a href="https://www.jianshu.com/p/e41b18a7e202" target="_blank" rel="noopener">spark</a>çš„åŸºæœ¬æ¦‚å¿µï¼ŒåŸç†ï¼Œè¿è¡Œæ–¹å¼å¯åšä¸€ä¸ªåˆæ­¥äº†è§£ï¼Œæ–¹ä¾¿ä»¥åé—®é¢˜æ’æŸ¥ã€‚</li></ol><h3 id="äºŒã€é…ç½®SPARK"><a href="#äºŒã€é…ç½®SPARK" class="headerlink" title="äºŒã€é…ç½®SPARK"></a>äºŒã€é…ç½®SPARK</h3><ol><li><p>åœ¨/etc/profileæˆ–~/.bash_profileï¼ˆå‡è®¾ä½ æ²¡æœ‰ä½¿ç”¨zshä¹‹ç±»çš„shellï¼‰ä¸­åŠ å…¥SPARK_HOMEç¯å¢ƒå˜é‡ï¼Œå¹¶å°†binè·¯å¾„æ·»åŠ åˆ°PATHä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export SPARK_HOME=/Users/xxx/spark-1.6.0-cdh5.15.0</span><br><span class="line">export PATH=$PATH:$SPARK_HOME/bin</span><br></pre></td></tr></table></figure></li><li><p>åœ¨sparkä¸‹çš„configç›®å½•ä¸­æ‰¾åˆ°spark-env.shå’Œspark-defaults.conf(å¦‚æœæ²¡æœ‰å°±è‡ªå·±åˆ›å»º)ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹é…ç½®:</p><p>spark-env.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> !/usr/bin/env bash</span><br><span class="line">export SCALA_HOME=/usr/local/Cellar/scala/2.12.7 #æ³¨æ„scalaç‰ˆæœ¬</span><br><span class="line">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_171.jdk/Contents/Home</span><br><span class="line">export HADOOP_HOME=/Users/xxx/hadoop-2.6.0-cdh5.15.0</span><br><span class="line">export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop #hadoopé…ç½®æ–‡ä»¶ç›®å½•</span><br><span class="line">export YARN_CONF_DIR=$HADOOP_HOME/etc/hadoop #yarné…ç½®æ–‡ä»¶ç›®å½•(å’Œhadoopé…ç½®åœ¨ä¸€èµ·)</span><br><span class="line">export SPARK_MASTER_IP=localhost #masterèŠ‚ç‚¹IPï¼Œæœ¬åœ°æ­å»ºä½¿ç”¨localhost</span><br><span class="line">export SPARK_MASTER_HOST=localhost #masteræœºå™¨åç§°ï¼Œæœ¬åœ°æ­å»ºå¯ä½¿ç”¨localhostä»£æ›¿</span><br><span class="line">export SPARK_EXECUTOR_MEMORY=512m #æ¯ä¸ªexecutorå¯åˆ†é…çš„å†…å­˜ï¼Œå¯æ ¹æ®æœºå™¨å®é™…æƒ…å†µè®¾ç½®ä¸º512måˆ°1g</span><br><span class="line">export SPARK_DRIVER_MEMORY=512m #driverå¯åˆ†é…çš„å†…å­˜ï¼Œå¯æ ¹æ®æœºå™¨å®é™…æƒ…å†µè®¾ç½®ä¸º512måˆ°1g</span><br><span class="line">export SPARK_DIST_CLASSPATH=$($&#123;HADOOP_HOME&#125;/bin/hadoop classpath) #saprkè¿è¡Œä¾èµ–hadoopçš„åº“</span><br></pre></td></tr></table></figure><p>spark-defaults.conf</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spark<span class="selector-class">.master</span>                     yarn</span><br><span class="line">spark<span class="selector-class">.home</span>                       /Users/xxx/spark-<span class="number">1.6</span>.<span class="number">0</span>-cdh5.<span class="number">15.0</span></span><br><span class="line">spark<span class="selector-class">.eventLog</span><span class="selector-class">.enabled</span>           true</span><br><span class="line">spark<span class="selector-class">.eventLog</span><span class="selector-class">.dir</span>               hdfs:<span class="comment">//localhost:8001/spark_history</span></span><br><span class="line">spark<span class="selector-class">.serializer</span>                 org<span class="selector-class">.apache</span><span class="selector-class">.spark</span><span class="selector-class">.serializer</span><span class="selector-class">.KryoSerializer</span></span><br><span class="line">spark<span class="selector-class">.executor</span><span class="selector-class">.memory</span>            <span class="number">512</span>m</span><br><span class="line">spark<span class="selector-class">.driver</span><span class="selector-class">.memory</span>              <span class="number">512</span>m</span><br><span class="line">spark<span class="selector-class">.executor</span><span class="selector-class">.extraJavaOptions</span>  -XX:+PrintGCDetails -Dkey=value -Dnumbers=<span class="string">"one two three"</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œå°†sparkæ‰˜ç®¡åˆ°yarnä¸Šï¼Œæ‰€ä»¥spark.masteré…ç½®ä¸ºyarnï¼Œæ—¥å¿—ç›®å½•å¿…é¡»æ˜¯hdfsè·¯å¾„ä¸‹çš„<strong><em>å·²ç»å­˜åœ¨</em></strong>çš„ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨è¯·æ‰‹åŠ¨åˆ›å»º<code>hdfs dfs -mkdir /spark_history</code>ï¼Œè¿™ä¸ªç›®å½•ä¹Ÿæ˜¯åé¢çš„spark historyæœåŠ¡ä¾èµ–çš„ç›®å½•ã€‚</p></li></ol><h3 id="ä¸‰ã€é…ç½®Hive"><a href="#ä¸‰ã€é…ç½®Hive" class="headerlink" title="ä¸‰ã€é…ç½®Hive"></a>ä¸‰ã€é…ç½®Hive</h3><ol><li><p>å°†spark-defaults.confä¸­çš„é…ç½®åŒæ­¥åˆ°hiveé…ç½®ä¸­ï¼Œåœ¨hiveä¸‹çš„confç›®å½•ä¸‹æ‰¾åˆ°hive-site.xmlï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼š<br> hive-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ³¨æ„ï¼šhive.execution.engineåœ¨è¿™é‡Œè®¾ç½®è¡¨ç¤ºhiveé»˜è®¤ä½¿ç”¨sparkå¼•æ“ï¼Œ</span></span><br><span class="line"><span class="comment">ä¹Ÿå¯ä»¥ä¸åœ¨è¿™é‡Œè®¾ç½®ï¼Œè¿›å…¥hive cliæˆ–å®¢æˆ·ç«¯åä½¿ç”¨set hive.execution.engine=spark</span></span><br><span class="line"><span class="comment">å¯ç”¨sparkå¼•æ“ï¼Œä½†è¿™ç§æ–¹å¼åªé’ˆå¯¹å½“å‰ä¼šè¯æœ‰æ•ˆã€‚--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.execution.engine<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>spark<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>spark.home<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span>/Users<span class="meta-keyword">/xxx/</span>spark<span class="number">-1.6</span><span class="number">.0</span>-cdh5<span class="number">.15</span><span class="number">.0</span><span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>spark.master<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span>yarn<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>spark.executor.memory<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span><span class="number">512</span>m<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>spark.driver.memory<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span><span class="number">512</span>m<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line"><span class="params">&lt;name&gt;</span>spark.serializer<span class="params">&lt;/name&gt;</span></span><br><span class="line"><span class="params">&lt;value&gt;</span>org.apache.spark.serializer.KryoSerializer<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>spark.enentLog.enabled<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>true<span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>spark.enentLog.dir<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>hdfs:<span class="comment">//localhost:8001/spark_history&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;property&gt;</span></span><br><span class="line">  <span class="params">&lt;name&gt;</span>spark.executor.extraJavaOptions<span class="params">&lt;/name&gt;</span></span><br><span class="line">  <span class="params">&lt;value&gt;</span>-XX:+PrintGCDetails -Dkey=value -Dnumbers=<span class="string">"one two three"</span><span class="params">&lt;/value&gt;</span></span><br><span class="line"><span class="params">&lt;/property&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„é…ç½®åŠ¡å¿…å’Œspark-defaults.confä¸­çš„ä¸€è‡´ï¼Œå°¤å…¶æ˜¯<code>spark.executor.memory</code>å’Œ<code>spark.driver.memory</code>ï¼Œè‡ªå·±é…ç½®æ—¶å¡«é”™äº†è¿™ä¸¤é¡¹ï¼Œç»“æœä¸€å †è«åå…¶å¦™çš„å¼‚å¸¸ã€‚</p></li></ol><h3 id="å››ã€é…ç½®yarn"><a href="#å››ã€é…ç½®yarn" class="headerlink" title="å››ã€é…ç½®yarn"></a>å››ã€é…ç½®yarn</h3><ol><li><p>é…ç½®yarnï¼Œåœ¨hadoopçš„etc/hadoopç›®å½•ä¸‹æ‰¾åˆ°yarn-site.xmlï¼Œå¢åŠ ï¼ˆä¿®æ”¹ï¼‰å¦‚ä¸‹å†…å®¹ï¼š<br>yarn-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- yarnèµ„æºè°ƒåº¦å™¨ï¼šå…¬å¹³è°ƒåº¦ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- NMçš„webç›‘æ§åœ°å€ï¼Œä¸»è¦æ˜¯ç«¯å£è®¾ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.webapp.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.0.0.0:8042<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- NMå¯åˆ†æ´¾çš„å†…å­˜é‡ï¼Œå•æœºçš„è¯çœ‹æœºå™¨å‰©ä½™å†…å­˜é‡é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.resource.memory-mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>8192<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- NMå¯åˆ†é…çš„è™šæ‹ŸCPUæ•°ï¼Œå•æœºçš„è¯é…ç½®ä¸ºCPUæ ¸æ•°-2æˆ–-1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.resource.cpu-vcores<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>6<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="äº”ã€å…¶ä»–é…ç½®"><a href="#äº”ã€å…¶ä»–é…ç½®" class="headerlink" title="äº”ã€å…¶ä»–é…ç½®"></a>äº”ã€å…¶ä»–é…ç½®</h3><ol><li>ä½ ä»¥ä¸ºè¿™å°±å®Œäº†ï¼Ÿæ²¡æœ‰ï¼ŒCDHç‰ˆæœ¬çš„Hiveä¸Sparkå¹¶æ²¡æœ‰è”ç³»ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å°†spark libä¸­çš„<code>spark-assembly-1.6.0-cdh5.15.0-hadoop2.6.0-cdh5.15.0.jar</code>æ‹·è´åˆ°hive libä¸‹ï¼Œhiveæ‰èƒ½ä¸sparkå»ºç«‹è”ç³»ã€‚</li><li>ç†è®ºä¸Šä¸€åˆ‡OKäº†ï¼Œä½†ä½ å¯èƒ½ä¼šå‘ç°åœ¨hiveä¸­ä½¿ç”¨sparkå¼•æ“æ—¶è¿”å›3å·é”™è¯¯ï¼Œæ€»ä¹‹å°±æ˜¯sparkè¿è¡Œä¸æ­£å¸¸ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨sparkè‡ªå¸¦çš„exampleè¿›è¡Œæµ‹è¯•è¯Šæ–­ï¼ˆcdåˆ°spark binç›®ä¸‹ï¼‰ï¼š<code>./spark-submit --master yarn --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-cdh5.15.0-hadoop2.6.0-cdh5.15.0.jar 10</code>ï¼Œå…·ä½“example jarè·¯å¾„åŠæ–‡ä»¶åè‡ªè¡ŒæŸ¥çœ‹ã€‚è¿è¡Œèµ·æ¥åæœ‰ä¸€ä¸ªå¼‚å¸¸è§£å†³ä¸€ä¸ªå¼‚å¸¸ï¼Œç›´åˆ°è·‘å‡ºç»“æœä¸ºæ­¢ï¼Œæ²¡æœ¬äººæµ‹è¯•ä¸­å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š</li></ol><hr><ul><li><p><strong>æ²¡æœ‰jacksonæ¨¡å—</strong>ï¼šWTFï¼Œå®˜ç½‘ä¸‹è½½çš„sparkå±…ç„¶åŒ…éƒ½ä¸å¸¦å…¨ï¼ŒéšåæŸ¥äº†ä¸€ä¸‹cdhç‰ˆæœ¬ç¡®å®æ²¡å¸¦jacksonçš„ç›¸å…³åŒ…ï¼Œç„¶åå»mavenå®˜ç½‘ä¸‹è½½(ä¸‰ä¸ªéƒ½è¦ä¸‹è½½)ï¼Œæ”¾åˆ°<code>{HADOOP_HOME}/share/hadoop/common/lib</code>ä¸‹ï¼Œè‡³äºä¸ºä»€ä¹ˆæ”¾åœ¨è¿™å„¿è€Œä¸æ˜¯spark libï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢é…ç½®äº†<code>SPARK_DIST_CLASSPATH</code>ï¼ˆçœ‹ä¸æ˜ç™½å°±åœ¨shellä¸­echoä¸€ä¸‹ï¼‰ï¼Œå®ƒä¼šåŠ å…¥åˆ°sparkç±»è·¯å¾„ä¸‹ï¼Œè¿™ä¸ªè·¯å¾„å°±åŒ…å«ä¸Šé¢çš„<code>{HADOOP_HOME}/share/hadoop/common/lib</code>ï¼Œè€Œä¸”å®ƒä¸‹é¢è¿˜æœ‰jacksonçš„å…¶ä»–åŒ…ï¼Œé¡ºç†æˆç« å°±æ”¾è¿™å„¿äº†ã€‚éšåå†è¯•ï¼</p><hr></li><li><p><strong>jacksonç‰ˆæœ¬é—®é¢˜</strong>ï¼šWTFï¼Œè¿™å›æ‰¾åˆ°jacksonäº†ï¼Œä½†jacksonå†…éƒ¨æŠ›å¼‚å¸¸äº†ï¼Œä¸Šç½‘æŸ¥å‘ç°æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œäºæ˜¯æŒ‰çƒ­å¿ƒç½‘å‹æ¨èé‡‡ç”¨2.4.4çš„ç‰ˆæœ¬ï¼Œè¿™å›ä¸æŠ›å¼‚å¸¸äº†ï¼</p><hr></li><li><p><strong>æ— é™ACCEPT</strong>ï¼šè™½ç„¶å¼‚å¸¸æ˜¯æ²¡äº†ï¼Œå¯è¿™ä¸ªç¨‹åºä¸€ç›´æ˜¯ACCEPTï¼ˆç­‰ä¸€ä¸ªå°æ—¶äº†ï¼‰ï¼Œç„¶ååˆä¸Šç½‘æœç´¢æ‰¾åˆ°éƒ¨åˆ†ç­”æ¡ˆï¼Œæµ‹è¯•æ— æœï¼Œå†å›å¤´çœ‹å‰é¢çš„é…ç½®ï¼Œå‘ç°sparkk-env.shä¸­<code>SPARK_MASTER_IP</code>å’Œ<code>SPARK_MASTER_HOST</code>è·Ÿé‚£äº›å‚»å±Œç½‘å‹ä¸€æ ·é…æˆäº†masterï¼Œå¯æ˜¯æˆ‘çš„æœºå™¨ä¸å«masterï¼Œæ‰€ä»¥yarnæ‰¾ä¸åˆ°æ‰§è¡Œæœºå™¨ï¼Œä¹Ÿå°±æ— æ³•åˆ†é…å†…å­˜ï¼Œé‚æ›´æ”¹ä¸ºlocalhost(æœ¬ç¯‡æ–‡ç« å¼€å¤´é…ç½®å·²æ›´æ”¹)ï¼Œç„¶å everything is OKï¼</p><hr></li><li><p>å¦‚æœä½ çš„æœºå™¨å†…å­˜è¾ƒå°ï¼Œå¯¼è‡´åˆ†é…èµ„æºç¼“æ…¢ï¼Œå¯é€‚å½“è°ƒæ•´ä¸€ä¸‹<code>${HADOOP_HOME}/etc/hadoop/capacity-scheduler.xml</code>ä¸­çš„<code>yarn.scheduler.capacity.maximum-am-resource-percent</code>ï¼Œå¯ä»¥ç”±0.1è°ƒæ•´ä¸º0.5ï¼Œå®ƒè¡¨ç¤ºyarnæ‰€ç®¡ç†çš„èµ„æºä¸­ï¼Œæœ€å¤šå¯ä»¥æœ‰å¤šå°‘èµ„æºå¯ä»¥ç”¨æ¥è¿è¡Œapplication masterï¼Œå³æ§åˆ¶å½“å‰æ¿€æ´»çŠ¶æ€çš„åº”ç”¨ï¼Œé»˜è®¤æ˜¯10%ï¼Œåœ¨æˆ‘ä»¬è‡ªå·±æœºå™¨ä¸Šæ¥è¯´å¤ªå°äº†ï¼Œå› æ­¤å¯é€‚å½“è°ƒå¤§æ¯”ä¾‹ã€‚</p></li></ul><hr><ol start="3"><li>ç»ˆææµ‹è¯•ï¼š<img src="/2018/12/02/hive-on-spark/001.png" title="Hive on Spark æµ‹è¯•ç»“æœ"></li></ol>]]></content>
    
    <summary type="html">
    
      ä½œä¸ºå¤§æ•°æ®å¼€å‘äººå‘˜ï¼Œä¸€ç›´å°†ç²¾åŠ›æ”¾åœ¨ä¸šåŠ¡ä¸Šï¼Œå¾ˆä¹…æ²¡æœ‰å…³æ³¨å¤§æ•°æ®å·¥å…·hiveäº†ã€‚æœ€è¿‘åœ¨å†™ä¸€ä¸ªUDFå‡½æ•°æ—¶å‘ç°åœ¨hive(mr)å¼•æ“èƒ½é€šè¿‡ï¼Œåœ¨sparkå¼•æ“ä¸‹å´æŠ¥é”™ï¼Œäºæ˜¯å°±å€Ÿæ­¤æœºä¼šç²—ç•¥ç ”ç©¶ä¸€ä¸‹hive on mrã€hive on sparkå’Œspark sqlç­‰å†…å®¹ã€‚æœ¬ç¯‡ä¸ºæ•´ä¸ªç³»åˆ—å¼€ç¯‡ï¼Œä»‹ç»äº†MACä¸‹Hive on sparkçš„ç¯å¢ƒæ­å»ºï¼ŒåŠé‡åˆ°çš„å‘ã€‚
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://blog.zjee.ml/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="hive" scheme="http://blog.zjee.ml/tags/hive/"/>
    
      <category term="spark" scheme="http://blog.zjee.ml/tags/spark/"/>
    
      <category term="hadoop" scheme="http://blog.zjee.ml/tags/hadoop/"/>
    
      <category term="å¤§æ•°æ®" scheme="http://blog.zjee.ml/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>RPCæ¡†æ¶ä¹‹Thrift</title>
    <link href="http://blog.zjee.ml/2018/11/29/thrift-grama/"/>
    <id>http://blog.zjee.ml/2018/11/29/thrift-grama/</id>
    <published>2018-11-29T05:37:11.000Z</published>
    <updated>2019-12-28T14:54:13.451Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h3><p>â€‹        Thrift æ¥å£å®šä¹‰è¯­è¨€ Thrift æ¥å£å®šä¹‰è¯­è¨€(IDL, Interface Definition Language)ä¸­å…è®¸ä½¿ç”¨çš„æ˜¯ thrift typesã€‚æ¯ä¸ª thrift æ–‡ä»¶ä¸»è¦æœ‰ hearderï¼Œç±»å‹å®šä¹‰ï¼Œå¼‚å¸¸åŠæœåŠ¡ç»„æˆï¼Œæ¯ä¸ª thrift æ–‡æ¡£åŒ…å« 0 ä¸ªæˆ–å¤šä¸ª headers ä»¥åŠ 0 ä¸ªæˆ–å¤šä¸ª definitionsã€‚</p><h4 id="1ã€thrift-æ–‡ä»¶çš„ç»„æˆ"><a href="#1ã€thrift-æ–‡ä»¶çš„ç»„æˆ" class="headerlink" title="1ã€thrift æ–‡ä»¶çš„ç»„æˆ"></a>1ã€thrift æ–‡ä»¶çš„ç»„æˆ</h4><ul><li>Header ï¼šheader å¯ä»¥æ˜¯ thrift includeï¼ŒC++ includeï¼Œæˆ–è€…æ˜¯ namespace å£°æ˜ã€‚ </li><li><p>Thrift include çš„ç›®çš„æ˜¯ä½¿å¾—å…¶ä»– thrift æ–‡ä»¶ä¸­çš„æ‰€æœ‰å®šä¹‰éƒ½èƒ½å¤Ÿé€šè¿‡ include å£°æ˜æ·»åŠ åˆ°è¯¥ thrift æ–‡æ¡£äº§ç”Ÿçš„ä»£ç ä¸­ã€‚ è¯­æ³•ï¼š<code>include &quot;../../***.thrift&quot;</code> ï¼Œè¢«å¼•ç”¨çš„ thrift æ–‡ä»¶äº§ç”Ÿçš„ä»£ç ä¸­çš„å¤´æ–‡ä»¶å³å¯åŒ…å«åœ¨ thrift äº§ç”Ÿçš„ä»£ç çš„å¤´éƒ¨ï¼Œä½¿å¾—å…¶èƒ½å¤Ÿä½¿ç”¨ã€è®¿é—®ã€‚ </p></li><li><p>C++ include èƒ½å¤Ÿå°† C++å®šä¹‰çš„å¤´æ–‡ä»¶æ·»åŠ åˆ°è¯¥ thrift æ–‡ä»¶äº§ç”Ÿçš„ C++ä»£ç ä¸­ã€‚ è¯­æ³•ï¼š<code>cpp_include &quot;../../***.h&quot;</code> ï¼Œè¢«å¼•ç”¨çš„.h æ–‡ä»¶å°†åŒ…å«åˆ° thrift äº§ç”Ÿçš„ä»£ç çš„å¤´éƒ¨ã€‚ </p></li><li><p>namespace çš„å£°æ˜æ–¹å¼é‡‡ç”¨ä¸º namespaces/package/module/etcã€‚namespace scope è¡¨ç¤ºè¯¥ namespace åº”ç”¨äºå“ªç§ç¼–ç¨‹è¯­è¨€ï¼Œè‹¥ scope çš„å–å€¼ä¸ºâ€œ*â€ï¼Œåˆ™è¡¨ç¤ºè¯¥ namespace é€‚ç”¨äºæ‰€æœ‰çš„ç›®æ ‡è¯­è¨€ã€‚ è¯­æ³•ï¼š <code>namespace namespaceScope åç§°</code>ï¼Œå…¶ä¸­namespaceScope çš„å–å€¼æœ‰<code>*| cpp | java | py | perl | rb | cocoa | csharp</code>ã€‚ </p></li></ul><h4 id="2ã€Definition"><a href="#2ã€Definition" class="headerlink" title="2ã€Definition"></a>2ã€Definition</h4><p> thrift ä¸­å¯ä»¥å®šä¹‰çš„ç±»å‹æœ‰ const | typedef | enum | struct | exception | service </p><ul><li>const è¯­æ³•ï¼š <code>const å­—æ®µç±»å‹ æ ‡è¯†ç¬¦ = å€¼</code></li><li>typedef è¯­æ³•ï¼š <code>typedef ä¸ºä¸€ä¸ªç±»å‹åˆ›å»ºä¸€ä¸ªåˆ«å</code></li><li>enum è¯­æ³•ï¼š <code>enum æ ‡è¯†ç¬¦ {***ï¼Œ***ï¼Œâ€¦}</code>ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå€¼çš„å–å€¼é»˜è®¤ä¸º 0ã€‚ </li><li>struct è¯­æ³•ï¼š <code>struct æ ‡è¯†ç¬¦ { Field* }</code>ã€‚å…¶ä¸­ï¼Œæ¯ä¸ª Field çš„å®šä¹‰è¯­æ³•ä¸ºï¼š <code>FieldId: (required | optional) FieldType Identifier ( = value)</code>ã€‚ </li><li>exceptionï¼š Exceptions çš„å®šä¹‰ä¸ struts çš„å®šä¹‰ç›¸ä¼¼ï¼Œexception ä¸­æ¯ä¸ª field çš„å®šä¹‰å¿…é¡»å”¯ä¸€ è¯­æ³•ï¼š <code>exception æ ‡è¯†ç¬¦ { Field* }</code></li><li>serviceï¼š Service å®šä¹‰äº† server ç«¯æä¾›çš„åŠŸèƒ½é›†åˆçš„æ¥å£ã€‚ä¸€ä¸ª service å¯ä»¥ç»§æ‰¿å¦ä¸€ä¸ª serviceã€‚ è¯­æ³•ï¼š <code>service æ ‡è¯†ç¬¦ (extends otherService) { Function* }</code></li></ul><h3 id="äºŒã€ç±»å‹è¯¦è§£"><a href="#äºŒã€ç±»å‹è¯¦è§£" class="headerlink" title="äºŒã€ç±»å‹è¯¦è§£"></a>äºŒã€ç±»å‹è¯¦è§£</h3><p>Thriftç±»å‹ç³»ç»ŸåŒ…æ‹¬<strong>é¢„å®šä¹‰åŸºæœ¬ç±»å‹</strong>ï¼Œ<strong>ç”¨æˆ·è‡ªå®šä¹‰ç»“æ„ä½“</strong>ï¼Œ<strong>å®¹å™¨ç±»å‹</strong>ï¼Œ<strong>å¼‚å¸¸</strong>å’Œ<strong>æœåŠ¡</strong>å®šä¹‰ã€‚</p><h4 id="1ã€åŸºæœ¬ç±»å‹"><a href="#1ã€åŸºæœ¬ç±»å‹" class="headerlink" title="1ã€åŸºæœ¬ç±»å‹"></a>1ã€åŸºæœ¬ç±»å‹</h4><ul><li>bool: å¸ƒå°”ç±»å‹ï¼Œå ä¸€ä¸ªå­—èŠ‚</li><li>byte: æœ‰ç¬¦å·å­—èŠ‚ </li><li>i16ï¼š16ä½æœ‰ç¬¦å·æ•´å‹ </li><li>i32ï¼š32ä½æœ‰ç¬¦å·æ•´å‹ </li><li>i64ï¼š64ä½æœ‰ç¬¦å·æ•´å‹ </li><li>doubleï¼š64ä½æµ®ç‚¹æ•° </li><li>stringï¼šæœªçŸ¥ç¼–ç æˆ–è€…äºŒè¿›åˆ¶çš„å­—ç¬¦ä¸² </li><li>æ³¨æ„ï¼š<strong><em>thriftä¸æ”¯æŒæ— ç¬¦å·æ•´å½¢ï¼Œå› ä¸ºå¾ˆå¤šç›®æ ‡è¯­è¨€ä¸å­˜åœ¨æ— ç¬¦å·æ•´å½¢ï¼ˆæ¯”å¦‚javaï¼‰</em></strong> </li></ul><h4 id="2ã€å®¹å™¨ç±»å‹"><a href="#2ã€å®¹å™¨ç±»å‹" class="headerlink" title="2ã€å®¹å™¨ç±»å‹"></a>2ã€å®¹å™¨ç±»å‹</h4><ul><li>List<t1>ï¼šä¸€ç³»åˆ—t1ç±»å‹çš„å…ƒç´ ç»„æˆçš„æœ‰åºåˆ—è¡¨ï¼Œå…ƒç´ å¯ä»¥é‡å¤ï¼Œæ˜ å°„åˆ°Javaçš„ArrayListï¼Œc++çš„vectorï¼Œè„šæœ¬è¯­è¨€çš„Arraysç­‰ã€‚ </t1></li><li>Set<t1>ï¼šä¸€äº›t1ç±»å‹çš„å…ƒç´ ç»„æˆçš„æ— åºé›†åˆï¼Œå…ƒç´ å”¯ä¸€ä¸é‡å¤ï¼Œæ˜ å°„åˆ°Javaçš„HashSetï¼Œc++çš„STLä¸­çš„setã€‚ </t1></li><li>Map&lt;t1,t2&gt;ï¼škey/valueå¯¹ï¼Œkeyå”¯ä¸€ï¼Œæ˜ å°„åˆ°Javaçš„HashMapï¼Œ c++çš„STLä¸­çš„mapã€‚ </li><li>å®¹å™¨ä¸­çš„å…ƒç´ ç±»å‹å¯ä»¥æ˜¯é™¤serviceä»¥å¤–çš„ä»»ä½•åˆæ³•çš„thriftç±»å‹ï¼ŒåŒ…æ‹¬ç»“æ„ä½“å’Œå¼‚å¸¸ç±»å‹ ã€‚</li></ul><h4 id="3ã€ç»“æ„ä½“å’Œå¼‚å¸¸"><a href="#3ã€ç»“æ„ä½“å’Œå¼‚å¸¸" class="headerlink" title="3ã€ç»“æ„ä½“å’Œå¼‚å¸¸"></a>3ã€ç»“æ„ä½“å’Œå¼‚å¸¸</h4><ul><li>Thriftç»“æ„ä½“åœ¨æ¦‚å¿µä¸ŠåŒcè¯­è¨€çš„<strong>ç»“æ„ä½“</strong>ç±»ä¼¼ï¼Œåœ¨é¢å‘å¯¹è±¡è¯­è¨€ä¸­ï¼Œthriftç»“æ„ä½“å°†è¢«è½¬åŒ–ä¸º<strong>ç±»</strong>ã€‚ </li><li>thrift ç»“æ„ä½“ä¹‹é—´<strong><em>ä¸èƒ½ç»§æ‰¿</em></strong>ï¼Œæ¯ä¸ªç»“æ„ä½“éƒ½æœ‰ä¸€ç»„ç±»å‹å®šä¹‰çš„å­—æ®µï¼Œæ¯ä¸ª field éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å‘½åæ ‡è¯†ç¬¦ã€‚ </li><li>å¼‚å¸¸åœ¨è¯­æ³•å’ŒåŠŸèƒ½ä¸Šç±»ä¼¼äºç»“æ„ä½“ï¼Œåªæ˜¯å¼‚å¸¸ä½¿ç”¨å…³é”®å­—<code>exception</code>è€Œä¸æ˜¯structå…³é”®å­—æ¥å£°æ˜ã€‚ä½†å®ƒåœ¨è¯­ä¹‰ä¸Šä¸åŒäºç»“æ„ä½“ï¼Œå½“å®šä¹‰ä¸€ä¸ªRPCæœåŠ¡æ—¶ï¼Œå¼€å‘è€…å¯èƒ½éœ€è¦å£°æ˜ä¸€ä¸ªè¿œç¨‹æ–¹æ³•æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ </li><li>å¼‚å¸¸å¯ä»¥ç»§æ‰¿ç›®æ ‡ç¼–ç¨‹è¯­è¨€çš„å¼‚å¸¸ç±»ï¼Œç›®çš„æ˜¯ä¸ç»™å®šç¼–ç¨‹è¯­è¨€çš„å¼‚å¸¸å¤„ç†åŠŸèƒ½æ— ç¼çš„ç»“åˆã€‚ </li></ul><h4 id="4ã€æœåŠ¡"><a href="#4ã€æœåŠ¡" class="headerlink" title="4ã€æœåŠ¡"></a>4ã€æœåŠ¡</h4><ul><li>Thriftä¸­æœåŠ¡å®šä¹‰çš„æ–¹å¼å’Œè¯­æ³•ç­‰åŒäºé¢å‘å¯¹è±¡è¯­è¨€ä¸­å®šä¹‰<strong>æ¥å£</strong>ã€‚Thriftç¼–è¯‘å™¨ä¼šäº§ç”Ÿå®ç°æ¥å£çš„clientå’Œserver stubsã€‚ </li><li>ä¸€ä¸ªæœåŠ¡åŒ…æ‹¬ä¸€ä¸ªå‘½åçš„ functions é›†åˆï¼Œæ¯ä¸ª function æœ‰ä¸€ä¸ª<strong>å‚æ•°åˆ—è¡¨</strong>ï¼Œä¸€ä¸ª<strong>è¿”å›å€¼</strong>ä»¥åŠæŠ›å‡ºæˆ–äº§ç”Ÿçš„ä¸€ä¸ª<strong>å¼‚å¸¸åˆ—è¡¨</strong>ã€‚è¿™äº›å¼‚å¸¸æ˜¯ thrift æœ¬èº«çš„<code>exception</code>ç±»å‹ã€‚ </li><li>æ³¨æ„ï¼š void æ˜¯ä¸€ç§ç¡®å®šçš„ function è¿”å›å€¼ç±»å‹ï¼Œ<strong><em>oneway å…³é”®è¯ï¼ˆåŠ åœ¨ void ä¹‹å‰ï¼‰ç­‰åŒäº <u>async</u></em></strong>ï¼Œè¿™ç§æ–¹æ³•äº§ç”Ÿçš„å®¢æˆ·ç«¯ä»£ç æ— éœ€ç­‰å¾… server ç«¯çš„å“åº”ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰ã€‚ </li><li>å•çº¯çš„ void å‡½æ•°å°†ä¼šä¸º client è¿”å›ä¸€ä¸ªç¡®è®¤ï¼Œç”¨äºè¡¨ç¤ºæ“ä½œåœ¨ server ç«¯å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ </li><li><strong><em>å½“è°ƒç”¨ oneway æ–¹æ³•æ—¶ï¼Œclient ç«¯åªä¿è¯ request å·²æˆåŠŸå‘é€è‡³ transport å±‚ï¼Œä¸èƒ½ä¿è¯ server ç«¯çœ‹åˆ°è¿‡è¿™ä¸ª messageï¼Œå•ä¸ª client connection çš„ oneway/async æ–¹æ³•å¯ä»¥åœ¨ server ç«¯å¹¶è¡Œæ‰§è¡Œã€‚</em></strong>  </li></ul><p>####5ã€ç±»å‹é‡å®šä¹‰</p><ul><li>Thriftæ”¯æŒC/C++é£æ ¼çš„typedef: <code>typedef i32 MyInteger /*a typedef Tweet ReTweet*/</code></li><li>è¯´æ˜ï¼šæœ«å°¾æ²¡æœ‰é€—å·ã€åˆ†å·ï¼Œstructå¯ä»¥ä½¿ç”¨typedef </li></ul><h3 id="ä¸‰ã€æ•°æ®ç»“æ„å®šä¹‰"><a href="#ä¸‰ã€æ•°æ®ç»“æ„å®šä¹‰" class="headerlink" title="ä¸‰ã€æ•°æ®ç»“æ„å®šä¹‰"></a>ä¸‰ã€æ•°æ®ç»“æ„å®šä¹‰</h3><h4 id="1ã€å¸¸é‡"><a href="#1ã€å¸¸é‡" class="headerlink" title="1ã€å¸¸é‡"></a>1ã€å¸¸é‡</h4><p>â€‹    Thriftå…è®¸ç”¨æˆ·å®šä¹‰å¸¸é‡ï¼Œå¤æ‚çš„ç±»å‹å’Œç»“æ„ä½“å¯ä»¥ä½¿ç”¨JSONå½¢å¼è¡¨ç¤ºï¼š </p><ul><li><code>const i32 INT_CONST = 1234;</code>  </li><li><code>const map&lt;string,string&gt; MAP_CONST = {&quot;hello&quot;: &quot;world&quot;, &quot;goodnight&quot;: &quot;moon&quot;}</code></li><li>è¯´æ˜ï¼š<strong>åˆ†å·æ˜¯å¯é€‰çš„</strong>ï¼Œæ”¯æŒåå…­è¿›åˆ¶èµ‹å€¼ </li></ul><h4 id="2ã€æšä¸¾ç±»å‹"><a href="#2ã€æšä¸¾ç±»å‹" class="headerlink" title="2ã€æšä¸¾ç±»å‹"></a>2ã€æšä¸¾ç±»å‹</h4><p>å¯ä»¥åƒC/C++é‚£æ ·å®šä¹‰æšä¸¾ç±»å‹ï¼Œå¦‚ï¼š </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> TweetType</span><br><span class="line">&#123;</span><br><span class="line">TWEET,</span><br><span class="line">RETWEET = <span class="number">2</span>,</span><br><span class="line">DM = <span class="number">0xa</span>,</span><br><span class="line">REPLY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¼–è¯‘å™¨é»˜è®¤ä»0å¼€å§‹èµ‹å€¼ </li><li>å¯ä»¥èµ‹äºˆæŸä¸ªå¸¸é‡ </li><li>å…è®¸å¸¸é‡æ˜¯åå…­è¿›åˆ¶æ•´æ•° </li><li>ç»™å¸¸é‡èµ‹ç¼ºçœå€¼æ—¶ï¼Œä½¿ç”¨å¸¸é‡çš„å…¨ç§° </li><li>ä¸åŒäºprotocol bufferï¼Œ<strong>thriftä¸æ”¯æŒæšä¸¾ç±»åµŒå¥—ï¼Œæšä¸¾å¸¸é‡å¿…é¡»æ˜¯32ä½æ­£æ•´æ•°</strong> </li></ul><h4 id="3ã€å®šä¹‰ç»“æ„ä½“"><a href="#3ã€å®šä¹‰ç»“æ„ä½“" class="headerlink" title="3ã€å®šä¹‰ç»“æ„ä½“"></a>3ã€å®šä¹‰ç»“æ„ä½“</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tweet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="number">1</span>: required i32 userId;                  <span class="comment">// a</span></span><br><span class="line">    <span class="number">2</span>: required <span class="built_in">string</span> userName;             <span class="comment">// b</span></span><br><span class="line">    <span class="number">3</span>: required <span class="built_in">string</span> text;</span><br><span class="line">    <span class="number">4</span>: optional Location loc;                <span class="comment">// c</span></span><br><span class="line">    <span class="number">16</span>: optional <span class="built_in">string</span> language = <span class="string">"english"</span> <span class="comment">// d</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Location</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">1</span>: required <span class="keyword">double</span> latitude;</span><br><span class="line">    <span class="number">2</span>: required <span class="keyword">double</span> longitude;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¯ä¸€ä¸ªåŸŸéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ­£æ•´æ•°æ ‡è¯†ç¬¦ï¼ˆå¦‚ç¤ºä¾‹ä¸­å†’å·å‰çš„æ•°å­—ï¼‰ï¼Œç§°ä¸ºæ•°å­—æ ‡ç­¾ï¼Œè¿™äº›æ•°å­—æ ‡ç­¾åœ¨ä¼ è¾“æ—¶ç”¨æ¥ç¡®å®šåºåˆ—åŒ–é¡ºåºï¼Œä¸€æ—¦ä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œæ ‡ç­¾ä¸å¯æ”¹å˜ã€‚ï¼ˆéšç€é¡¹ç›®çš„è¿›å±•ï¼Œå¯ä»¥å˜æ›´Thriftæ–‡ä»¶ï¼Œæœ€å¥½ä¸è¦æ”¹å˜åŸæœ‰çš„æ•°å­—æ ‡ç­¾ï¼‰ </li><li>æ¯ä¸ªåŸŸå¯ä»¥æ ‡è¯†ä¸º<code>requiredï¼ˆå¿…é€‰çš„ï¼‰</code>æˆ–è€…<code>optional(å¯é€‰çš„)</code>ï¼ˆä¹Ÿå¯ä»¥ä¸æ³¨æ˜ï¼‰ </li><li>ç»“æ„ä½“å¯ä»¥åŒ…å«å…¶ä»–ç»“æ„ä½“ </li><li>åŸŸå¯ä»¥æœ‰ç¼ºçœå€¼ </li><li>ä¸€ä¸ªthriftä¸­å¯ä»¥å®šä¹‰å¤šä¸ªç»“æ„ä½“ï¼Œå¹¶å­˜åœ¨å¼•ç”¨å…³ç³» </li><li>è§„èŒƒçš„structå®šä¹‰ä¸­çš„æ¯ä¸ªåŸŸå‡ä¼šä½¿ç”¨requiredæˆ–è€…optionalå…³é”®å­—è¿›è¡Œæ ‡è¯†ã€‚å¦‚æœrequiredæ ‡è¯†çš„åŸŸæ²¡æœ‰èµ‹å€¼ï¼Œthriftå°†ç»™äºˆæç¤ºã€‚<strong>å¦‚æœoptionalæ ‡è¯†çš„åŸŸæ²¡æœ‰èµ‹å€¼ï¼Œè¯¥åŸŸå°†ä¸ä¼šè¢«åºåˆ—åŒ–ä¼ è¾“</strong>ã€‚å¦‚æœæŸä¸ªoptionalæ ‡è¯†åŸŸæœ‰ç¼ºçœå€¼è€Œç”¨æˆ·æ²¡æœ‰é‡æ–°èµ‹å€¼ï¼Œåˆ™è¯¥åŸŸçš„å€¼ä¸€ç›´ä¸ºç¼ºçœå€¼ã€‚ </li><li>ä¸serviceä¸åŒï¼Œ<strong><em>ç»“æ„ä½“ä¸æ”¯æŒç»§æ‰¿</em></strong>ï¼Œå³ä¸€ä¸ªç»“æ„ä½“ä¸èƒ½ç»§æ‰¿å¦ä¸€ä¸ªç»“æ„ä½“ã€‚ </li></ul><h4 id="4ã€å®šä¹‰æœåŠ¡"><a href="#4ã€å®šä¹‰æœåŠ¡" class="headerlink" title="4ã€å®šä¹‰æœåŠ¡"></a>4ã€å®šä¹‰æœåŠ¡</h4><p>â€‹        åœ¨æµè¡Œçš„åºåˆ—åŒ–/ååºåˆ—åŒ–æ¡†æ¶ï¼ˆå¦‚protocol bufferï¼‰ä¸­ï¼Œthriftæ˜¯å°‘æœ‰çš„æä¾›å¤šè¯­è¨€é—´RPCæœåŠ¡çš„æ¡†æ¶ã€‚Thriftç¼–è¯‘å™¨ä¼šæ ¹æ®é€‰æ‹©çš„ç›®æ ‡è¯­è¨€ä¸ºserveräº§ç”ŸæœåŠ¡æ¥å£ä»£ç ï¼Œä¸ºclientäº§ç”Ÿæ¡©ä»£ç ã€‚ </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//â€œTwitterâ€ä¸â€œ&#123;â€ä¹‹é—´éœ€è¦æœ‰ç©ºæ ¼ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment">//æ–¹æ³•å®šä¹‰æ–¹å¼ç±»ä¼¼äºCè¯­è¨€ä¸­çš„æ–¹å¼ï¼Œå®ƒæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸€ç³»åˆ—å‚æ•°å’Œå¯é€‰çš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">//æ³¨æ„ï¼Œå‚æ•°åˆ—è¡¨å’Œå¼‚å¸¸åˆ—è¡¨å®šä¹‰æ–¹å¼ä¸ç»“æ„ä½“ä¸­åŸŸå®šä¹‰æ–¹å¼ä¸€è‡´</span></span><br><span class="line"><span class="comment">//â€onewayâ€æ ‡è¯†ç¬¦è¡¨ç¤ºclientå‘å‡ºè¯·æ±‚åä¸å¿…ç­‰å¾…å›å¤ï¼ˆéé˜»å¡ï¼‰ç›´æ¥è¿›è¡Œä¸‹é¢çš„æ“ä½œï¼Œâ€onewayâ€æ–¹æ³•çš„è¿”å›å€¼å¿…é¡»æ˜¯void</span></span><br><span class="line">service Twitter &#123;</span><br><span class="line">void ping(),                                    // a</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">postTweet</span><span class="params">(<span class="number">1</span>:Tweet tweet)</span></span>;                  <span class="comment">// b</span></span><br><span class="line"><span class="function">TweetSearchResult <span class="title">searchTweets</span><span class="params">(<span class="number">1</span>:<span class="built_in">string</span> query)</span></span>; <span class="comment">// c</span></span><br><span class="line"><span class="function">oneway <span class="keyword">void</span> <span class="title">zip</span><span class="params">()</span>                               <span class="comment">// d</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°å®šä¹‰å¯ä»¥ä½¿ç”¨<strong>é€—å·</strong>æˆ–<strong>åˆ†å·</strong>æ ‡è¯†ç»“æŸ </li><li>å‚æ•°å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…ç»“æ„ä½“ï¼Œå‚æ•°åªèƒ½æ˜¯åªè¯»çš„ï¼ˆconstï¼‰ï¼Œä¸å¯ä»¥ä½œä¸ºè¿”å›å€¼ï¼ˆå‚æ•°ä¸å¯æºå¸¦æ•°æ®è¿”å›ï¼‰ </li><li>è¿”å›å€¼å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…ç»“æ„ä½“ </li><li>è¿”å›å€¼å¯ä»¥æ˜¯void </li><li>Serviceæ”¯æŒç»§æ‰¿ï¼Œä¸€ä¸ªserviceå¯ä½¿ç”¨extendså…³é”®å­—ç»§æ‰¿å¦ä¸€ä¸ªservice </li></ul><h3 id="å››ã€æ³¨é‡Šã€å‘½åç©ºé—´ã€æ–‡ä»¶åŒ…å«"><a href="#å››ã€æ³¨é‡Šã€å‘½åç©ºé—´ã€æ–‡ä»¶åŒ…å«" class="headerlink" title="å››ã€æ³¨é‡Šã€å‘½åç©ºé—´ã€æ–‡ä»¶åŒ…å«"></a>å››ã€æ³¨é‡Šã€å‘½åç©ºé—´ã€æ–‡ä»¶åŒ…å«</h3><h4 id="1ã€æ³¨é‡Š"><a href="#1ã€æ³¨é‡Š" class="headerlink" title="1ã€æ³¨é‡Š"></a>1ã€æ³¨é‡Š</h4><p>Thriftæ”¯æŒshellæ³¨é‡Šé£æ ¼ã€C/C++è¯­è¨€ä¸­çš„å•è¡Œæˆ–å¤šè¡Œæ³¨é‡Šé£æ ¼</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># This is a valid comment.  shellé£æ ¼æ³¨é‡Š</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This is a multi-line comment.</span></span><br><span class="line"><span class="comment">* Just like in C.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// C++/Java style single-line comments work just as well.</span></span><br></pre></td></tr></table></figure><h4 id="2ã€å‘½åç©ºé—´"><a href="#2ã€å‘½åç©ºé—´" class="headerlink" title="2ã€å‘½åç©ºé—´"></a>2ã€å‘½åç©ºé—´</h4><p>â€‹       Thriftä¸­çš„å‘½åç©ºé—´åŒC++ä¸­çš„namespaceå’Œjavaä¸­çš„packageç±»ä¼¼ï¼Œå®ƒä»¬å‡æä¾›äº†ä¸€ç§ç»„ç»‡ï¼ˆéš”ç¦»ï¼‰ä»£ç çš„æ–¹å¼ã€‚å› ä¸ºæ¯ç§è¯­è¨€å‡æœ‰è‡ªå·±çš„å‘½åç©ºé—´å®šä¹‰æ–¹å¼ï¼ˆå¦‚pythonä¸­æœ‰moduleï¼‰ï¼Œthriftå…è®¸å¼€å‘è€…é’ˆå¯¹ç‰¹å®šè¯­è¨€å®šä¹‰namespaceï¼š </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> cpp com.example.project  <span class="comment">// a</span></span><br><span class="line"><span class="keyword">namespace</span> java com.example.project <span class="comment">// b</span></span><br></pre></td></tr></table></figure><h4 id="3ã€æ–‡ä»¶åŒ…å«"><a href="#3ã€æ–‡ä»¶åŒ…å«" class="headerlink" title="3ã€æ–‡ä»¶åŒ…å«"></a>3ã€æ–‡ä»¶åŒ…å«</h4><p>Thriftå…è®¸æ–‡ä»¶åŒ…å«ï¼Œéœ€è¦ä½¿ç”¨thriftæ–‡ä»¶åä½œä¸ºå‰ç¼€è®¿é—®è¢«åŒ…å«çš„å¯¹è±¡ï¼Œå¦‚ï¼š </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"tweet.thrift"</span>           <span class="comment">// a</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TweetSearchResult</span> &#123;</span></span><br><span class="line"><span class="number">1</span>: <span class="built_in">list</span>&lt;tweet.Tweet&gt; tweets; <span class="comment">// b</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>thriftæ–‡ä»¶åéœ€è¦åŒå¼•å·åŒ…å«ï¼Œæœ«å°¾æ²¡æœ‰é€—å·æˆ–è€…åˆ†å· </li><li>æ³¨æ„tweetå‰ç¼€ ï¼Œå‰ç¼€ä¸ºå¼•å…¥çš„thriftæ–‡ä»¶åï¼ˆä¸å«åç¼€ï¼‰</li></ul>]]></content>
    
    <summary type="html">
    
      Thrift is an interface definition language and binary communication protocol used for defining and creating services for numerous languages. It forms a remote procedure call (RPC) framework and was developed at Facebook for &quot;scalable cross-language services development&quot;.
    
    </summary>
    
      <category term="åç«¯å¼€å‘åŸºç¡€" scheme="http://blog.zjee.ml/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="thrift" scheme="http://blog.zjee.ml/tags/thrift/"/>
    
      <category term="rpc" scheme="http://blog.zjee.ml/tags/rpc/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç ç‰ˆæœ¬æ§åˆ¶ç³»ç»ŸGit</title>
    <link href="http://blog.zjee.ml/2018/11/29/learn-git/"/>
    <id>http://blog.zjee.ml/2018/11/29/learn-git/</id>
    <published>2018-11-29T05:20:32.000Z</published>
    <updated>2019-12-28T14:53:56.906Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1ã€åˆ›å»ºæœ¬åœ°ä»“åº“çš„ä¸¤ç§é€”å¾„ï¼š"><a href="#1ã€åˆ›å»ºæœ¬åœ°ä»“åº“çš„ä¸¤ç§é€”å¾„ï¼š" class="headerlink" title="1ã€åˆ›å»ºæœ¬åœ°ä»“åº“çš„ä¸¤ç§é€”å¾„ï¼š"></a>1ã€åˆ›å»ºæœ¬åœ°ä»“åº“çš„ä¸¤ç§é€”å¾„ï¼š</h4><ol><li><p>ä»è¿œç¨‹ä»“åº“å…‹éš†ä¸€ä»½ï¼š<code>git clone [remote git url]</code></p></li><li><p>åˆ›å»ºä¸€ä¸ªç›®å½•ï¼š<code>mkdir git</code>, ç„¶åç”¨ <code>git init</code> å»åˆå§‹åŒ–è¿™ä¸ªç›®å½•ï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªgitä»“åº“ã€‚</p></li></ol><h4 id="2ã€git-configæ–‡ä»¶é…ç½®ï¼š"><a href="#2ã€git-configæ–‡ä»¶é…ç½®ï¼š" class="headerlink" title="2ã€git configæ–‡ä»¶é…ç½®ï¼š"></a>2ã€git configæ–‡ä»¶é…ç½®ï¼š</h4><ol><li>é…ç½®å…¨å±€ç”¨æˆ·åï¼š<code>git config --global user.name &quot;xxxxxx&quot;</code></li><li>é…ç½®å…¨å±€E-mailï¼š<code>git config --global user.email &quot;xxxxxx@xx.com&quot;</code>, å¦‚æœéœ€è¦åœ¨é¡¹ç›®ä¸­é…ç½®ä¸åŒçš„ç”¨æˆ·åå’Œé‚®ä»¶ï¼Œåˆ™åªéœ€è¦åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ï¼Œä¸å¸¦ <code>--global</code> å³å¯ã€‚</li><li>æŸ¥çœ‹é…ç½®æ–‡ä»¶: <code>git config --list</code></li></ol><h4 id="3ã€å°†æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“å…³è”ï¼ˆé€‚ç”¨äºgit-initåˆ›å»ºçš„ä»“åº“ï¼‰ï¼š"><a href="#3ã€å°†æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“å…³è”ï¼ˆé€‚ç”¨äºgit-initåˆ›å»ºçš„ä»“åº“ï¼‰ï¼š" class="headerlink" title="3ã€å°†æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“å…³è”ï¼ˆé€‚ç”¨äºgit initåˆ›å»ºçš„ä»“åº“ï¼‰ï¼š"></a>3ã€å°†æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“å…³è”ï¼ˆé€‚ç”¨äºgit initåˆ›å»ºçš„ä»“åº“ï¼‰ï¼š</h4><ol><li>æ·»åŠ è¿œç¨‹ä»“åº“ï¼š<code>git remote add [host-name] [git-url]</code>, ä¸€èˆ¬host-nameå–<code>origin</code>, è¿™ä¹Ÿæ˜¯gité»˜è®¤ä¸»æœºåã€‚</li><li>æ‹‰å–æœ¬åœ°è¿˜æ²¡æœ‰çš„è¿œç¨‹ä»“åº“çš„ä¿¡æ¯ï¼š<code>git fetch [host-name] [branch-name]</code>,ä»è¿œç¨‹ä»“åº“ä¸‹è½½åˆ¶å®šåˆ†æ”¯çš„ä¿¡æ¯åˆ°æœ¬åœ°ï¼Œä½†ä¸ä¼šä¸æœ¬åœ°çš„ä»“åº“åˆå¹¶ï¼Œéœ€æ‰‹åŠ¨åˆå¹¶<code>git merge [host-name] [branch-name]</code>ï¼Œå¦‚ï¼š<code>git fetch origin dev; git merge origin dev;</code></li><li>æ‹‰å–è¿œç¨‹ä¿¡æ¯ï¼Œå¹¶å°è¯•ä¸æœ¬åœ°åˆå¹¶(ç›¸å½“äºfetchå’Œmergeçš„åˆä½“)ï¼š<code>git pull [host-name] [branch-name]</code>, æœ‰å†²çªéœ€æ‰‹åŠ¨è§£å†³å†æ‰‹åŠ¨åˆå¹¶ã€‚</li><li>æŸ¥çœ‹è¿œç¨‹ä»“åº“ä¿¡æ¯ï¼š<code>git remote -v</code>ã€‚</li></ol><h4 id="4ã€å°†æœ¬åœ°ä¿¡æ¯æ¨é€åˆ°è¿œç¨‹"><a href="#4ã€å°†æœ¬åœ°ä¿¡æ¯æ¨é€åˆ°è¿œç¨‹" class="headerlink" title="4ã€å°†æœ¬åœ°ä¿¡æ¯æ¨é€åˆ°è¿œç¨‹"></a>4ã€å°†æœ¬åœ°ä¿¡æ¯æ¨é€åˆ°è¿œç¨‹</h4><ol><li><code>git push [host] [branch]</code>ï¼Œå¦‚æœè¿œç¨‹æ²¡æœ‰å¯¹åº”åˆ†æ”¯ï¼Œåˆ™éœ€è¦å¸¦ä¸Š <code>-u</code> å‚æ•°åˆ›å»ºç›¸åº”åˆ†æ”¯ã€‚</li><li>å¦‚æœæœ¬åœ°åˆ†æ”¯æ²¡æœ‰ä¸è¿œç¨‹åˆ†æ”¯å…³è”ï¼Œåˆ™éœ€è¦ï¼š<code>git branch --set-upstream [remote-branch]</code>å»ºç«‹å…³è”ã€‚</li><li>å¦‚æœè¿œç¨‹åˆ†æ”¯æœ‰å…¶ä»–äººæäº¤è¿‡ï¼Œåˆ™å¿…é¡»å…ˆ<code>git pull</code>,å°è¯•ä¸æœ¬åœ°åˆå¹¶åˆå¹¶ï¼ˆæœ‰å†²çªè§£å†³å†²çªï¼‰åæ‰å¯ä»¥pushã€‚</li></ol><h4 id="5ã€æ·»åŠ æ–‡ä»¶ï¼Œä¿®æ”¹ï¼Œæäº¤ä¿®æ”¹"><a href="#5ã€æ·»åŠ æ–‡ä»¶ï¼Œä¿®æ”¹ï¼Œæäº¤ä¿®æ”¹" class="headerlink" title="5ã€æ·»åŠ æ–‡ä»¶ï¼Œä¿®æ”¹ï¼Œæäº¤ä¿®æ”¹"></a>5ã€æ·»åŠ æ–‡ä»¶ï¼Œä¿®æ”¹ï¼Œæäº¤ä¿®æ”¹</h4><ol><li>æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒºï¼š<code>git add [file-name or directory-name]</code>,å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ã€‚</li><li>æ‰€æœ‰åšçš„ä¿®æ”¹éƒ½éœ€è¦ä½¿ç”¨<code>git add</code>ååœ¨è¿›è¡Œ<code>git commit</code>æ“ä½œã€‚</li><li>æäº¤ä¿®æ”¹åˆ°æœ¬åœ°ä»“åº“ï¼š<code>git commit -m &#39;è¯´æ˜ä¿¡æ¯&#39;</code>ã€‚</li><li>æ’¤é”€ä¿®æ”¹/æ¢å¤åˆ é™¤æ–‡ä»¶ï¼š<code>git check --[file-name]</code>ï¼Œæ³¨æ„ä¸¤ä¸ªâ€™-â€˜ã€‚</li><li>æŸ¥çœ‹gitçŠ¶æ€ï¼š<code>git status</code>ã€‚</li><li>æŸ¥çœ‹commitæ—¥å¿—ï¼š<code>git log</code>ï¼Œå•è¡Œæ˜¾ç¤ºï¼š<code>git log --pretty=oneline</code>ã€‚</li><li>æŸ¥çœ‹ä¸Šæ¬¡çš„ä¿®æ”¹ï¼š<code>git diff file-name</code>ã€‚</li><li>ä»æš‚å­˜åŒºåˆ é™¤ä¸€ä¸ªæ–‡ä»¶ï¼š<code>git rm file-name</code>ã€‚</li></ol><h4 id="6ã€åˆ›å»ºã€åˆ‡æ¢åˆ†æ”¯"><a href="#6ã€åˆ›å»ºã€åˆ‡æ¢åˆ†æ”¯" class="headerlink" title="6ã€åˆ›å»ºã€åˆ‡æ¢åˆ†æ”¯"></a>6ã€åˆ›å»ºã€åˆ‡æ¢åˆ†æ”¯</h4><ol><li>åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ï¼š<code>git checkout -b [branch-name]</code>ï¼Œä»–ç›¸å½“äº<code>git branch [branch-name]; git checkout [branch-name];</code>ã€‚</li><li>åˆ‡æ¢åˆ†æ”¯ï¼š<code>git checkout [branch-name]</code>ã€‚</li><li>åˆ é™¤åˆ†æ”¯ï¼š<code>git branch -d &lt;name&gt;</code>ï¼Œä½¿ç”¨<code>-D</code>å¼ºè¡Œåˆ é™¤ã€‚</li><li>æŸ¥çœ‹åˆ†æ”¯åˆå¹¶æƒ…å†µï¼š<code>git log --graph --pretty=oneline --abbrev-commit</code></li></ol><h4 id="7ã€ç‰ˆæœ¬å›é€€"><a href="#7ã€ç‰ˆæœ¬å›é€€" class="headerlink" title="7ã€ç‰ˆæœ¬å›é€€"></a>7ã€ç‰ˆæœ¬å›é€€</h4><ol><li>æœ¬åœ°ä»“åº“å›é€€ï¼š<code>git reset --hard HEAD^</code>ï¼Œä¸€ä¸ª<code>^</code>è¡¨ç¤ºå›é€€ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸¤ä¸ª<code>^^</code>è¡¨ç¤ºå›é€€ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€æ¬¡ç±»æ¨ï¼Œå›é€€100ä¸ªç‰ˆæœ¬å¯ä»¥è¿™æ ·å†™<code>HEAD~100</code>ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå›é€€åˆ°å…·ä½“æŸä¸ªç‰ˆæœ¬<code>git reset --hard 1094adb</code>ã€‚</li><li>é‡è¿”æœªæ¥ï¼šä½¿ç”¨<code>git reflog</code>æŸ¥çœ‹æ“ä½œå†å²ï¼Œæ‰¾åˆ°è¦å›å»çš„ç‰ˆæœ¬å·ï¼Œä½¿ç”¨1ä¸­å‘½ä»¤å³å¯å›åˆ°æœªæ¥ã€‚</li></ol><h4 id="8ã€ä¿å­˜å·¥ä½œç°åœº"><a href="#8ã€ä¿å­˜å·¥ä½œç°åœº" class="headerlink" title="8ã€ä¿å­˜å·¥ä½œç°åœº"></a>8ã€ä¿å­˜å·¥ä½œç°åœº</h4><ol><li><code>git stash</code>ï¼Œä¿å­˜å·¥ä½œç°åœºåï¼Œworking dirå°±æ˜¯å¹²å‡€çš„ï¼Œè¿™æ—¶å°±å¯ä»¥åˆ›å»ºåˆ«çš„åˆ†æ”¯ï¼Œè¿›è¡Œåˆ«çš„å·¥ä½œï¼Œæ¯”å¦‚ç´§æ€¥ä¿®å¤bugåœºæ™¯ã€‚PSï¼šå¦‚æœå½“å‰å·¥ä½œåŒºä¸å¹²å‡€gitä¸å…è®¸åˆ›å»ºæ–°çš„åˆ†æ”¯ã€‚</li><li>æ¢å¤å·¥ä½œåŒºï¼š<code>git stash pop</code>ï¼Œå®ƒç›¸å½“äº<code>git stash apply; git stash drop;</code>ï¼Œæ¢å¤å¹¶åˆ é™¤stashå†…å®¹ã€‚</li></ol><h4 id="9ã€æ ‡ç­¾ç®¡ç†"><a href="#9ã€æ ‡ç­¾ç®¡ç†" class="headerlink" title="9ã€æ ‡ç­¾ç®¡ç†"></a>9ã€æ ‡ç­¾ç®¡ç†</h4><ol><li>commitæ‰“æ ‡ç­¾ï¼š<code>$ git tag v0.9 [-m &#39;è¯´æ˜æ–‡å­—&#39;] f52c633</code>ï¼Œå¯ä»¥çœç•¥commitå·ï¼Œé»˜è®¤æ‰“åœ¨æœ€æ–°commitä¸Šã€‚</li><li>ä½¿ç”¨<code>git show tag-name</code>æŸ¥çœ‹è¯´æ˜æ–‡å­—ã€‚</li><li>ä½¿ç”¨<code>git tag</code>æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ã€‚</li><li>ä½¿ç”¨<code>git tag -d v0.1</code>åˆ é™¤æ ‡ç­¾ã€‚</li><li>å°†æ ‡ç­¾æ¨é€åˆ°è¿œç¨‹ï¼š<code>git push origin &lt;tagname&gt;</code>ï¼Œä½¿ç”¨<code>git push origin --tags</code>æ¨é€å…¨éƒ¨tagã€‚</li><li>ä½¿ç”¨<code>git push origin :refs/tags/&lt;tagname&gt;</code>å¯ä»¥åˆ é™¤ä¸€ä¸ªè¿œç¨‹æ ‡ç­¾ï¼Œéœ€è¦å…ˆåˆ é™¤æœ¬åœ°å¯¹åº”æ ‡ç­¾ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      Gitæ˜¯ç›®å‰ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç”¨äºæ•æ·é«˜æ•ˆåœ°å¤„ç†ä»»ä½•æˆ–å°æˆ–å¤§çš„é¡¹ç›®ã€‚å› æ­¤Gitä¹Ÿæ˜¯ç¨‹åºçŒ¿å…¥é—¨çš„å¿…å¤‡æŠ€èƒ½ä¹‹ä¸€ï¼Œæœ‰äº†å®ƒæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç çš„ä¸–ç•Œé‡Œç©¿è¶Šå¤ä»Šï¼Œè‡ªç”±ç¿±ç¿”ï¼
    
    </summary>
    
      <category term="åç«¯å¼€å‘åŸºç¡€" scheme="http://blog.zjee.ml/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="git" scheme="http://blog.zjee.ml/tags/git/"/>
    
  </entry>
  
</feed>
