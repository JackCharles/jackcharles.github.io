<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="HashMapæºç å…¨è§£æã€‚æœ¬æ¬¡ä»¥Oracle JDK1.8ä½œä¸ºç¤ºä¾‹ï¼Œæ·±å…¥è§£è¯»HashMapå®ç°åŸç†ï¼Œç²¾ç»†é˜…è¯»æ¯ä¸€è¡Œæºç ï¼Œå¹¶ç»“åˆå„äº’è”ç½‘å‚å•†çš„å¸¸è§é¢è¯•é—®é¢˜ï¼Œå¯¹HashMapçš„å®ç°æ–¹æ¡ˆã€æ€æƒ³ä»¥åŠä½¿ç”¨æ³¨æ„äº‹é¡¹åšæ·±å…¥æ¢è®¨ã€‚"><meta name="keywords" content="Javaæºç , HashMap, æ±Ÿå½±ä¸æ²‰æµ®"><link rel="alternate" href="/atom.xml" title="æ±Ÿå½±ä¸æ²‰æµ®"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://blog.zjee.ml/2019/12/29/hashmap-source-learning/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "hiuyEvHNGJv0HBzIgke1FOa2-MdYXbMMI",
      appKey: "W2WW9ah2D4zfyhW3aYtKw3xD"
    });
  </script><script>
  window.config = {"leancloud":{"app_id":"hiuyEvHNGJv0HBzIgke1FOa2-MdYXbMMI","app_key":"W2WW9ah2D4zfyhW3aYtKw3xD"},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>HashMapæºç å®Œå…¨è§£è¯» - æ±Ÿå½±ä¸æ²‰æµ®</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">æ±Ÿå½±ä¸æ²‰æµ®</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">æ±Ÿå½±ä¸æ²‰æµ®</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">HashMapæºç å®Œå…¨è§£è¯»
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-12-29
        </span><span class="post-category">
            <a href="/categories/Java/">Java</a>
            </span>
        <span class="post-visits" data-url="/2019/12/29/hashmap-source-learning/" data-title="HashMapæºç å®Œå…¨è§£è¯»">
          Visits 0
        </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸€ã€HashMapåŸºç¡€"><span class="toc-text">ä¸€ã€HashMapåŸºç¡€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼"><span class="toc-text">1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†"><span class="toc-text">2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–"><span class="toc-text">3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ"><span class="toc-text">4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5ã€-Setè§†å›¾ã€è¿­ä»£å™¨-Iterator-ä¸åˆ†å‰²å™¨-Spliterator"><span class="toc-text">5ã€ Setè§†å›¾ã€è¿­ä»£å™¨(Iterator)ä¸åˆ†å‰²å™¨(Spliterator)</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#äºŒã€-Java8æ–°ç‰¹æ€§"><span class="toc-text">äºŒã€ Java8æ–°ç‰¹æ€§</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸‰ã€-çº¢é»‘æ ‘ç›¸å…³æ“ä½œ"><span class="toc-text">ä¸‰ã€ çº¢é»‘æ ‘ç›¸å…³æ“ä½œ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å››ã€å…¶ä»–æ–¹æ³•"><span class="toc-text">å››ã€å…¶ä»–æ–¹æ³•</span></a></li>
    </div>
  </div><div class="post-content"><h1 id="ä¸€ã€HashMapåŸºç¡€"><a href="#ä¸€ã€HashMapåŸºç¡€" class="headerlink" title="ä¸€ã€HashMapåŸºç¡€"></a>ä¸€ã€HashMapåŸºç¡€</h1><h3 id="1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼"><a href="#1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼" class="headerlink" title="1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼"></a>1ã€HashMapæˆå‘˜å˜é‡åŠé»˜è®¤å€¼</h3><table>
<thead>
<tr>
<th style="text-align:center">åç§°</th>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">é»˜è®¤å€¼</th>
<th style="text-align:center">å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">DEFAULT_INITIAL_CAPACITY</td>
<td style="text-align:center">int</td>
<td style="text-align:center">1 &lt;&lt; 4 ( $2^{4}$ )</td>
<td style="text-align:center">é»˜è®¤åˆå§‹åŒ–å®¹é‡ (è¿™é‡Œçš„å®¹é‡æŒ‡tableçš„é•¿åº¦è€Œä¸æ˜¯sizeï¼Œä¸‹åŒ)</td>
</tr>
<tr>
<td style="text-align:center">MAXIMUM_CAPACITY</td>
<td style="text-align:center">int</td>
<td style="text-align:center">1 &lt;&lt; 30 ( $2^{30}$ )</td>
<td style="text-align:center">æœ€å¤§å®¹é‡ï¼ˆtableæœ€å¤§é•¿åº¦ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">DEFAULT_LOAD_FACTOR</td>
<td style="text-align:center">float</td>
<td style="text-align:center">0.75f</td>
<td style="text-align:center">é»˜è®¤åŠ è½½å› å­</td>
</tr>
<tr>
<td style="text-align:center">TREEIFY_THRESHOLD</td>
<td style="text-align:center">int</td>
<td style="text-align:center">8</td>
<td style="text-align:center">æ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦&gt;=è¯¥å€¼å°±è€ƒè™‘æ ‘å½¢åŒ–</td>
</tr>
<tr>
<td style="text-align:center">UNTREEIFY_THRESHOLD</td>
<td style="text-align:center">int</td>
<td style="text-align:center">6</td>
<td style="text-align:center">é“¾è¡¨åŒ–é˜ˆå€¼ï¼Œå¦‚æœæ ‘çš„èŠ‚ç‚¹æ•°&lt;=è¯¥å€¼å°±è€ƒè™‘è½¬æ¢ä¸ºé“¾è¡¨</td>
</tr>
<tr>
<td style="text-align:center">MIN_TREEIFY_CAPACITY</td>
<td style="text-align:center">int</td>
<td style="text-align:center">64</td>
<td style="text-align:center">æ ‘å½¢åŒ–éœ€è¦çš„æœ€å°å®¹é‡ï¼Œåªæœ‰tableçš„é•¿åº¦&gt;=è¯¥å€¼æ‰ä¼šæ ‘å½¢åŒ–</td>
</tr>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center">Node[]</td>
<td style="text-align:center">-</td>
<td style="text-align:center">hashæ¡¶ï¼Œæ˜ å°„ä¸åŒçš„hashåœ°å€</td>
</tr>
<tr>
<td style="text-align:center">entrySet</td>
<td style="text-align:center">Set&lt;Map.Entry&gt;</td>
<td style="text-align:center">-</td>
<td style="text-align:center">key-value setç¼“å­˜</td>
</tr>
<tr>
<td style="text-align:center">size</td>
<td style="text-align:center">int</td>
<td style="text-align:center">-</td>
<td style="text-align:center">mapåŒ…å«çš„k-vèŠ‚ç‚¹ä¸ªæ•°ï¼ˆä¸æ˜¯tableé•¿åº¦ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">modCount</td>
<td style="text-align:center">int</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Mapç»“æ„ä¿®æ”¹æ¬¡æ•°ï¼ˆç”¨äºå¿«é€Ÿå¤±è´¥ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">threshold</td>
<td style="text-align:center">int</td>
<td style="text-align:center">-</td>
<td style="text-align:center">åˆå§‹åŒ–å®¹é‡æˆ–capacity*loadFactor</td>
</tr>
<tr>
<td style="text-align:center">loadFactor</td>
<td style="text-align:center">float</td>
<td style="text-align:center">-</td>
<td style="text-align:center">åŠ è½½å› å­,å†³å®šä»€ä¹ˆæ—¶å€™è¯¥æ‰©å®¹</td>
</tr>
<tr>
<td style="text-align:center">keySet (from AbstrctMap)</td>
<td style="text-align:center">Set</td>
<td style="text-align:center">-</td>
<td style="text-align:center">key set ç¼“å­˜</td>
</tr>
<tr>
<td style="text-align:center">values(from AbstrctMap)</td>
<td style="text-align:center">Collection</td>
<td style="text-align:center">-</td>
<td style="text-align:center">values ç¼“å­˜</td>
</tr>
</tbody>
</table>
<h3 id="2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†"><a href="#2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†" class="headerlink" title="2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†"></a>2ã€HashMapå¸¸ç”¨æ–¹æ³•åŠå®ç°åŸç†</h3><ol>
<li>hashå€¼çš„è®¡ç®—ï¼šHashMapä¸­çš„hashä¸æ˜¯ç›´æ¥ä½¿ç”¨<code>Object.hashCode()</code>ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨è¿™åŸºç¡€ä¸Šå°†hashCodeçš„é«˜16ä½ä¸ä½16ä½è¿›è¡Œäº†ä¸€æ¬¡å¼‚æˆ–ã€‚è¿™ä¹ˆåšçš„åŸå› ä¸hashåœ°å€è®¡ç®—æ–¹å¼æœ‰å…³ï¼ŒHashMapçš„hashåœ°å€è®¡ç®—æ–¹å¼ä¸º<code>hash&amp;(table.length-1)</code>ï¼Œä»äºŒè¿›åˆ¶çš„è§’åº¦æ¥çœ‹ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰hashCodeçš„ä½å‡ ä½æœ‰æ•ˆå‚ä¸äº†åœ°å€è®¡ç®—ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœå¼€å‘äººå‘˜çš„hashCodeå®ç°ä¸å¤Ÿä¼˜è‰¯ï¼Œå°±ä¼šå­˜åœ¨æ•°æ®åˆ†å¸ƒä¸å‡çš„æƒ…å†µï¼Œè€Œé«˜16ä½ä¸ä½16ä½çš„å¼‚æˆ–å°†é«˜16ä½ç‰¹å¾å¸¦åˆ°ä½16ä½ï¼Œå¯ä»¥æœ€å¤§åŒ–ä¿è¯hashCodeåœ¨ä½ä½çš„å‡åŒ€åˆ†å¸ƒã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> h;</span><br><span class="line">	<span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);<span class="comment">//nullçš„hashä¸º0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>åˆ¤æ–­ä¼ å…¥çš„keyæ˜¯å¦å¯æ¯”è¾ƒå¤§å°ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ˜¯ä¸æ˜¯å¯æ¯”è¾ƒï¼Œè¿”å›nullè¡¨ç¤ºä¸å¯æ¯”è¾ƒï¼Œå¦åˆ™è¿”å›x.getClass()</span></span><br><span class="line"><span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line">  <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">    Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line">    <span class="comment">// Stringå¯æ¯”è¾ƒï¼Œç›´æ¥è¿”å›ï¼ˆStringç”¨çš„æœ€å¤šï¼Œæ‰€ä»¥è¿™é‡Œå•ç‹¬å¤„ç†ï¼ŒåŠ å¿«ç¨‹åºé€Ÿåº¦ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((c = x.getClass()) == String.class) </span><br><span class="line">      <span class="keyword">return</span> c;</span><br><span class="line">    <span class="comment">//è·å–è¯¥ç±»çš„æ¥å£ï¼Œå¦‚æœæ¥å£ä¸­æœ‰Comparable.class,å°±è¡¨ç¤ºxæ˜¯å¯æ¯”è¾ƒçš„ï¼Œç›´æ¥è¿”å›è¯¥class</span></span><br><span class="line">    <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;</span><br><span class="line">            ((p = (ParameterizedType)t).getRawType() ==</span><br><span class="line">             Comparable.class) &amp;&amp;</span><br><span class="line">            (as = p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c) <span class="comment">// type arg is c</span></span><br><span class="line">          <span class="keyword">return</span> c;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//ä¸å¯æ¯”è¾ƒçš„å¯¹è±¡ç›´æ¥è¿”å›null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡k, x</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;) <span class="comment">// for cast to Comparable</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareComparables</span><span class="params">(Class&lt;?&gt; kc, Object k, Object x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (x == <span class="keyword">null</span> || x.getClass() != kc ? <span class="number">0</span> : <span class="comment">//æ³¨æ„å¯¹nullå’Œclassä¸åŒæ—¶çš„å¤„ç†</span></span><br><span class="line">          ((Comparable)k).compareTo(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="3">
<li><p>æ ¹æ®ç»™å®šçš„å€¼é‡æ–°è®¡ç®—tableSizeï¼šè¿™ä¸€æ­¥æ˜¯æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„capacityåˆå§‹åŒ–ä¸ºç¦»capæœ€è¿‘çš„$2^{n}$çš„ä¸€ä¸ªå€¼ï¼Œä¿è¯capacityæ˜¯$2^{n}$çš„å½¢å¼ä¸»è¦ä¸ºäº†æ–¹ä¾¿hashåœ°å€è®¡ç®—å’Œæ‰©å®¹ã€‚</p>
<p><strong>ğŸ”¶</strong> è¯•æƒ³ä¸€ä¸‹å‡å¦‚åˆå§‹åŒ–å®¹é‡æ˜¯15ï¼Œæ ¹æ®hashåœ°å€çš„è®¡ç®—å…¬å¼<code>hash&amp;(n-1)</code>ï¼Œn-1ä¹Ÿå°±æ˜¯14ï¼Œå¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯1110ï¼Œåˆ™<code>hash&amp;1110</code>ç»“æœå¿…å®šæ˜¯<code>xxx0</code>å½¢å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç®—å‡ºçš„åœ°å€æœ€åä¸€ä½æ°¸è¿œæ˜¯0ï¼Œè½¬æ¢ä¸º10è¿›åˆ¶å°±å‘ç°å¥‡æ•°ä½çš„æ¡¶æ°¸è¿œåˆ†é…ä¸åˆ°èŠ‚ç‚¹ï¼Œè¿™ä¼šå¯¼è‡´HashMapä¸¥é‡åˆ†å¸ƒä¸å‡ã€‚</p>
<p><strong>ğŸ”¶</strong>  å¦ä¸€æ–¹é¢ï¼šæ‰©å®¹æ—¶ï¼Œæ–°å®¹é‡æ˜¯åŸå®¹é‡çš„2å€ï¼Œå¯¹äº<code>hash&amp;(n-1)</code>æ¥è¯´ï¼Œå°±ç›¸å½“äºn-1çš„äºŒè¿›åˆ¶å‘å·¦æ‰©å±•äº†1ä¸ª1ï¼Œæ¯”å¦‚(16-1)çš„äºŒè¿›åˆ¶æ˜¯<code>1111</code>ï¼Œæ‰©å®¹å(32-1)çš„äºŒè¿›åˆ¶<code>11111</code>ï¼Œä¸åŸhashåœ°å€ç›¸æ¯”è¾ƒåªæœ‰æœ€é«˜ä½çš„1å¸¦æ¥äº†å·®å¼‚ï¼Œè€Œhashä¸­ä¸ä¹‹å¯¹åº”çš„ä½åªæœ‰1å’Œ0ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥åŸé“¾è¡¨/çº¢é»‘æ ‘æœ€å¤šæ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨/çº¢é»‘æ ‘å°±å¯ä»¥äº†ï¼Œä¸”æ‹†åˆ†åçš„ä¸¤ä¸ªç»“æ„ï¼Œä¸€ä¸ªç•™åœ¨åŸåœ°(hashå¯¹åº”ä½ä¸º0)ï¼Œä¸€ä¸ªå‡åˆ°é«˜ä½ç½®(hashå¯¹åº”ä½ä¸º1)ï¼Œä¸”è¿™ä¸ªé«˜ä½æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯<code>hash&amp;(2n-1)</code>æˆ–è€…<code>hash&amp;(n-1)+n</code>ã€‚</p>
<p><strong>ğŸ”¶</strong>  è€Œå½“å®¹é‡è®¾ç½®ä¸º15æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°14ä¸29çš„äºŒè¿›åˆ¶å·®å¼‚å¾ˆå¤§ï¼Œè¿™å°±ç»™rehashçš„è¿‡ç¨‹å¸¦æ¥å¾ˆå¤§éº»çƒ¦å’Œä¸å¿…è¦çš„å¼€é”€ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¼ å…¥çš„capå˜ä¸ºç›¸è¿‘çš„2çš„xæ¬¡æ–¹çš„å½¢å¼</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">1</span>; <span class="comment">//å°†æœ€é«˜2ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">2</span>; <span class="comment">//å°†æœ€é«˜4ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">4</span>; <span class="comment">//å°†æœ€é«˜8ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">8</span>; <span class="comment">//å°†æœ€é«˜16ä½å˜ä¸º1</span></span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">16</span>; <span class="comment">//32ä½å…¨å˜ä¸º1(2^n-1)</span></span><br><span class="line">  <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;<span class="comment">//n+1å°±æ˜¯2^n</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p>
</li>
</ol>
<p></p>
<ol start="4">
<li>æ„é€ æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> + initialCapacity);</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">    initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">  <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> + loadFactor);</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">  <span class="comment">//æ³¨æ„ï¼šç”¨thresholdä¿å­˜åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">  <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">  putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="5">
<li>æ‰¹é‡put(putAll)<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰¹é‡putå…ƒç´ ï¼Œ å½“ä¸”ä»…å½“æ„é€ mapå¹¶æ‰¹é‡putæ—¶evictä¸ºfalse</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">putMapEntries</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m, <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s = m.size();<span class="comment">//ç°æœ‰Mapå…ƒç´ æ•°é‡</span></span><br><span class="line">  <span class="keyword">if</span> (s &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœtableè¿˜æœªåˆå§‹åŒ–</span></span><br><span class="line">      <span class="keyword">float</span> ft = ((<span class="keyword">float</span>)s / loadFactor) + <span class="number">1.0F</span>; <span class="comment">//è®¡ç®—éœ€è¦çš„å®¹é‡</span></span><br><span class="line">      <span class="keyword">int</span> t = ((ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">               (<span class="keyword">int</span>)ft : MAXIMUM_CAPACITY);</span><br><span class="line">      <span class="keyword">if</span> (t &gt; threshold) <span class="comment">//å¦‚æœéœ€è¦çš„å®¹é‡å¤§äºä¹‹å‰è®¾ç½®çš„åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">        threshold = tableSizeFor(t);<span class="comment">//å°±é‡æ–°ç¡®å®šä¸€ä¸ªæ¯”è¾ƒå¤§çš„åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœtableå·²ç»åˆå§‹åŒ–äº†ï¼Œä¸”è¦åŠ å…¥çš„å…ƒç´ æ•°é‡å¤§äºthresholdå°±ç›´æ¥æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s &gt; threshold) </span><br><span class="line">      resize();</span><br><span class="line">    <span class="comment">//æ”¾å…¥æ–°å…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;? extends K, ? extends V&gt; e : m.entrySet()) &#123;</span><br><span class="line">      K key = e.getKey();</span><br><span class="line">      V value = e.getValue();</span><br><span class="line">      putVal(hash(key), key, value, <span class="keyword">false</span>, evict);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="6">
<li>å…¬å…±å¸¸ç”¨æ–¹æ³•ï¼š<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Mapæ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®keyè·å–å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; e;</span><br><span class="line">  <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªkeyï¼Œä¸getæ–¹æ³•å®ç°ä¸€è‡´</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getNode(hash(key), key) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°åŠ å…¥ä¸€ä¸ªkay-valueå¯¹ï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨å°±è¿”å›ä¹‹å‰çš„valueï¼Œå¦åˆ™è¿”å›null</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠ å…¥å¦å¤–ä¸€ä¸ªMapçš„æ‰€æœ‰å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    putMapEntries(m, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤keyå…³è”çš„å…ƒç´ ï¼Œè¿”å›åˆ é™¤çš„å…ƒç´ ï¼Œå¦‚æœkeyä¸å­˜åœ¨åˆ™è¿”å›null</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>)) == <span class="keyword">null</span> ?</span><br><span class="line">        <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹ï¼ˆæ³¨æ„ï¼štable.lengthæ²¡å˜ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//å…¨éƒ¨ä¸tableè§£æŒ‚å°±è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i)</span><br><span class="line">            tab[i] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç»™å®šçš„valueï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; V v;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//éå†table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨/æ ‘ï¼ˆè¿™é‡Œå¯ä»¥çœ‹å‡ºæ ‘ä¹Ÿæœ‰ä¸€æ¡ç±»ä¼¼é“¾è¡¨è®¿é—®çš„è·¯å¾„ï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((v = e.value) == value ||</span><br><span class="line">                    (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="7">
<li>æ ¹æ®æŒ‡å®šçš„keyæŸ¥æ‰¾å¯¹åº”NodeèŠ‚ç‚¹ï¼Œæ‰¾ä¸åˆ°å¯¹åº”keyå°±è¿”å›<code>null</code>ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®ç»™å®šçš„keyè·å–èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">//å¦‚æœtableä¸ä¸ºç©ºä¸”å¯¹åº”hashåœ°å€çš„ç¬¬é¦–èŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹çš„hashå’Œkeyéƒ½ä¸æŸ¥è¯¢keyåŒ¹é…çš„è¯å°±ç›´æ¥è¿”å›é¦–èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">//å¦åˆ™æ£€æŸ¥é¦–èŠ‚ç‚¹ä¸‹é¢æ˜¯å¦è¿˜æœ‰èŠ‚ç‚¹ï¼Œæœ‰å…¶ä»–èŠ‚ç‚¹å°±ç»§ç»­æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹æ˜¯æ ‘çŠ¶èŠ‚ç‚¹ï¼Œå°±å»çº¢é»‘æ ‘ä¸­æŸ¥è¯¢</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">//å¦åˆ™å°±éå†é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ‰¾åˆ°æŸä¸ªkeyä¸ç»™å®škeyä¸€è‡´å°±è¿”å›è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="8">
<li>æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œå¹¶è¿”å›æ—§èŠ‚ç‚¹çš„å€¼ï¼Œæ—§èŠ‚ç‚¹ä¸å­˜åœ¨è¿”å›<code>null</code>ã€‚<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//onlyIfAbsentè¡¨ç¤ºæ˜¯å¦ä»…å½“keyä¸å­˜åœ¨æ—¶æ‰æ’å…¥ï¼Œevictä¸ºfalseè¡¨ç¤ºåœ¨åˆå§‹åŒ–(åˆ›å»º)æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">//tableä¸ºç©ºæˆ–é•¿åº¦ä¸º0æ—¶ï¼Œé‡æ–°æ‰©å®¹table</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//å¦‚æœæ’å…¥çš„keyå¯¹åº”çš„hashåœ°å€ä¸Šæ²¡æœ‰å€¼ï¼Œåˆ™ç›´æ¥åœ¨è¯¥ä½ç½®æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ’å…¥çš„keyå¯¹åº”çš„hashåœ°å€ä¸Šå·²ç»å­˜åœ¨å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹å°±æ˜¯keyå¯¹åº”èŠ‚ç‚¹ï¼Œå°±ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡eè®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼Œå¦‚æœé¦–èŠ‚ç‚¹æ˜¯æ ‘çŠ¶èŠ‚ç‚¹ï¼Œå°±å»çº¢é»‘æ ‘æ’å…¥ï¼ˆæ‰¾åˆ°ï¼‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶è®°å½•</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="comment">//å¦åˆ™éå†é“¾è¡¨</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//binCountè®°å½•é“¾è¡¨é•¿åº¦</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ•´ä¸ªé“¾è¡¨éƒ½æ²¡æ‰¾åˆ°keyï¼Œåˆ™åœ¨æœ«å°¾æ–°åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦è¾¾åˆ°æ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå°±å°†é“¾è¡¨è¿›è¡Œæ ‘å½¢åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœåœ¨é“¾è¡¨ä¸­æ‰¾åˆ°keyå°±è®°å½•ä¸‹æ¥</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ’å…¥çš„keyå·²ç»å­˜åœ¨å°±æŒ‰è¦æ±‚æ›¿æ¢å€¼ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ–°æ’å…¥èŠ‚ç‚¹eå°±æ˜¯nullï¼Œè·³è¿‡è¿™ä¸€æ­¥</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            <span class="comment">//æ›´æ–°èŠ‚ç‚¹å®Œæˆåä¸€äº›å…¶ä»–æ“ä½œï¼ŒHashMapè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="comment">//è¿”å›æ—§èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç»Ÿè®¡Mapç»“æ„ä¿®æ”¹æ¬¡æ•°,ç”¨äºè¿­ä»£å™¨å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹åçš„ä¸€äº›é¢å¤–æ“ä½œï¼ŒHashMapè¿™é‡Œä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="9">
<li>ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ é™¤å…ƒç´ çš„å®ç°ï¼Œå¦‚æœmatchValueä¸ºtrueåˆ™è¿˜è¦åŒ¹é…value</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, index;</span><br><span class="line">    <span class="comment">//ä¸€é¡¿ç©ºå€¼æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt; node = <span class="keyword">null</span>, e; K k; V v;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è¦åˆ é™¤çš„ï¼Œç”¨ä¸´æ—¶å˜é‡nodeè®°å½•</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            node = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ä»æ ‘ä¸­æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´ node</span></span><br><span class="line">            <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//éå†é“¾è¡¨</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key ||</span><br><span class="line">                         (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                        node = e;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    p = e;<span class="comment">//pæ˜¯eçš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœnodeä¸ä¸ºç©ºä¸”valueæ£€æŸ¥ä¹Ÿç¬¦åˆæ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                             (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">            <span class="comment">//ä»æ ‘ä¸­åˆ é™¤node</span></span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">            <span class="comment">//nodeå°±æ˜¯é¦–èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                tab[index] = node.next;</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">//åˆ é™¤node</span></span><br><span class="line">                p.next = node.next;</span><br><span class="line">            ++modCount;<span class="comment">//è®°å½•æœ¬æ¬¡ä¿®æ”¹</span></span><br><span class="line">            --size;<span class="comment">//size-1</span></span><br><span class="line">            afterNodeRemoval(node);<span class="comment">//åˆ é™¤èŠ‚ç‚¹åçš„å…¶ä»–å·¥ä½œï¼ŒHashMapä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">            <span class="keyword">return</span> node;<span class="comment">//è¿”å›åˆ é™¤çš„èŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<h3 id="3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–"><a href="#3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–" class="headerlink" title="3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–"></a>3ã€HashMapæ‰©å®¹ã€Rehashå’Œæ ‘å½¢åŒ–</h3><ol>
<li>HashMapæ‰©å®¹æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HashMapæ‰©å®¹æ“ä½œï¼Œå…ˆæ‰©å®¹å†é‡æ–°åˆ†å¸ƒï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæ—§tableé•¿åº¦å¤§äº0ï¼ˆéåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">//å¦‚æœæ—§tableé•¿åº¦è¾¾æœ€å¤§å€¼ï¼Œå°±ç›´æ¥è°ƒæ•´é˜ˆå€¼åˆ°æœ€å¤§å€¼</span></span><br><span class="line">        <span class="comment">//æ­¤åé˜ˆå€¼å¤±æ•ˆï¼Œä¸å†æ‰©å®¹ï¼Œå¹¶ç›´æ¥è¿”å›æ—§table</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ—§tableé•¿åº¦å’Œæ–°tableé•¿åº¦åœ¨åˆç†èŒƒå›´å†…å°±ç›´æ¥x2ï¼Œé˜ˆå€¼åŒæ ·x2</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">//oldCap &gt; 0ï¼ŒoldThrå¯èƒ½æ˜¯0å—ï¼Ÿæˆ‘è§‰å¾—ä¸å¯èƒ½ï¼ </span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœåˆå§‹åŒ–å®¹é‡å¤§äº0ï¼Œæ–°å®¹é‡å°±æ˜¯è¿™ä¸ªå€¼ï¼ˆæ³¨æ„è¿™é‡Œæ²¡æœ‰è®¾ç½®newThr,newThrè¿˜æ˜¯0ï¼‰</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">//æ ¹æ®é»˜è®¤æƒ…å†µåˆå§‹åŒ–table</span></span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœéé»˜è®¤åˆå§‹åŒ–æ—¶newThrä¸º0ï¼Œéœ€è¦é‡æ–°è®¡ç®—ï¼Œè¿˜æœ‰å…¶ä»–æƒ…å†µå¯¼è‡´çš„newThrä¸º0å—ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//rehashè¿‡ç¨‹ï¼Œé‡æ–°åˆ†å¸ƒå…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//éå†æ—§table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">//å¦‚æœjä½ç½®æœ‰å…ƒç´ å°±ç”¨ä¸´æ—¶å˜é‡eæ ‡è®°</span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//é‡Šæ”¾æ—§table[j]</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//å¦‚æœeåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆä¸æ„æˆé“¾è¡¨ã€æ ‘ï¼‰ï¼Œå°±ç›´æ¥é‡æ–°è®¡ç®—åœ°å€ï¼Œç„¶åæ”¾è¿‡å»</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">//å¦‚æœeæ˜¯çº¢é»‘æ ‘ï¼Œå°±æŒ‰çº¢é»‘æ ‘çš„æ–¹å¼rehash</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">//å¦‚æœeæ˜¯é“¾è¡¨ï¼Œå°±æ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªåœ¨åŸä½ç½®ä¸€ä¸ªåœ¨æ–°ä½ç½®</span></span><br><span class="line">                <span class="comment">//åªéœ€è¦æ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨çš„åŸå› ä¸å…¶åœ°å€è®¡ç®—æ–¹å¼æœ‰å…³:hash&amp;(n-1)</span></span><br><span class="line">                <span class="comment">//æ‰©å®¹2å€ï¼Œå¯¹äºn-1çš„äºŒè¿›åˆ¶æ¥è¯´å°±æ˜¯å·¦è¾¹å¤šäº†ä¸€ä¸ª1ï¼Œè¿™å¯¹äºåŸæ¥åœ¨è¯¥é“¾è¡¨çš„key</span></span><br><span class="line">                <span class="comment">//æ¥è¯´ï¼Œä¹Ÿåªéœ€è¦å…³æ³¨hashå¯¹åº”ä½ç½®æ˜¯0è¿˜æ˜¯1ï¼Œ0åˆ™ç•™åœ¨åŸåœ°ï¼Œ1åˆ™æ¬åˆ°æ–°ä½æ‰€</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve orderï¼ˆä¿ç•™ç›¸å¯¹é¡ºåºï¼‰</span></span><br><span class="line">                    <span class="comment">//ç•™åœ¨åŸåœ°çš„é“¾è¡¨å¤´&amp;å°¾ï¼ˆæ–°tableåœ°å€ä½ä½ï¼Œè¿™é‡Œçš„é«˜ä½å°±æ˜¯æ•°å­—å¤§å°ï¼‰</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//ä¹”è¿æ–°å±…çš„é“¾è¡¨å¤´&amp;å°¾ï¼ˆæ–°tableåœ°å€é«˜ä½ï¼‰</span></span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="comment">//éå†æ—§é“¾è¡¨</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">//æ˜¯å¦ç•™åœ¨åŸåœ°ï¼Œ(e.hash &amp; oldCap)==0è¡¨ç¤ºæ–°å¢çš„é‚£ä¸€ä½ä¸º0ï¼Œ</span></span><br><span class="line">                        <span class="comment">//ä¸å½±å“æ–°åœ°å€è®¡ç®—ï¼Œå¦åˆ™å°±è¦æ¬å®¶</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)<span class="comment">//é“¾è¡¨åˆå§‹åŒ–</span></span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span> <span class="comment">//è¿½åŠ åˆ°å°¾éƒ¨</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ä¹”è¿æ–°å±…</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//å¦‚æœæ‹†åˆ†å‡ºæ¥çš„é“¾è¡¨ä¸ä¸ºç©ºå°±æŠŠå®ƒæ”¾åˆ°å¯¹åº”ä½ç½®ä¸Š</span></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">//æ–°åœ°å€çš„è®¡ç®—æ–¹å¼ï¼š$oldAddr + oldCap</span></span><br><span class="line">                        <span class="comment">//hash&amp;(oldCap-1)+oldCap = hash&amp;(oldCap*2-1)</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>æ ‘å½¢åŒ–æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ‘å½¢åŒ–ï¼Œå¦‚æœtableé•¿åº¦(ï¼ï¼ï¼ä¸æ˜¯sizeï¼ï¼ï¼)å°äºMIN_TREEIFY_CAPACITY(64)åˆ™è¿›è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">//å¦‚æœtableä¸ºç©ºæˆ–tableé•¿åº¦å°äºMIN_TREEIFY_CAPACITYåˆ™è¿›è¡Œæ‰©å®¹ï¼Œwhy???</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="comment">//å¦‚æœç»™å®šçš„hashå¯¹åº”ä½ç½®ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//å…ˆæŠŠèŠ‚ç‚¹ç±»å‹å…¨éƒ¨æ¢æˆTreeNode</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                p.prev = tl;</span><br><span class="line">                tl.next = p;</span><br><span class="line">            &#125;</span><br><span class="line">            tl = p;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//æ ‘å½¢åŒ–ï¼Œindexå°±æ˜¯åœ°å€: index = (n - 1) &amp; hash</span></span><br><span class="line">        <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</span><br><span class="line">            hd.treeify(tab);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<h3 id="4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ"><a href="#4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ" class="headerlink" title="4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ"></a>4ã€Nodeå®šä¹‰åŠä¸TreeNodeè½¬æ¢æ“ä½œ</h3><ol>
<li>Nodeå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Nodeæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;<span class="comment">//keyçš„hash</span></span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">        V oldValue = value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>Nodeã€TreeNodeæ„é€ åŠè½¬æ¢æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a regular (non-tree) node</span></span><br><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For conversion from TreeNodes to plain nodes</span></span><br><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">replacementNode</span><span class="params">(Node&lt;K,V&gt; p, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a tree bin node</span></span><br><span class="line"><span class="function">TreeNode&lt;K,V&gt; <span class="title">newTreeNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TreeNode&lt;&gt;(hash, key, value, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For treeifyBin</span></span><br><span class="line"><span class="function">TreeNode&lt;K,V&gt; <span class="title">replacementTreeNode</span><span class="params">(Node&lt;K,V&gt; p, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TreeNode&lt;&gt;(p.hash, p.key, p.value, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<h3 id="5ã€-Setè§†å›¾ã€è¿­ä»£å™¨-Iterator-ä¸åˆ†å‰²å™¨-Spliterator"><a href="#5ã€-Setè§†å›¾ã€è¿­ä»£å™¨-Iterator-ä¸åˆ†å‰²å™¨-Spliterator" class="headerlink" title="5ã€ Setè§†å›¾ã€è¿­ä»£å™¨(Iterator)ä¸åˆ†å‰²å™¨(Spliterator)"></a>5ã€ Setè§†å›¾ã€è¿­ä»£å™¨(Iterator)ä¸åˆ†å‰²å™¨(Spliterator)</h3><ol>
<li><p>keySet</p>
<ul>
<li>KeySetå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HashMapå¾¡ç”¨KeySet</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;K&gt; <span class="title">iterator</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> KeyIterator(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> containsKey(o); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;K&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> KeySpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">      Node&lt;K,V&gt;[] tab;</span><br><span class="line">      <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> mc = modCount;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">              <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                  action.accept(e.key);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//è¿­ä»£å‰åä¿®æ”¹æ¬¡æ•°ä¸ä¸€è‡´åˆ™å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">          <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li>
</ul>
<p></p>
<ul>
<li>keySetæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›keyçš„é›†åˆã€è§†å›¾ã€‘,å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„Setï¼Œå®ƒä»…ä»…æä¾›äº†SetåŒ–çš„æ“ä½œæ¥å£ã€‚</span></span><br><span class="line"><span class="comment">//Setä¸Mapçš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šç›¸äº’ä½“ç°å‡ºæ¥ã€‚</span></span><br><span class="line"><span class="comment">//åœ¨Setè¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹äº†Mapåˆ™è¿­ä»£ç»“æœæœªå®šä¹‰ã€‚</span></span><br><span class="line"><span class="comment">//å¯ä»¥é€šè¿‡Setè‡ªå¸¦çš„æ–¹æ³•ä¿®æ”¹Mapï¼Œä½†ä¸èƒ½æ·»åŠ keyã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;K&gt; ks = keySet;</span><br><span class="line">    <span class="keyword">if</span> (ks == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ks = <span class="keyword">new</span> KeySet();</span><br><span class="line">        keySet = ks;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
</li>
</ol>
<p></p>
<ol start="2">
<li><p>values</p>
<ul>
<li>Valueså®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Values</span> <span class="keyword">extends</span> <span class="title">AbstractCollection</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;V&gt; <span class="title">iterator</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> ValueIterator(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123; <span class="keyword">return</span> containsValue(o); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;V&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ValueSpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> mc = modCount;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                    action.accept(e.value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åŒæ ·å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>valuesæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//valuesï¼šç±»ä¼¼KeySet</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Collection&lt;V&gt; vs = values;</span><br><span class="line">    <span class="keyword">if</span> (vs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        vs = <span class="keyword">new</span> Values();</span><br><span class="line">        values = vs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
</li>
</ol>
<p></p>
<ol start="3">
<li><p>entrySet</p>
<ul>
<li>EntrySetå®šä¹‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span>                 </span>&#123; <span class="keyword">return</span> size; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span>               </span>&#123; HashMap.<span class="keyword">this</span>.clear(); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntryIterator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map.Entry))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</span><br><span class="line">        Object key = e.getKey();</span><br><span class="line">        Node&lt;K,V&gt; candidate = getNode(hash(key), key);</span><br><span class="line">        <span class="keyword">return</span> candidate != <span class="keyword">null</span> &amp;&amp; candidate.equals(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</span><br><span class="line">            Object key = e.getKey();</span><br><span class="line">            Object value = e.getValue();</span><br><span class="line">            <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Spliterator&lt;Map.Entry&lt;K,V&gt;&gt; spliterator() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntrySpliterator&lt;&gt;(HashMap.<span class="keyword">this</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> mc = modCount;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                    action.accept(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>entrySetæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//EntrySet: same as keySet and values</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</span><br><span class="line">    <span class="keyword">return</span> (es = entrySet) == <span class="keyword">null</span> ? (entrySet = <span class="keyword">new</span> EntrySet()) : es;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
</li>
</ol>
<p></p>
<ol start="4">
<li><p>è¿­ä»£å™¨(Itetator)</p>
<ul>
<li>HashIteratoræ ¸å¿ƒåŠŸèƒ½ï¼ˆæŠ½è±¡ç±»ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿­ä»£å™¨ï¼Œæ³¨æ„æ˜¯abstract</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; next;        <span class="comment">// next entry to return</span></span><br><span class="line">    Node&lt;K,V&gt; current;     <span class="comment">// current entry</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount;  <span class="comment">// for fast-fail</span></span><br><span class="line">    <span class="keyword">int</span> index;             <span class="comment">// current slot</span></span><br><span class="line"></span><br><span class="line">    HashIterator() &#123;</span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">        Node&lt;K,V&gt;[] t = table;</span><br><span class="line">        current = next = <span class="keyword">null</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸ä¸ºnullçš„nodeï¼Œç”¨nextæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">nextNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        Node&lt;K,V&gt; e = next;</span><br><span class="line">        <span class="comment">//è¿­ä»£ä¸­é€”å‘ç”Ÿç»“æ„ä¿®æ”¹ï¼Œç›´æ¥å¿«é€Ÿå¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰é“¾è¡¨/æ ‘éå†å®Œäº†ï¼Œå°±åœ¨tableä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸ä¸ºnullçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((next = (current = e).next) == <span class="keyword">null</span> &amp;&amp; (t = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; p = current;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)<span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹è¢«åˆ é™¤äº†</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        current = <span class="keyword">null</span>;</span><br><span class="line">        K key = p.key;ã€</span><br><span class="line">            <span class="comment">//åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">            removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//æ›´æ–°ã€æœŸæœ›ä¿®æ”¹æ¬¡æ•°ã€‘ï¼Œå¾ˆé‡è¦ï¼ï¼ï¼</span></span><br><span class="line">        expectedModCount = modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>éå†keySetä½¿ç”¨çš„KeyIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸‰ç§è¿­ä»£å™¨ï¼Œéƒ½ä»¥abstract HashIteratorä¸ºåŸºç¡€</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode().key; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>éå†valuesä½¿ç”¨çš„ValueIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode().value; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>éå†entrySetä½¿ç”¨çš„EntryIterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntryIterator</span> <span class="keyword">extends</span> <span class="title">HashIterator</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map.<span class="function">Entry&lt;K,V&gt; <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> nextNode(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
</li>
</ol>
<p></p>
<ol start="5">
<li><p>åˆ†å‰²å™¨(Spliterator)ï¼ŒJava8æ–°å¼•å…¥çš„åŠŸèƒ½</p>
<ul>
<li>HashMapSpliteratoræ ¸å¿ƒåŠŸèƒ½ï¼ˆæŠ½è±¡ç±»ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ†å‰²å™¨ï¼Œ</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;K,V&gt; map;</span><br><span class="line">    Node&lt;K,V&gt; current;          <span class="comment">// current node</span></span><br><span class="line">    <span class="keyword">int</span> index;                  <span class="comment">// current index, modified on advance/split</span></span><br><span class="line">    <span class="keyword">int</span> fence;                  <span class="comment">// one past last index</span></span><br><span class="line">    <span class="keyword">int</span> est;                    <span class="comment">// size estimate</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount;       <span class="comment">// for comodification checks</span></span><br><span class="line"></span><br><span class="line">    HashMapSpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin,</span><br><span class="line">                       <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                       <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">this</span>.map = m;</span><br><span class="line">        <span class="keyword">this</span>.index = origin;</span><br><span class="line">        <span class="keyword">this</span>.fence = fence;</span><br><span class="line">        <span class="keyword">this</span>.est = est;</span><br><span class="line">        <span class="keyword">this</span>.expectedModCount = expectedModCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getFence</span><span class="params">()</span> </span>&#123; <span class="comment">// initialize fence and size on first use</span></span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            HashMap&lt;K,V&gt; m = map;</span><br><span class="line">            est = m.size;</span><br><span class="line">            expectedModCount = m.modCount;</span><br><span class="line">            Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">estimateSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getFence(); <span class="comment">// force init</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">long</span>) est;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>KeySpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    KeySpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                   <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeySpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> KeySpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                             expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p.key);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> K&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = current.key;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(k);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>) |</span><br><span class="line">            Spliterator.DISTINCT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>ValueSpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    ValueSpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                     <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueSpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> ValueSpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                               expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p.value);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    V v = current.value;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(v);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
<p></p>
<ul>
<li>EntrySpliterator<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMapSpliterator</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Spliterator</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;&gt; </span>&#123;</span><br><span class="line">    EntrySpliterator(HashMap&lt;K,V&gt; m, <span class="keyword">int</span> origin, <span class="keyword">int</span> fence, <span class="keyword">int</span> est,</span><br><span class="line">                     <span class="keyword">int</span> expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">super</span>(m, origin, fence, est, expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntrySpliterator&lt;K,V&gt; <span class="title">trySplit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi = getFence(), lo = index, mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (lo &gt;= mid || current != <span class="keyword">null</span>) ? <span class="keyword">null</span> :</span><br><span class="line">        <span class="keyword">new</span> EntrySpliterator&lt;&gt;(map, lo, index = mid, est &gt;&gt;&gt;= <span class="number">1</span>,</span><br><span class="line">                               expectedModCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, hi, mc;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        HashMap&lt;K,V&gt; m = map;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = m.table;</span><br><span class="line">        <span class="keyword">if</span> ((hi = fence) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mc = expectedModCount = m.modCount;</span><br><span class="line">            hi = fence = (tab == <span class="keyword">null</span>) ? <span class="number">0</span> : tab.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            mc = expectedModCount;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= hi &amp;&amp;</span><br><span class="line">            (i = index) &gt;= <span class="number">0</span> &amp;&amp; (i &lt; (index = hi) || current != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Node&lt;K,V&gt; p = current;</span><br><span class="line">            current = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                    p = tab[i++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    action.accept(p);</span><br><span class="line">                    p = p.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span> || i &lt; hi);</span><br><span class="line">            <span class="keyword">if</span> (m.modCount != mc)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAdvance</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Map.Entry&lt;K,V&gt;&gt; action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hi;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] tab = map.table;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; tab.length &gt;= (hi = getFence()) &amp;&amp; index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (current != <span class="keyword">null</span> || index &lt; hi) &#123;</span><br><span class="line">                <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">                    current = tab[index++];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    Node&lt;K,V&gt; e = current;</span><br><span class="line">                    current = current.next;</span><br><span class="line">                    action.accept(e);</span><br><span class="line">                    <span class="keyword">if</span> (map.modCount != expectedModCount)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (fence &lt; <span class="number">0</span> || est == map.size ? Spliterator.SIZED : <span class="number">0</span>) |</span><br><span class="line">            Spliterator.DISTINCT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ul>
</li>
</ol>
<p></p>
<h1 id="äºŒã€-Java8æ–°ç‰¹æ€§"><a href="#äºŒã€-Java8æ–°ç‰¹æ€§" class="headerlink" title="äºŒã€ Java8æ–°ç‰¹æ€§"></a>äºŒã€ Java8æ–°ç‰¹æ€§</h1><ol>
<li>å¸¦é»˜è®¤å€¼çš„getæ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? defaultValue : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>ç¼ºå¤±keyæˆ–keyä¸ºnullæ‰æ’å…¥èŠ‚ç‚¹ï¼Œè¿”å›æ—§èŠ‚ç‚¹çš„å€¼ï¼Œå¦‚æœå­˜åœ¨çš„è¯<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="3">
<li>åŸºäºkeyå’Œvalueä¸¤é‡éªŒè¯çš„åˆ é™¤æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="4">
<li>åŸºäºkeyå’Œvalueä¸¤é‡éªŒè¯çš„æ›¿æ¢æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e; V v;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        ((v = e.value) == oldValue || (v != <span class="keyword">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class="line">        e.value = newValue;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="5">
<li>valueæ›¿æ¢æ“ä½œï¼Œä»…å½“keyå­˜åœ¨æ‰æ›¿æ¢ï¼Œæ³¨æ„ä¸putçš„åŒºåˆ«<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = e.value;</span><br><span class="line">        e.value = value;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="6">
<li>å¦‚æœç»™å®šçš„keyåœ¨mapä¸­ä¸å­˜åœ¨ï¼Œå°±ä»ç»™å®šçš„functionè®¡ç®—å‡ºä¸€ä¸ªvalueæ”¾è¿›mapï¼Œå¹¶è¿”å›è¿™ä¸ªvalue<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">computeIfAbsent</span><span class="params">(K key, Function&lt;? <span class="keyword">super</span> K,? extends V&gt; mappingFunction)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//æ˜¯å¦éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–ä¸ªèŠ‚ç‚¹æ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œå°±åœ¨æ ‘ä¸­æŸ¥æ‰¾keyï¼Œè¿”å›èŠ‚ç‚¹ç”¨oldæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨æŸ¥è¯¢keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ç»Ÿè®¡é“¾è¡¨é•¿åº¦</span></span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        V oldValue;</span><br><span class="line">        <span class="comment">//å¦‚æœç»™å®škeyå­˜åœ¨ï¼Œå¹¶ä¸”valueä¸ä¸ºnullï¼Œå°±ç›´æ¥è¿”å›å¯¹åº”çš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; (oldValue = old.value) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            afterNodeAccess(old);<span class="comment">//Do nothing</span></span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦åˆ™å°±ä»ç»™å®šçš„å‡½æ•°key -&gt; &#123;...&#125;ï¼Œè®¡ç®—å‡ºä¸€ä¸ªvalueå¹¶æ’å…¥</span></span><br><span class="line">    V v = mappingFunction.apply(key);</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="keyword">null</span>) &#123; <span class="comment">//å¦‚æœè®¡ç®—å‡ºçš„valueæ˜¯nullåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123; <span class="comment">//keyå­˜åœ¨ä½†valueä¸ºnullå°±ç›´æ¥æ›¿æ¢valueå¹¶è¿”å›æ—§value</span></span><br><span class="line">        old.value = v;</span><br><span class="line">        afterNodeAccess(old);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (t != <span class="keyword">null</span>) <span class="comment">//å¦‚æœkeyä¸å­˜åœ¨ï¼Œä¸”å½“å‰ä½ç½®ä¸ºä¸€æ£µæ ‘ï¼Œåˆ™å‘æ ‘ä¸­å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//å¦‚æœkeyä¸å­˜åœ¨ï¼Œä¸”å½“å‰ä½ç½®ä¸ºé“¾è¡¨ï¼Œåˆ™å‘è¡¨å¤´å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        tab[i] = newNode(hash, key, v, first);</span><br><span class="line">        <span class="comment">//å¢åŠ å®Œæˆååˆ¤æ–­æ˜¯å¦éœ€è¦æ ‘å½¢åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">            treeifyBin(tab, hash);</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    ++size;<span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹size+1</span></span><br><span class="line">    afterNodeInsertion(<span class="keyword">true</span>);<span class="comment">//Do nothing</span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="7">
<li>å¦‚æœç»™å®šçš„keyå­˜åœ¨ï¼Œå°±ç”¨<code>(k,oldV) -&gt; {}</code>è®¡ç®—å‡ºçš„å€¼æ›¿æ¢æ—§å€¼ï¼Œå¹¶è¿”å›è®¡ç®—å‡ºçš„æ–°å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">computeIfPresent</span><span class="params">(K key, </span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    Node&lt;K,V&gt; e; V oldValue;</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="comment">//keyå­˜åœ¨ä¸”æ—§å€¼ä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash, key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (oldValue = e.value) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è®¡ç®—æ–°å€¼</span></span><br><span class="line">        V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">        <span class="comment">//å¦‚æœæ–°å€¼ä¸ä¸ºnullåˆ™æ›¿æ¢æˆæ–°å€¼ï¼Œå¹¶è¿”å›æ–°å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            e.value = v;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//å¦åˆ™åˆ é™¤æ—§èŠ‚ç‚¹(æ–°å€¼ä¸ºnullä»£è¡¨è¯¥èŠ‚ç‚¹æ— æ•ˆ)</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‰¾ä¸åˆ°keyç›´æ¥è¿”å›null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="8">
<li>ç”¨<code>(key, Oldv) -&gt; {}</code>è®¡ç®—å‡ºçš„æ–°å€¼æ›¿æ¢keyå¯¹åº”çš„æ—§å€¼ï¼Œè¿”å›æ–°å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyå­˜åœ¨ï¼Œæ–°å€¼ä¸ºnullï¼Œåˆ é™¤keyèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//keyå­˜åœ¨ï¼Œæ–°å€¼ä¸ä¸ºnullï¼Œä¿®æ”¹keyèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//keyä¸å­˜åœ¨ï¼Œæ–°å€¼ä¸ºnullï¼Œç›´æ¥è¿”å›null</span></span><br><span class="line"><span class="comment">//keyä¸å­˜åœ¨ï¼Œæ–°å€¼ä¸ä¸ºnullï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">compute</span><span class="params">(K key,</span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//tableæœªåˆå§‹åŒ–æˆ–éœ€è¦æ‰©å®¹å°±æ‰§è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//å¦‚æœé¦–èŠ‚ç‚¹ä¸ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯çº¢é»‘æ ‘å°±åœ¨æ ‘ä¸­æŸ¥æ‰¾keyï¼Œå¯¹åº”nodeç”¨oldæ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨ï¼Œç”¨oldæ ‡è®°æ‰¾åˆ°çš„node</span></span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;<span class="comment">//ç»Ÿè®¡é“¾è¡¨é•¿åº¦ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ ‘å½¢åŒ–</span></span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    V oldValue = (old == <span class="keyword">null</span>) ? <span class="keyword">null</span> : old.value;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ–°value</span></span><br><span class="line">    V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;<span class="comment">//å¯¹åº”çš„keyå­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ–°valueä¸ä¸ºnullåˆ™æ›¿æ¢æˆæ–°value</span></span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);<span class="comment">//Do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//å¦åˆ™åˆ é™¤keyå¯¹åº”çš„æ—§èŠ‚ç‚¹</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123; <span class="comment">//å¦‚æœæ–°valueä¸ä¸ºnullï¼Œä¸”keyä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)<span class="comment">//å¦‚æœæ˜¯æ ‘å‹ç»“æ„å°±åœ¨æ ‘ä¸­æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">        <span class="keyword">else</span> &#123;<span class="comment">//å¦åˆ™å°±åœ¨é“¾è¡¨å¤´éƒ¨æ·»åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">            tab[i] = newNode(hash, key, v, first);</span><br><span class="line">            <span class="comment">//å¦‚æœéœ€è¦æ ‘å½¢åŒ–å°±å¼€å§‹æ ‘å½¢åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;<span class="comment">//æ’å…¥æ–°èŠ‚ç‚¹size+1</span></span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);<span class="comment">//Do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="9">
<li>åˆå¹¶ä¸¤ä¸ªkeyä¸€æ ·çš„valueï¼Œæ–°å€¼ç”Ÿæˆå‡½æ•°<code>(oldV, newV) -&gt; {}</code>ï¼Œç”¨ç”Ÿæˆçš„æ–°å€¼å»æ›¿æ¢æ—§å€¼<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šåªæœ‰old valueä¸ä¸ºnullæ‰å»è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¦åˆ™ç›´æ¥æ’å…¥æ–°value</span></span><br><span class="line"><span class="comment">//Streamä¸­toMapä¼šç”¨åˆ°ï¼Œä¸€èˆ¬è§£å†³keyå†²çª</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">merge</span><span class="params">(K key, V value,</span></span></span><br><span class="line"><span class="function"><span class="params">    BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V v;</span><br><span class="line">        <span class="keyword">if</span> (old.value != <span class="keyword">null</span>)</span><br><span class="line">            v = remappingFunction.apply(old.value, value);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            v = value;</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)</span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[i] = newNode(hash, key, value, first);</span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;</span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="10">
<li>ç”¨ç»™å®šçš„consumerå¾ªç¯å¤„ç†æ¯ä¸ªkey-value pair<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(BiConsumer&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V&gt; action)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (action == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mc = modCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next)</span><br><span class="line">                action.accept(e.key, e.value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸­é—´å‘ç”Ÿè¿‡ä¿®æ”¹åˆ™å¿«é€Ÿå¤±è´¥ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="11">
<li>ç”¨ç»™å®šçš„å‡½æ•°<code>(k,v)-&gt;{}</code>ç”Ÿæˆä¸€ä¸ªæ–°å€¼ï¼Œå¹¶ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼ï¼Œè¿™ä¸ªæ“ä½œä½œç”¨äºæ‰€æœ‰å…ƒç´ <br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; function)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (function == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mc = modCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                e.value = function.apply(e.key, e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (modCount != mc)<span class="comment">//çº¿ç¨‹å®‰å…¨æ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<h1 id="ä¸‰ã€-çº¢é»‘æ ‘ç›¸å…³æ“ä½œ"><a href="#ä¸‰ã€-çº¢é»‘æ ‘ç›¸å…³æ“ä½œ" class="headerlink" title="ä¸‰ã€ çº¢é»‘æ ‘ç›¸å…³æ“ä½œ"></a>ä¸‰ã€ çº¢é»‘æ ‘ç›¸å…³æ“ä½œ</h1><ol>
<li>çº¢é»‘æ ‘èŠ‚ç‚¹å®šä¹‰ï¼ˆä»…å«æ„é€ æ–¹æ³•ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TreeNodeå®šä¹‰ï¼Œä»Nodeä¸Šç»§æ‰¿äº†key, valueå’Œnextç›¸å…³æˆå‘˜</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>æ‰¾åˆ°å½“å‰æ ‘çš„rootèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä»å½“å‰èŠ‚ç‚¹å‘å‰ï¼Œä¸€ç›´åˆ°parentä¸ºnullçš„èŠ‚ç‚¹å°±æ˜¯rootèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        r = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="3">
<li>å°†rootèŠ‚ç‚¹æ”¾åˆ°è¯¥hashåœ°å€çš„é¦–ä¸ªèŠ‚ç‚¹ä½ç½®ä¸Š<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">moveRootToFront</span><span class="params">(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; tab != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; root.hash;<span class="comment">//é¦–ä¸ªèŠ‚ç‚¹åœ°å€</span></span><br><span class="line">        TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="comment">//å¦‚æœé¦–ä¸ªèŠ‚ç‚¹ä¸æ˜¯rootèŠ‚ç‚¹ï¼Œå°±æŠŠrootèŠ‚ç‚¹æåˆ°é¦–ä½</span></span><br><span class="line">        <span class="keyword">if</span> (root != first) &#123;</span><br><span class="line">            Node&lt;K,V&gt; rn;</span><br><span class="line">            tab[index] = root;<span class="comment">//åœ°å€èŠ‚ç‚¹ç›´æ¥æŒ‡å‘root</span></span><br><span class="line">            TreeNode&lt;K,V&gt; rp = root.prev; <span class="comment">//rp:rootä¹‹å‰çš„éƒ¨åˆ†</span></span><br><span class="line">            <span class="keyword">if</span> ((rn = root.next) != <span class="keyword">null</span>) <span class="comment">//rn:rootä¹‹åçš„éƒ¨åˆ†</span></span><br><span class="line">                <span class="comment">//rootä¹‹åçš„éƒ¨åˆ†preç›´æ¥ä¸rootä¹‹å‰çš„éƒ¨åˆ†ç›¸è¿</span></span><br><span class="line">                ((TreeNode&lt;K,V&gt;)rn).prev = rp;</span><br><span class="line">            <span class="keyword">if</span> (rp != <span class="keyword">null</span>)</span><br><span class="line">                rp.next = rn; <span class="comment">//rootä¹‹å‰çš„éƒ¨åˆ†nextç›´æ¥ä¸rootä¹‹åçš„éƒ¨åˆ†ç›¸è¿</span></span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                first.prev = root; <span class="comment">//firstä¸rootç›¸è¿</span></span><br><span class="line">            root.next = first;</span><br><span class="line">            root.prev = <span class="keyword">null</span>;<span class="comment">//rootå‰é©±èŠ‚ç‚¹ä¸ºnull</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;<span class="comment">//æ£€æŸ¥çº¢é»‘æ ‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="4">
<li>ä»å½“å‰èŠ‚ç‚¹æŸ¥æ‰¾keyå¯¹åº”çš„Node<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//ä»å½“å‰èŠ‚ç‚¹æŸ¥æ‰¾keyï¼Œkcç¼“å­˜äº†keyçš„classï¼Œå¦‚æœkey.classæ˜¯Comparableçš„ï¼Œå¦åˆ™ä¸ºnull</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ph, dir; K pk;</span><br><span class="line">        TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</span><br><span class="line">        <span class="comment">//å¦‚æœæŸ¥æ‰¾çš„hash keyå°äºå½“å‰hash keyï¼Œå°±è½¬å‘å·¦å­æ ‘æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//å¦‚æœæŸ¥æ‰¾çš„hash keyå¤§äºå½“å‰hash keyï¼Œå°±è½¬å‘å³å­æ ‘æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸€è‡´å°±è¡¨ç¤ºæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å·¦å­æ ‘ä¸ºç©ºï¼Œç›´æ¥è½¬å‘å³å­æ ‘ï¼ˆåªå¯èƒ½åœ¨å³å­æ ‘ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘ä¸ºç©ºï¼Œç›´æ¥è½¬å‘å·¦å­æ ‘ï¼ˆåªå¯èƒ½åœ¨å·¦å­æ ‘ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œä½†keyæ˜¯å¯æ¯”è¾ƒçš„ï¼Œå¹¶ä¸”èƒ½æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                  (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                 (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">            p = (dir &lt; <span class="number">0</span>) ? pl : pr;<span class="comment">//æ ¹æ®keyçš„æ¯”è¾ƒç»“æœå†³å®šå»é‚£ä¸ªå­æ ‘æœç´¢</span></span><br><span class="line">        <span class="comment">//hashä¸€è‡´ï¼Œkeyä¸ä¸€è‡´ï¼Œä¸”å³å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œä¸”keyä¸å¯æ¯”è¾ƒæˆ–æ— æ³•æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">        <span class="comment">//å…ˆæœç´¢å³å­æ ‘ï¼Œå¦‚æœåœ¨å³å­æ ‘ä¸­æ‰¾åˆ°keyï¼Œå°±è¿”å›å¯¹åº”node</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> q;</span><br><span class="line">        <span class="comment">//å³å­æ ‘æ²¡æ‰¾åˆ°ï¼Œæ¥ç€éå†å·¦å­æ ‘ï¼ˆä¸ºä»€ä¹ˆä¸ç”¨tieBreakOrderç¡®å®šæŸ¥å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘ï¼Ÿï¼‰</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = pl;</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="5">
<li>ä»rootèŠ‚ç‚¹å¼€å§‹æŸ¥è¯¢æŸä¸ªkeyï¼Œå°±æ˜¯æ­£å¸¸çš„æŸ¥è¯¢<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="6">
<li><p>æ·±å±‚æ¬¡æ¯”è¾ƒä¸¤ä¸ªkeyçš„å¤§å°ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±è¡¨ç¤ºå‘ç”Ÿäº†<strong>hashç¢°æ’</strong></p>
<p>æ³¨æ„ï¼š<strong>hashç¢°æ’</strong>ä¸<strong>hashåœ°å€ç¢°æ’</strong>ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œhashç¢°æ’æ˜¯æŒ‡ä¸¤ä¸ªkeyç®—å‡ºæ¥çš„hashä¸€æ ·ï¼Œhashç¢°æ’å¿…å®šä¼šå‘ç”Ÿhashåœ°å€ç¢°æ’ï¼Œä½†hashåœ°å€(hash&amp;(n-1))ç¢°æ’åªæ˜¯ä½xä½ç¢°æ’ï¼Œä¸ä»£è¡¨æ•´ä¸ªhashå€¼ä¸€æ ·<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“keyçš„hashå€¼ä¸€è‡´(hashç¢°æ’)ï¼Œä¸”keyä¸å¯æ¯”è¾ƒæ—¶ï¼ŒidentityHashCodeè¿›è¡Œæ¯”è¾ƒï¼Œnullçš„hashä¸º0</span></span><br><span class="line"><span class="comment">//identityHashCodeæ€»æ˜¯è°ƒç”¨Objectå®ç°çš„hashCodeï¼Œxx.hashCodeæ˜¯è°ƒç”¨é‡å†™åçš„hashCode</span></span><br><span class="line"><span class="comment">//æ³¨æ„ï¼šidentityHashCodeä¹Ÿå¯èƒ½ä¼šé‡å¤ï¼Œä½†æ¦‚ç‡ç›¸å½“å°ã€‚</span></span><br><span class="line"><span class="comment">//è¿™é‡Œçš„æ¯”è¾ƒç»“æœåˆ†ä¸º-1å’Œ1ï¼Œ0å½’åˆ°-1é‡Œé¢ï¼Œæ‰€ä»¥å…ƒç´ çš„ç›¸å¯¹é¡ºåºå°±æ— æ³•ä¿è¯äº†ï¼Œä½†æ²¡æœ‰å…³ç³»</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> d;</span><br><span class="line"><span class="comment">//aæˆ–bå…¶ä¸­ä¸€ä¸ªæ˜¯nullï¼Œæˆ–aã€bçš„ç±»å‹æ˜¯ä¸€æ ·çš„æ—¶å€™æ‰å¯æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">(d = a.getClass().getName().</span><br><span class="line">compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">-<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></p>
</li>
</ol>
<p></p>
<ol start="7">
<li>æ ‘å½¢åŒ–æ“ä½œï¼ˆä»¥å½“å‰èŠ‚ç‚¹ä¸ºrootèŠ‚ç‚¹ï¼‰,ä¸€èˆ¬åœ¨é“¾è¡¨é¦–èŠ‚ç‚¹è°ƒç”¨è¯¥æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æ ‘å½¢åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeify</span><span class="params">(Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„thiså®é™…å°±æ˜¯é“¾è¡¨çš„é¦–èŠ‚ç‚¹ï¼Œéå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = <span class="keyword">this</span>, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–rootèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.parent = <span class="keyword">null</span>;</span><br><span class="line">            x.red = <span class="keyword">false</span>;<span class="comment">//rootèŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">            root = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            K k = x.key;</span><br><span class="line">            <span class="keyword">int</span> h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//ä¸€ç›´éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯æ’å…¥çš„ä½ç½®ï¼ˆå¯æ’å…¥å¶å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph;</span><br><span class="line">                K pk = p.key;</span><br><span class="line">                <span class="comment">//h &lt; ph èµ°å·¦è¾¹</span></span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="comment">//h &gt; ph èµ°å³è¾¹</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//h == phï¼Œä¸”(keyä¸å¯æ¯”è¾ƒï¼Œæˆ–keyæ¯”è¾ƒç»“æœæ— æ³•åŒºåˆ†å¤§å°)</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                          (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                         (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//é‡‡ç”¨identify hashcodeå†æ¬¡æ¯”è¾ƒ(0å’Œ-1åˆå¹¶ä¸º-1)</span></span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line"></span><br><span class="line">                TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="comment">//å¦‚æœxå·²ç»åˆ°è¾¾å¯ä»¥æ’å…¥çš„ä½ç½®ï¼Œå°±æ’å…¥xèŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="comment">//é‡æ–°å¹³è¡¡çº¢é»‘æ ‘</span></span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦åˆ™ç»§ç»­æŸ¥æ‰¾èƒ½æ’å…¥çš„ä½ç½®</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡æ–°å¹³è¡¡æ ‘årootèŠ‚ç‚¹å¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°å°†å¶å­èŠ‚ç‚¹æ”¾åˆ°é¦–ä¸ªèŠ‚ç‚¹çš„ä½ç½®</span></span><br><span class="line">    moveRootToFront(tab, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="8">
<li>è§£æ ‘å½¢åŒ–ï¼ˆçº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨ï¼‰<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">untreeify</span><span class="params">(HashMap&lt;K,V&gt; map)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt; q = <span class="keyword">this</span>; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">        Node&lt;K,V&gt; p = map.replacementNode(q, <span class="keyword">null</span>);<span class="comment">//èŠ‚ç‚¹ç±»å‹æ›¿æ¢ä¸€ä¸‹å°±å¯ä»¥äº†</span></span><br><span class="line">        <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">            hd = p;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tl.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="9">
<li>åœ¨æ ‘ä¸­æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[]tab,<span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">     Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">     TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line">     <span class="comment">//ä»rootå¼€å§‹éå†ï¼Œå¦‚æœkeyå·²å­˜åœ¨å°±è¿”å›ç›¸å…³èŠ‚ç‚¹ï¼Œå¦åˆ™æ‰¾åˆ°ä¸€ä¸ªåˆé€‚ä½ç½®æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">     <span class="comment">//ä½¿å¾—æ–°å¢èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹</span></span><br><span class="line">     <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">         <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">         <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">             dir = -<span class="number">1</span>;</span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">             dir = <span class="number">1</span>;</span><br><span class="line">         <span class="comment">//keyå·²ç»å­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸Šå±‚æ–¹æ³•ç»Ÿä¸€æ›¿æ¢value</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">             <span class="keyword">return</span> p;</span><br><span class="line">         <span class="comment">//ph==h å¹¶ä¸”keyä¸å¯æ¯”è¾ƒæˆ–æ— æ³•æ¯”è¾ƒå‡ºå¤§å°</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                  (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">//æœç´¢å·¦å­æ ‘&amp;å³å­æ ‘</span></span><br><span class="line">             <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                 TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                 <span class="comment">//å·¦å³å­æ ‘åªéœ€è¦æœç´¢ä¸€æ¬¡ï¼Œåç»­éå†å…¶ä»–èŠ‚ç‚¹æ— éœ€å†æœç´¢å®ƒä»¬çš„å­æ ‘</span></span><br><span class="line">                 searched = <span class="keyword">true</span>;</span><br><span class="line">                 <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                      (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                     ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                      (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                     <span class="keyword">return</span> q;<span class="comment">//åªè¦æ‰¾åˆ°äº†keyå°±ç›´æ¥è¿”å›</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å·¦å³å­æ ‘æ²¡æ‰¾åˆ°ï¼Œå‡†å¤‡æ–°è¿½åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç°åœ¨åˆ¤æ–­è¿½åŠ åˆ°å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘</span></span><br><span class="line">             dir = tieBreakOrder(k, pk);</span><br><span class="line">         &#125;<span class="comment">//if</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">//è¿½åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">         TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">         <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">             Node&lt;K,V&gt; xpn = xp.next;<span class="comment">//æ³¨æ„è¿™é‡Œåœ¨è¿›è¡Œæ ‘çš„è¿½åŠ æ“ä½œæ—¶ä»ç„¶ä¿ç•™äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§</span></span><br><span class="line">             TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line">             <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                 xp.left = x;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">                 xp.right = x;</span><br><span class="line">             xp.next = x;</span><br><span class="line">             x.parent = x.prev = xp;</span><br><span class="line">             <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line">                 ((TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line">             <span class="comment">//é‡æ–°å¹³è¡¡æ ‘å¹¶è°ƒæ•´nodeåˆ°é¦–ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">             moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="10">
<li>ç§»é™¤å½“å‰èŠ‚ç‚¹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼šHashMapçº¢é»‘æ ‘å…·æœ‰åŒå‘é“¾è¡¨å’Œæ ‘çš„ä¸¤ç§ç‰¹æ€§ï¼Œéƒ½è¦è¿›è¡Œè°ƒæ•´</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeTreeNode</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">    TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index], root = first, rl;</span><br><span class="line">    <span class="comment">//succä¸ºå½“å‰èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ï¼Œ perdä¸ºå‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; succ = (TreeNode&lt;K,V&gt;)next, pred = prev;</span><br><span class="line">    <span class="comment">//å¦‚æœå‰é©±èŠ‚ç‚¹ä¸å­˜åœ¨(åˆ é™¤çš„æ˜¯rootèŠ‚ç‚¹)</span></span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        tab[index] = first = succ; <span class="comment">//firstç›´æ¥æŒ‡å‘rootåç½®èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = succ; <span class="comment">//å¦åˆ™å‰é©±èŠ‚ç‚¹ä¸åç½®èŠ‚ç‚¹ç›¸è¿å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> (succ != <span class="keyword">null</span>) <span class="comment">//å…³è”prevæŒ‡é’ˆ</span></span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    <span class="keyword">if</span> (first == <span class="keyword">null</span>)<span class="comment">//åˆ é™¤çš„èŠ‚ç‚¹ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (root.parent != <span class="keyword">null</span>) </span><br><span class="line">        root = root.root();<span class="comment">//é‡æ–°æ‰¾rootèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">//å¦‚æœrootä¸ºnullæˆ–è€…(å…è®¸ç§»åŠ¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”å·¦å­æ ‘æˆ–å³å­æ ‘ä¸ºnull)ï¼Œå°±è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || (movable &amp;&amp; (root.right == <span class="keyword">null</span></span><br><span class="line">                                     || (rl = root.left) == <span class="keyword">null</span></span><br><span class="line">                                     || rl.left == <span class="keyword">null</span>))) &#123;</span><br><span class="line">        tab[index] = first.untreeify(map);  <span class="comment">// too small</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆªè‡³åˆ°è¿™é‡Œï¼Œåªæ˜¯è°ƒæ•´äº†ä½œä¸ºåŒå‘é“¾è¡¨çš„é‚£ä¸€éƒ¨åˆ†æŒ‡é’ˆï¼Œä½œä¸ºæ ‘çš„ç›¸å…³å†…å®¹è¿˜æœªè¿›è¡Œè°ƒæ•´</span></span><br><span class="line">    <span class="comment">//è¿›è¡Œçº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œï¼Œçº¢é»‘æ ‘åˆ é™¤æ“ä½œåˆ†3ä¸­æƒ…å†µ</span></span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>, pl = left, pr = right, replacement;</span><br><span class="line">    <span class="comment">//æƒ…å†µ1ï¼šåˆ é™¤èŠ‚ç‚¹å·¦å³å­æ ‘ä¸ä¸ºnullï¼Œç”¨åç»§ç»“ç‚¹ï¼ˆå¤§äºåˆ é™¤ç»“ç‚¹çš„æœ€å°ç»“ç‚¹ï¼‰æ›¿æ¢åˆ é™¤ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (pl != <span class="keyword">null</span> &amp;&amp; pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; s = pr, sl; <span class="comment">//sæ˜¯å³å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//æ‰¾åˆ°åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹(å³å­æ ‘çš„æœ€å·¦è¾¹å¶å­èŠ‚ç‚¹)</span></span><br><span class="line">        <span class="keyword">while</span> ((sl = s.left) != <span class="keyword">null</span>) <span class="comment">// find successor</span></span><br><span class="line">            s = sl;<span class="comment">//så°±æ˜¯åç»§èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//äº¤æ¢så’Œpçš„é¢œè‰²</span></span><br><span class="line">        <span class="keyword">boolean</span> c = s.red; s.red = p.red; p.red = c; <span class="comment">// swap colors</span></span><br><span class="line">        TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">        TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        <span class="comment">//sæ˜¯å¾…åˆ é™¤èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹æŒ‚åˆ°sçš„å³å­èŠ‚ç‚¹ï¼ˆäº’æ¢ä½ç½®ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (s == pr) &#123; <span class="comment">// p was s's direct parentï¼ˆpçš„å³å­èŠ‚ç‚¹æ— å·¦å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">            p.parent = s;</span><br><span class="line">            s.right = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">            <span class="comment">//è¿˜æ˜¯äº’æ¢så’Œpçš„ä½ç½®ï¼Œè®¾ç½®éƒ¨åˆ†å…¶ä»–å±æ€§</span></span><br><span class="line">            <span class="comment">//å¦‚æœsæ˜¯å·¦å­èŠ‚ç‚¹å°±æŠŠpæ”¾åˆ°spçš„å·¦å­èŠ‚ç‚¹ä¸Šï¼Œåä¹‹äº¦ç„¶</span></span><br><span class="line">            <span class="keyword">if</span> ((p.parent = sp) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s == sp.left)</span><br><span class="line">                    sp.left = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    sp.right = p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//sçš„å³å­èŠ‚ç‚¹æŒ‡å‘pçš„å³å­èŠ‚ç‚¹ï¼Œpå³å­èŠ‚ç‚¹çˆ¶æŒ‡é’ˆæŒ‡å‘s</span></span><br><span class="line">            <span class="keyword">if</span> ((s.right = pr) != <span class="keyword">null</span>)</span><br><span class="line">                pr.parent = s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®è¡¥så’Œpäº¤æ¢åæ–­å¼€çš„èŠ‚ç‚¹(pl, pp, sr, root)</span></span><br><span class="line">        p.left = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//p.right = sr;</span></span><br><span class="line">        <span class="keyword">if</span> ((p.right = sr) != <span class="keyword">null</span>)</span><br><span class="line">            sr.parent = p;</span><br><span class="line">        <span class="comment">//s.left = pl; </span></span><br><span class="line">        <span class="keyword">if</span> ((s.left = pl) != <span class="keyword">null</span>)</span><br><span class="line">            pl.parent = s;</span><br><span class="line">        <span class="keyword">if</span> ((s.parent = pp) == <span class="keyword">null</span>)</span><br><span class="line">            root = s; <span class="comment">//sæ˜¯root</span></span><br><span class="line">        <span class="comment">// s.parent = pp;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = s;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = s;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç°åœ¨srå·²ç»æ”¾åˆ°p.right,p.leftå·²ç»æ˜¯nulläº†ï¼Œè¦åˆ é™¤pï¼Œè¿˜è¦å¤„ç†p.right</span></span><br><span class="line">        <span class="comment">//è¿™é‡Œç”¨replacementæ¥å¡«å……è¢«åˆ é™¤èŠ‚ç‚¹çš„ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">            replacement = sr;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            replacement = p;<span class="comment">//ä¸´æ—¶çš„ï¼Œpæ˜¯è¦åˆ é™¤çš„</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æƒ…å†µ2ï¼šåˆ é™¤èŠ‚ç‚¹åªæœ‰å·¦å­èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨å·¦å­èŠ‚ç‚¹æ›¿æ¢å¾…åˆ é™¤èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pl;</span><br><span class="line">    <span class="comment">//æƒ…å†µ3ï¼šåˆ é™¤èŠ‚ç‚¹åªæœ‰å·¦å­èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨å·¦å­èŠ‚ç‚¹æ›¿æ¢å¾…åˆ é™¤èŠ‚ç‚¹å³å¯</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pr;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        replacement = p;<span class="comment">//ä¸´æ—¶çš„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœç”¨äºæ›¿æ¢pä½ç½®çš„å†…å®¹æ˜¯æœ‰æ•ˆçš„(ä¸æ˜¯p)ï¼Œå°±ç”¨replacementä»£æ›¿pçš„ä½ç½®ï¼ˆçœŸæ­£çš„åˆ é™¤æ“ä½œï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (replacement != p) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (pp == <span class="keyword">null</span>)</span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = replacement;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = replacement;</span><br><span class="line">        p.left = p.right = p.parent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è€ƒè™‘æ›¿æ¢èŠ‚ç‚¹sçš„é¢œè‰²(å‰é¢å’Œpäº¤æ¢è¿‡äº†ï¼Œè¿™é‡Œç”¨påˆ¤æ–­)</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯çº¢è‰²ï¼Œåˆ™ä¸å½±å“æ ‘çš„å¹³è¡¡ï¼Œç›´æ¥ç»“æŸ</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯é»‘è‰²ï¼Œåˆ™éœ€è¦é‡æ–°å¹³è¡¡çº¢é»‘æ ‘ï¼ˆè¿™é‡Œæ˜¯æ•´ä¸ªçº¢é»‘æ ‘åˆ é™¤æœ€å¤æ‚çš„åœ°æ–¹ï¼‰</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œè¿”å›çš„rå°±æ˜¯æ–°é€‰å‡ºæ¥çš„rootèŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; r = p.red ? root : balanceDeletion(root, replacement);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœpæ— å­èŠ‚ç‚¹ï¼Œç›´æ¥ä¸ppè§£æŒ‚å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> (replacement == p) &#123;  <span class="comment">// detach</span></span><br><span class="line">        TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        p.parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                pp.left = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.right)</span><br><span class="line">                pp.right = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†rootæ”¾åˆ°é¦–èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (movable)</span><br><span class="line">        moveRootToFront(tab, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="11">
<li>çº¢é»‘æ ‘çš„åˆ†è£‚ï¼Œä»…ä»…ä¼šå‘ç”Ÿåœ¨tableæ‰©å®¹æ—¶ï¼Œçº¢é»‘æ ‘è¿›è¡Œrehashçš„è¿‡ç¨‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">split</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; b = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„loå°±æ˜¯ä½åœ°å€æœªï¼Œä¹Ÿå°±æ˜¯åŸä½ç½®ï¼Œhiè¡¨ç¤ºé«˜ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æ–°åœ°å€</span></span><br><span class="line">    <span class="comment">// ç”±äºåœ°å€çš„ç®—æ³•ç‰¹æ€§ï¼Œä¸€ä¸ªæ—§åœ°å€ä¸Šçš„èŠ‚ç‚¹åªå¯èƒ½å¯¹åº”ä¸€ä¸ªæ–°åœ°å€</span></span><br><span class="line">    TreeNode&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//éå†æ•´ä¸ªé“¾è¡¨ï¼ˆåˆ«å¿˜äº†çº¢é»‘æ ‘ä»ä¿ç•™äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§ï¼‰ï¼Œå°†ä¸€ä¸ªé“¾è¡¨æ‹†æˆä¸¤ä¸ªé“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; e = b, next; e != <span class="keyword">null</span>; e = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)e.next;</span><br><span class="line">        e.next = <span class="keyword">null</span>;<span class="comment">//ä¸ä¸‹æ¸¸è§£æŒ‚</span></span><br><span class="line">        <span class="comment">//éœ€è¦ç•™åœ¨åŸåœ°çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((e.hash &amp; bit) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                loHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                loTail.next = e;</span><br><span class="line">            loTail = e;</span><br><span class="line">            ++lc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//éœ€è¦è¿ç§»åˆ°æ–°åœ°å€çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                hiHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hiTail.next = e;</span><br><span class="line">            hiTail = e;</span><br><span class="line">            ++hc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœç•™åœ¨åŸåœ°çš„é“¾è¡¨ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (loHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœèŠ‚ç‚¹æ•°å°äºæ ‘å½¢åŒ–é˜ˆå€¼ï¼Œå°±è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index] = loHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index] = loHead;</span><br><span class="line">            <span class="comment">//å¦‚æœæœ‰æ‹†åˆ†å‡ºå»çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç•™ä¸‹æ¥çš„å°±éœ€è¦é‡æ–°æ ‘å½¢åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) <span class="comment">//hiä¸ä¸ºnullå°±è¡¨ç¤ºæœ‰æ‹†åˆ†å‡ºå»çš„èŠ‚ç‚¹</span></span><br><span class="line">                loHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ–°æ‹†åˆ†å‡ºæ¥çš„é“¾è¡¨ä¸ä¸ºç©ºï¼Œå¤„ç†æ–¹å¼ä¸loä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index + bit] = hiHead.untreeify(map);<span class="comment">//æ³¨æ„hiåœ°å€çš„è®¡ç®—æ–¹å¼</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index + bit] = hiHead;</span><br><span class="line">            <span class="keyword">if</span> (loHead != <span class="keyword">null</span>)</span><br><span class="line">                hiHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="12">
<li>çº¢é»‘æ ‘å·¦æ—‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateLeft</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">    <span class="comment">//pä¸ä¸ºç©ºï¼Œpçš„å³å­èŠ‚ç‚¹(r)ä¸ä¸ºç©ºï¼Œå·¦æ—‹æ‰æœ‰æ„ä¹‰</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (r = p.right) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//pçš„å³å­èŠ‚ç‚¹è¿æ¥rçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((rl = p.right = r.left) != <span class="keyword">null</span>)</span><br><span class="line">            rl.parent = p;</span><br><span class="line">        <span class="comment">//å¦‚æœpæ˜¯rootï¼Œåˆ™æ—‹è½¬åræ˜¯rootï¼Œé¢œè‰²ä¸ºé»‘è‰²</span></span><br><span class="line">        <span class="keyword">if</span> ((pp = r.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = r).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼ŒræŒ‚åˆ°pçš„parent(pp)ä¸‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.left == p)</span><br><span class="line">            pp.left = r;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = r;</span><br><span class="line">        <span class="comment">//pæˆä¸ºrçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="13">
<li>çº¢é»‘æ ‘å³æ—‹<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateRight</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">    <span class="comment">//lä¸ºpçš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (l = p.left) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//lçš„å³å­èŠ‚ç‚¹æŒ‚è½½åˆ°pçš„å·¦å­èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> ((lr = p.left = l.right) != <span class="keyword">null</span>)</span><br><span class="line">            lr.parent = p;</span><br><span class="line">        <span class="comment">//å¦‚æœpæ˜¯rootèŠ‚ç‚¹ï¼Œæ—‹è½¬ålæ˜¯rootèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((pp = l.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = l).red = <span class="keyword">false</span>;<span class="comment">//rootä¸ºé»‘è‰²</span></span><br><span class="line">        <span class="comment">//å¦åˆ™å°†læŒ‚è½½åˆ°ppä¸‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.right == p)</span><br><span class="line">            pp.right = l;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.left = l;</span><br><span class="line">        <span class="comment">//pæˆä¸ºlçš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="14">
<li>å¹³è¡¡æ’å…¥æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x)</span></span>&#123;</span><br><span class="line">     x.red = <span class="keyword">true</span>;<span class="comment">//æ–°æ’å…¥çš„èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">     <span class="comment">//ä¸€ç›´é‡å¤æ“ä½œï¼Œç›´åˆ°çº¢é»‘æ ‘å¹³è¡¡</span></span><br><span class="line">     <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">         <span class="comment">//å¦‚æœæ’å…¥çš„èŠ‚ç‚¹å°±æ˜¯root</span></span><br><span class="line">         <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">             x.red = <span class="keyword">false</span>;<span class="comment">//rootä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">return</span> x;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//å¦‚æœæ’å…¥çš„èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘èŠ‚ç‚¹ï¼Œæˆ–çˆ¶èŠ‚ç‚¹æ˜¯rootåˆ™æ— éœ€è°ƒæ•´ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">             <span class="keyword">return</span> root;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//å¦‚æœçˆ¶èŠ‚ç‚¹(xp)æ˜¯çº¢èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹(xpp)çš„å·¦å­èŠ‚ç‚¹(xppl)</span></span><br><span class="line">         <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">             <span class="comment">//å¦‚æœå”å”èŠ‚ç‚¹(çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹xppr)å­˜åœ¨ä¸”ä¸ºçº¢è‰²</span></span><br><span class="line">             <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                 xppr.red = <span class="keyword">false</span> <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                     xp.red = <span class="keyword">false</span>;  <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xpp.red = <span class="keyword">true</span>;  <span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                 x = xpp; <span class="comment">//å°†ç¥–çˆ¶èŠ‚ç‚¹è®¾ä¸ºæ’å…¥èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œæ’å…¥å¹³è¡¡æ“ä½œ</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">                 <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                     <span class="comment">//å¯¹æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                     root = rotateLeft(root, x = xp);</span><br><span class="line">                     xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å·¦å­èŠ‚ç‚¹å°±æ— éœ€æ—‹è½¬</span></span><br><span class="line">                 <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     xp.red = <span class="keyword">false</span>;<span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                     <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         xpp.red = <span class="keyword">true</span>;<span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                         <span class="comment">//å¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹</span></span><br><span class="line">                         root = rotateRight(root, xpp);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//å¦‚æœçˆ¶èŠ‚ç‚¹(xp)æ˜¯çº¢èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹(xpp)çš„å³å­èŠ‚ç‚¹(xppr)</span></span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹å­˜åœ¨ä¸”ä¸ºçº¢è‰²</span></span><br><span class="line">             <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                 xppl.red = <span class="keyword">false</span>; <span class="comment">//å”å”èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xp.red = <span class="keyword">false</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                 xpp.red = <span class="keyword">true</span>;   <span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                 x = xpp; <span class="comment">//å°†ç¥–çˆ¶èŠ‚ç‚¹è®¾ä¸ºæ’å…¥èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œæ’å…¥å¹³è¡¡æ“ä½œ</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//å”å”èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘è‰²</span></span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//æ’å…¥èŠ‚ç‚¹æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                 <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                     <span class="comment">//å°†çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹,ç„¶åè¿›è¡Œä¸‹é¢æ“ä½œ</span></span><br><span class="line">                     root = rotateRight(root, x = xp);</span><br><span class="line">                     xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">                     xp.red = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         xpp.red = <span class="keyword">true</span>;<span class="comment">//ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                         <span class="comment">//å¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                         root = rotateLeft(root, xpp);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="15">
<li>å¹³è¡¡åˆ é™¤æ“ä½œ<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceDeletion</span><span class="params">(TreeNode&lt;K,V&gt; root,TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä¸€ç›´å¹³è¡¡ï¼Œç›´åˆ°å¹³è¡¡ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; xp, xpl, xpr;;) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ›¿æ¢èŠ‚ç‚¹å°±æ˜¯rootæˆ–è€…nullï¼Œç›´æ¥è¿”å›root</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span> || x == root)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæ—¥æ¢èŠ‚ç‚¹æ˜¯rootèŠ‚ç‚¹ï¼Œé¢œè‰²è®¾ç½®ä¸ºé»‘è‰²ï¼Œè¿”å›æ›¿æ¢èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ›¿æ¢èŠ‚ç‚¹æ˜¯çº¢è‰²</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>; <span class="comment">//é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²</span></span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ›¿æ¢èŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹ï¼Œä¸”æ›¿æ¢èŠ‚ç‚¹ä½¿å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xpl = xp.left) == x) &#123;</span><br><span class="line">            <span class="comment">//æ›¿æ¢èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹(xpr)æ˜¯çº¢èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((xpr = xp.right) != <span class="keyword">null</span> &amp;&amp; xpr.red) &#123;</span><br><span class="line">                xpr.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼Ÿè®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">true</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                root = rotateLeft(root, xp); <span class="comment">//å°†PèŠ‚ç‚¹å·¦æ—‹</span></span><br><span class="line">                xpr = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœå…„å¼ŸèŠ‚ç‚¹ä¸ºnullï¼Œå°†çˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (xpr == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å­˜åœ¨ï¼Œä¸”ä¸ºé»‘è‰²</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½ä¸ºé»‘èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((sr == <span class="keyword">null</span> || !sr.red) &amp;&amp;</span><br><span class="line">                    (sl == <span class="keyword">null</span> || !sl.red)) &#123;</span><br><span class="line">                    xpr.red = <span class="keyword">true</span>; <span class="comment">// å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                    x = xp; <span class="comment">//å°†çˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼ˆå·¦å­èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (sr == <span class="keyword">null</span> || !sr.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sl != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        xpr.red = <span class="keyword">true</span>;     <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                        root = rotateRight(root, xpr); <span class="comment">//å¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œå³æ—‹</span></span><br><span class="line">                        xpr = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                            <span class="keyword">null</span> : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå·¦å­èŠ‚ç‚¹ä»»æ„</span></span><br><span class="line">                    <span class="keyword">if</span> (xpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„é¢œè‰²è®¾ä¸ºçˆ¶äº²èŠ‚ç‚¹çš„é¢œè‰²</span></span><br><span class="line">                        xpr.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = xpr.right) != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;<span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>; <span class="comment">//çˆ¶äº²èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        root = rotateLeft(root, xp);<span class="comment">//å¯¹çˆ¶äº²èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;<span class="comment">//ç»“æŸå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ›¿æ¢èŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹ï¼Œä¸”æ›¿æ¢èŠ‚ç‚¹ä½¿å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆæ“ä½œä¸ä¸Šä¸€ä¸ªIFæ˜¯å¯¹ç§°çš„ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å­˜åœ¨ä¸”æ˜¯çº¢è‰²</span></span><br><span class="line">            <span class="keyword">if</span> (xpl != <span class="keyword">null</span> &amp;&amp; xpl.red) &#123;</span><br><span class="line">                xpl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                xp.red = <span class="keyword">true</span>;   <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span></span><br><span class="line">                root = rotateRight(root, xp); <span class="comment">//æŒ‰çˆ¶èŠ‚ç‚¹å³æ—‹</span></span><br><span class="line">                xpl = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹ä¸ºç©ºï¼Œå°±æŠŠçˆ¶èŠ‚ç‚¹å½“ä½œæ›¿æ¢èŠ‚ç‚¹é‡æ–°å¹³è¡¡</span></span><br><span class="line">            <span class="keyword">if</span> (xpl == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="comment">//å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹å…¨æ˜¯é»‘è‰²</span></span><br><span class="line">                <span class="keyword">if</span> ((sl == <span class="keyword">null</span> || !sl.red) &amp;&amp;</span><br><span class="line">                    (sr == <span class="keyword">null</span> || !sr.red)) &#123;</span><br><span class="line">                    xpl.red = <span class="keyword">true</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                    x = xp; <span class="comment">//çˆ¶èŠ‚ç‚¹ä¸ºæ›¿æ¢èŠ‚ç‚¹é‡æ–°è¿›è¡Œå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å·¦å­èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼ˆå³å­èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (sl == <span class="keyword">null</span> || !sl.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å³å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        xpl.red = <span class="keyword">true</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">                        root = rotateLeft(root, xpl);<span class="comment">//å¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                        xpl = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                            <span class="keyword">null</span> : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œå³å­èŠ‚ç‚¹ä»»æ„</span></span><br><span class="line">                    <span class="keyword">if</span> (xpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å°†å…„å¼ŸèŠ‚ç‚¹é¢œè‰²è®¾ä¸ºçˆ¶èŠ‚ç‚¹é¢œè‰²</span></span><br><span class="line">                        xpl.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sl = xpl.left) != <span class="keyword">null</span>)z</span><br><span class="line">                            sl.red = <span class="keyword">false</span>; <span class="comment">//å…„å¼ŸèŠ‚ç‚¹å·¦å­èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>; <span class="comment">//çˆ¶èŠ‚ç‚¹è®¾ä¸ºé»‘è‰²</span></span><br><span class="line">                        root = rotateRight(root, xp); <span class="comment">//å¯¹çˆ¶èŠ‚ç‚¹å³æ—‹</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root; <span class="comment">//ç»“æŸå¹³è¡¡æ“ä½œ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="16">
<li>çº¢é»‘æ ‘è‡ªæ£€<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">checkInvariants</span><span class="params">(TreeNode&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right,</span><br><span class="line">    tb = t.prev, tn = (TreeNode&lt;K,V&gt;)t.next;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å‰é©±èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹ä¸æ˜¯tï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tb != <span class="keyword">null</span> &amp;&amp; tb.next != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„åç½®èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯tï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tn != <span class="keyword">null</span> &amp;&amp; tn.prev != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtä¸æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä¹Ÿä¸æ˜¯å³å­èŠ‚ç‚¹ï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tp != <span class="keyword">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å·¦å­èŠ‚ç‚¹çš„çˆ¶äº²ä¸æ˜¯tï¼Œæˆ–å·¦å­èŠ‚ç‚¹hashå¤§äºtçš„hashï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtçš„å³å­èŠ‚ç‚¹çš„çˆ¶äº²ä¸æ˜¯tï¼Œæˆ–å³å­èŠ‚ç‚¹hashå°äºtçš„hashï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœtæ˜¯çº¢è‰²ä½†å­èŠ‚ç‚¹è¿˜æ˜¯çº¢è‰²ï¼Œæ£€æŸ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="keyword">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="keyword">null</span> &amp;&amp; tr.red)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//é€’å½’æ£€æŸ¥å·¦å­æ ‘</span></span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tl))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//é€’å½’æ£€æŸ¥å³å­æ ‘</span></span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tr))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<h1 id="å››ã€å…¶ä»–æ–¹æ³•"><a href="#å››ã€å…¶ä»–æ–¹æ³•" class="headerlink" title="å››ã€å…¶ä»–æ–¹æ³•"></a>å››ã€å…¶ä»–æ–¹æ³•</h1><ol>
<li>Cloneæ–¹æ³•é‡å†™<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æµ…æ‹·è´</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HashMap&lt;K,V&gt; result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = (HashMap&lt;K,V&gt;)<span class="keyword">super</span>.clone();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="comment">// this shouldn't happen, since we are Cloneable</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e);</span><br><span class="line">    &#125;</span><br><span class="line">    result.reinitialize();</span><br><span class="line">    result.putMapEntries(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="2">
<li>åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç›¸å…³æ–¹æ³•<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These methods are also used when serializing HashSets</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">float</span> <span class="title">loadFactor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> loadFactor; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (table != <span class="keyword">null</span>) ? table.length :</span><br><span class="line">    (threshold &gt; <span class="number">0</span>) ? threshold :</span><br><span class="line">    DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buckets = capacity();</span><br><span class="line">    <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line">    s.writeInt(buckets);</span><br><span class="line">    s.writeInt(size);</span><br><span class="line">    internalWriteEntries(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal mappings count: "</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it's the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we're actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called only from writeObject, to ensure compatible ordering.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">internalWriteEntries</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                s.writeObject(e.key);</span><br><span class="line">                s.writeObject(e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reset to initial default state.  Called by clone and readObject.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reinitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    table = <span class="keyword">null</span>;</span><br><span class="line">    entrySet = <span class="keyword">null</span>;</span><br><span class="line">    keySet = <span class="keyword">null</span>;</span><br><span class="line">    values = <span class="keyword">null</span>;</span><br><span class="line">    modCount = <span class="number">0</span>;</span><br><span class="line">    threshold = <span class="number">0</span>;</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>
<ol start="3">
<li>å›è°ƒæ–¹æ³•ï¼Œåœ¨HashMapä¸­æ— ä½œç”¨ï¼Œä¸ºLinkedHashMapåšé“ºå«<br><details><summary style="color:blue">ç‚¹å‡»å±•å¼€ä»£ç </summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Callbacks to allow LinkedHashMap post-actions</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
</details></li>
</ol>
<p></p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://blog.zjee.ml">jackcharles</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://blog.zjee.ml/2019/12/29/hashmap-source-learning/">http://blog.zjee.ml/2019/12/29/hashmap-source-learning/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Javaæºç /">Javaæºç </a>
            <a href="/tags/HashMap/">HashMap</a>
            </div>
        
        <nav class="post-nav"><a class="next" href="/2019/11/19/java-primitive-and-wrapper-type/">
        <span class="next-text nav-default">JavaåŸºæœ¬ç±»å‹ä¸åŒ…è£…ç±»å‹</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments">
	<p style="color:#0047AB">
	è¿™é‡Œæ˜¯è¯„è®ºåŒºï¼Œä½¿ç”¨
	<a href="http://livere.com/" target="_blank">æ¥å¿…åŠ›(LiveRe)</a>
	æ’ä»¶å®ç°ï¼Œé‚®ç®±ã€æ˜µç§°ã€å¯†ç å¯éšæ„å¡«å†™ï¼Œä½†è¦ä¿®æ”¹ã€åˆ é™¤è¯„è®ºå°±å¿…é¡»ç™»å½•LiveReï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•LiveReã€‚
	</p><div id="lv-container" data-id="city" data-uid="MTAyMC80MTIyNy8xNzc3NQ==">
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
      </div>  
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:zjee@live.cn" class="iconfont icon-email" title="email"></a>
        <a href="/pass" class="iconfont icon-facebook" title="facebook"></a>
        <a href="/pass" class="iconfont icon-weibo" title="weibo"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2018 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">jackcharles</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
	(function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
